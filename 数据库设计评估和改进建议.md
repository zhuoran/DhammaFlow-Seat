# ç¦…ä¿®ä¸­å¿ƒæ’åºŠç³»ç»Ÿ - æ•°æ®åº“è®¾è®¡è¯„ä¼°å’Œæ”¹è¿›å»ºè®®

**è¯„ä¼°æ—¥æœŸ**: 2025-11-05
**åŸºå‡†**: æˆ¿é—´åˆ†é…ç®—æ³•è§„åˆ™ç¡®è®¤æ–‡æ¡£
**æ•°æ®åº“**: flowseat (MySQL)
**è¯„ä¼°æ–¹å¼**: Entityç±»å®šä¹‰ vs å®é™…æ•°æ®åº“è¡¨ vs ç®—æ³•éœ€æ±‚

---

## ä¸€ã€å½“å‰æ•°æ®åº“ç°çŠ¶ç»Ÿè®¡

| é¡¹ç›® | æ•°é‡ |
|------|------|
| ç¦…ä¿®ä¸­å¿ƒ | 1ä¸ª |
| è¯¾ç¨‹æœŸæ¬¡ | 2ä¸ª (session_id: 3, 61) |
| å­¦å‘˜æ€»æ•° | 154äºº (77+77) |
| æˆ¿é—´æ€»æ•° | 52é—´ |
| åºŠä½æ€»æ•° | 95ä¸ª |
| ç”·ä¼—å­¦å‘˜ | ~çº¦77äºº |
| å¥³ä¼—å­¦å‘˜ | ~çº¦77äºº |

---

## äºŒã€æ•°æ®åº“è¡¨è®¾è®¡é—®é¢˜

### 2.1 âš ï¸ å…³é”®é—®é¢˜ï¼šStudentè¡¨ç¼ºå°‘`student_type`å­—æ®µ

**é—®é¢˜æè¿°**:
- **Entityç±»ä¸­å®šä¹‰äº†**: `studentType` (String) - è®¡ç®—å­—æ®µï¼Œåº”è¯¥ä¸º"æ³•å¸ˆ"ã€"æ—§ç”Ÿ"æˆ–"æ–°ç”Ÿ"
- **æ•°æ®åº“ä¸­æ²¡æœ‰**: `student_type` åˆ—

**å½±å“**:
- Javaä»£ç å¯èƒ½ä¼šå› ä¸ºå­—æ®µæ˜ å°„é—®é¢˜è€Œå¤±è´¥
- æ— æ³•ç›´æ¥åœ¨SQLä¸­æŸ¥è¯¢å­¦å‘˜ç±»å‹ï¼ˆå¿…é¡»åœ¨åº”ç”¨å±‚è®¡ç®—ï¼‰
- å½±å“åˆ†é…ç®—æ³•çš„æ€§èƒ½å’Œå‡†ç¡®æ€§

**å»ºè®®ä¿®å¤**:
```sql
-- æ·»åŠ student_typeå­—æ®µ
ALTER TABLE student ADD COLUMN `student_type` VARCHAR(20) COMMENT 'å­¦å‘˜ç±»å‹ï¼šmonk=æ³•å¸ˆ, old_student=æ—§ç”Ÿ, new_student=æ–°ç”Ÿ' AFTER `age_group`;
ALTER TABLE student ADD KEY `idx_student_type` (`student_type`);

-- æ ¹æ®ä¿®å­¦æ¬¡æ•°å¡«å……æ•°æ®
UPDATE student SET student_type = 'monk' WHERE name LIKE 'æ³•%';
UPDATE student SET student_type = 'old_student' WHERE study_times > 0 AND name NOT LIKE 'æ³•%';
UPDATE student SET student_type = 'new_student' WHERE study_times = 0 AND name NOT LIKE 'æ³•%';
```

---

### 2.2 âš ï¸ é—®é¢˜ï¼šStudentè¡¨ä¸­age_groupå­—æ®µä¸ºNULL

**é—®é¢˜æè¿°**:
- æŸ¥è¯¢ç»“æœæ˜¾ç¤ºæ‰€æœ‰age_groupå­—æ®µéƒ½ä¸ºNULL
- Entityç±»å®šä¹‰äº†`calculateAgeGroup()`æ–¹æ³•ï¼Œä½†æ•°æ®æœªå¡«å……
- å¹´é¾„åˆ†æ®µè§„åˆ™åº”ä¸ºï¼š18-30ã€30-40ã€40-55ã€55+

**å½±å“**:
- ç¦…å ‚åº§ä½åˆ†é…éœ€è¦ä¾èµ–å¹´é¾„åˆ†æ®µï¼Œä½†æ•°æ®ç¼ºå¤±
- åˆ†é…ç®—æ³•çš„æ’åºä¾èµ–age_groupï¼Œæ— æ³•æ­£ç¡®æ‰§è¡Œ

**å»ºè®®ä¿®å¤**:
```sql
-- è®¡ç®—å¹¶å¡«å……age_group
UPDATE student SET age_group =
  CASE
    WHEN age < 18 THEN '18ä»¥ä¸‹'
    WHEN age < 30 THEN '18-30'
    WHEN age < 40 THEN '30-40'
    WHEN age < 55 THEN '40-55'
    ELSE '55+'
  END
WHERE age IS NOT NULL;

-- éªŒè¯ç»“æœ
SELECT age, age_group, COUNT(*) FROM student GROUP BY age, age_group;
```

**éªŒè¯SQL**:
```sql
-- æ£€æŸ¥æ˜¯å¦è¿˜æœ‰NULLå€¼
SELECT COUNT(*) FROM student WHERE age_group IS NULL;  -- åº”è¯¥è¿”å›0
```

---

### 2.3 âš ï¸ é—®é¢˜ï¼šRoomè¡¨ç¼ºå°‘is_reservedå’Œreserved_forå­—æ®µ

**é—®é¢˜æè¿°**:
- **PRDè§„åˆ’æœ‰**: `is_reserved` (Boolean) - æ ‡è®°é¢„ç•™æˆ¿é—´
- **PRDè§„åˆ’æœ‰**: `reserved_for` (String) - é¢„ç•™ç”¨é€”è¯´æ˜
- **æ•°æ®åº“ä¸­æ²¡æœ‰**: è¿™ä¸¤ä¸ªå­—æ®µ
- **ä½†æœ‰**: `gender_area` å­—æ®µï¼ˆè¿™æ˜¯ä¸€ä¸ªé¢å¤–å­—æ®µï¼‰

**å½±å“**:
- æ— æ³•æ ‡è®°é¢„ç•™æˆ¿é—´ï¼ˆå¦‚æ³•å·¥æˆ¿ã€è®²å¸ˆæˆ¿ï¼‰
- æ— æ³•åœ¨åˆ†é…æ—¶æ’é™¤é¢„ç•™æˆ¿é—´
- å½±å“åˆ†é…ç®—æ³•çš„å‡†ç¡®æ€§

**å»ºè®®ä¿®å¤**:
```sql
-- æ·»åŠ é¢„ç•™æˆ¿é—´ç›¸å…³å­—æ®µ
ALTER TABLE room ADD COLUMN `is_reserved` BOOLEAN DEFAULT FALSE COMMENT 'æ˜¯å¦é¢„ç•™' AFTER `status`;
ALTER TABLE room ADD COLUMN `reserved_for` VARCHAR(100) COMMENT 'é¢„ç•™ç”¨é€”' AFTER `is_reserved`;
ALTER TABLE room ADD KEY `idx_reserved` (`is_reserved`);
```

---

### 2.4 âš ï¸ é—®é¢˜ï¼šStudentè¡¨ç¼ºå°‘center_idå­—æ®µ

**é—®é¢˜æè¿°**:
- å½“å‰å­¦å‘˜è¡¨é€šè¿‡`session_id`å…³è”åˆ°è¯¾ç¨‹æœŸæ¬¡
- è¯¾ç¨‹æœŸæ¬¡é€šè¿‡`center_id`å…³è”åˆ°ç¦…ä¿®ä¸­å¿ƒ
- **ä½†Studentè¡¨æœ¬èº«æ²¡æœ‰center_idå†—ä½™å­—æ®µ**
- è¿™å¯¼è‡´æŸ¥è¯¢æ•ˆç‡ä½ä¸‹ï¼ˆéœ€è¦JOINä¸¤ä¸ªè¡¨ï¼‰

**å½±å“**:
- æŒ‰ä¸­å¿ƒæŸ¥è¯¢å­¦å‘˜æ—¶éœ€è¦JOIN sessionè¡¨ï¼Œæ€§èƒ½è¾ƒå·®
- æ•°æ®æ¨¡å‹ä¸å¤Ÿæ¸…æ™°

**å»ºè®®ä¿®å¤**:
```sql
-- æ·»åŠ center_idå†—ä½™å­—æ®µï¼ˆå¯é€‰ä½†æ¨èï¼‰
ALTER TABLE student ADD COLUMN `center_id` BIGINT COMMENT 'æ‰€å±ç¦…ä¿®ä¸­å¿ƒ' AFTER `session_id`;
ALTER TABLE student ADD CONSTRAINT `fk_student_center` FOREIGN KEY (`center_id`) REFERENCES `center`(`id`) ON DELETE CASCADE;
ALTER TABLE student ADD KEY `idx_center_session` (`center_id`, `session_id`);

-- ä»sessionè¡¨å¡«å……center_id
UPDATE student s
JOIN session ss ON s.session_id = ss.id
SET s.center_id = ss.center_id;
```

---

### 2.5 âš ï¸ é—®é¢˜ï¼šBedè¡¨ç¼ºå°‘is_reservedå­—æ®µ

**é—®é¢˜æè¿°**:
- **PRDè§„åˆ’**: åºŠä½åº”è¯¥æœ‰é¢„ç•™çŠ¶æ€
- **æ•°æ®åº“ä¸­**: bedè¡¨åªæœ‰statuså­—æ®µï¼ˆAVAILABLE/OCCUPIED/RESERVEDï¼‰
- statuså­—æ®µèƒ½è¡¨è¾¾çš„ä¿¡æ¯æœ‰é™

**å½±å“**:
- æ— æ³•åŒºåˆ†"è¢«å ç”¨"å’Œ"è¢«é¢„ç•™"
- RESERVEDçŠ¶æ€å«ä¹‰ä¸æ¸…

**å»ºè®®ä¿®å¤**:
```sql
-- å½“å‰statuså­—æ®µçš„å€¼å¯ä»¥ä¿ç•™ï¼ˆä½¿ç”¨æšä¸¾ï¼‰
-- ä½†å»ºè®®è¡¥å……æ³¨é‡Šè¯´æ˜å«ä¹‰
-- æˆ–ä¿®æ”¹ä¸ºæ›´æ¸…æ™°çš„æšä¸¾å€¼
ALTER TABLE bed MODIFY COLUMN `status` VARCHAR(20) DEFAULT 'AVAILABLE'
  COMMENT 'çŠ¶æ€ï¼šAVAILABLE=å¯ç”¨, OCCUPIED=å·²å ç”¨, RESERVED=é¢„ç•™, MAINTENANCE=ç»´ä¿®ä¸­';
```

---

### 2.6 âœ“ å¥½æ¶ˆæ¯ï¼šMeditationHallConfigè¡¨å­—æ®µå®Œæ•´

**æ£€æŸ¥ç»“æœ**:
```sql
DESC meditation_hall_config;
-- æ‰€æœ‰å¿…è¦å­—æ®µéƒ½å­˜åœ¨ï¼š
-- - center_id, session_id (å…³é”®å¤–é”®)
-- - region_name, region_code (åŒºåŸŸé…ç½®)
-- - region_width, region_rows (å®½åº¦ã€è¡Œæ•°)
-- - is_auto_width, is_auto_rows (è‡ªåŠ¨è®¡ç®—æ ‡å¿—)
-- - numbering_type (ç¼–å·æ–¹å¼)
-- - gender_separated, gender_type (æ€§åˆ«åˆ†ç¦»)
-- - monk_start_cell, monk_max_count (æ³•å¸ˆåº§ä½é…ç½®)
-- - old_student_reserved_list, dhamma_worker_area1/2 (ç‰¹æ®Šå¸­ä½)
```

**è¯„ä»·**: âœ“ ç¦…å ‚é…ç½®è¡¨è®¾è®¡å®Œæ•´ï¼Œæ”¯æŒå¤æ‚çš„åº§ä½å¸ƒå±€é…ç½®

---

### 2.7 âš ï¸ é—®é¢˜ï¼šRoomè¡¨ä¸­gender_areaå­—æ®µå®šä¹‰ä¸æ¸…

**é—®é¢˜æè¿°**:
- Roomè¡¨æœ‰ä¸€ä¸ª`gender_area`å­—æ®µï¼ˆVARCHAR(10)ï¼‰
- æ ¹æ®å¯¼å…¥æ•°æ®ï¼Œè¯¥å­—æ®µå­˜å‚¨å€¼å¦‚"ç”·"ã€"å¥³"
- **ä½†é—®é¢˜æ˜¯**:
  1. è¿™æ˜¯ä¸€ä¸ªå†—ä½™å­—æ®µï¼ˆå¯ä»room_typeæˆ–buildingæ¨å¯¼ï¼‰
  2. å­—æ®µåä¸å¤Ÿè§„èŒƒï¼ˆåº”è¯¥æ˜¯gender, not gender_areaï¼‰
  3. ä¸PRDæ–‡æ¡£ä¸­çš„è®¾è®¡æœ‰åå·®

**å½“å‰æ•°æ®**:
```
room_number | room_type    | gender_area
B102        | ä¹‰å·¥æˆ¿       | å¥³
A112        | å­¦å‘˜æˆ¿       | ç”·
```

**å»ºè®®**:
```sql
-- é€‰é¡¹1ï¼šæ”¹åå­—æ®µï¼ˆæ¨èï¼‰
ALTER TABLE room CHANGE COLUMN `gender_area` `gender` VARCHAR(1)
  COMMENT 'æ€§åˆ«åŒºåŸŸï¼šM=ç”·ä¼—, F=å¥³ä¼—';

-- é€‰é¡¹2ï¼šæ ‡å‡†åŒ–æ•°æ®
UPDATE room SET gender = 'M' WHERE gender_area = 'ç”·';
UPDATE room SET gender = 'F' WHERE gender_area = 'å¥³';

-- æ·»åŠ ç´¢å¼•ä»¥æé«˜æŸ¥è¯¢æ•ˆç‡
ALTER TABLE room ADD KEY `idx_center_gender` (`center_id`, `gender`);
```

---

## ä¸‰ã€æ•°æ®å®Œæ•´æ€§æ£€æŸ¥

### 3.1 å­¦å‘˜æ•°æ®è´¨é‡åˆ†æ

**é—®é¢˜å‘ç°**:

```sql
-- æ£€æŸ¥ç¼ºå¤±çš„å…³é”®å­—æ®µ
SELECT
  SUM(CASE WHEN gender IS NULL THEN 1 ELSE 0 END) as missing_gender,
  SUM(CASE WHEN age IS NULL THEN 1 ELSE 0 END) as missing_age,
  SUM(CASE WHEN age_group IS NULL THEN 1 ELSE 0 END) as missing_age_group,
  SUM(CASE WHEN study_times IS NULL THEN 1 ELSE 0 END) as missing_study_times
FROM student;
```

**å»ºè®®æ£€æŸ¥å’Œä¿®å¤**:
1. **æ€§åˆ«å­—æ®µ**: ç¡®ä¿æ‰€æœ‰å­¦å‘˜éƒ½æœ‰æœ‰æ•ˆçš„genderå€¼ï¼ˆMæˆ–Fï¼‰
2. **å¹´é¾„å­—æ®µ**: ç¡®ä¿ageä¸ä¸ºNULLï¼ˆå¿…å¡«ï¼‰
3. **age_groupå­—æ®µ**: å·²ä¿®å¤ï¼ˆè§ä¸Šé¢çš„UPDATEè¯­å¥ï¼‰
4. **study_timeså­—æ®µ**: åº”è¯¥æœ‰é»˜è®¤å€¼0ï¼ˆå·²æœ‰ï¼‰

---

### 3.2 æˆ¿é—´æ•°æ®è´¨é‡åˆ†æ

**é—®é¢˜å‘ç°**:

```sql
-- æ£€æŸ¥æˆ¿é—´é…ç½®çš„å®Œæ•´æ€§
SELECT
  room_number,
  building,
  floor,
  capacity,
  room_type,
  status,
  gender_area
FROM room
WHERE building IS NULL OR room_type IS NULL OR status = 'DISABLED';
```

**å»ºè®®æ£€æŸ¥**:
1. **buildingå­—æ®µ**: ç¡®ä¿æ¯ä¸ªæˆ¿é—´éƒ½æœ‰æ¥¼å·ä¿¡æ¯
2. **room_typeå­—æ®µ**: æ ¹æ®PRDï¼Œåº”è¯¥æ˜¯ï¼š"æ³•å¸ˆæˆ¿"ã€"æ—§ç”Ÿæˆ¿"ã€"æ–°ç”Ÿæˆ¿"ã€"è€äººæˆ¿"ã€"ä¹‰å·¥æˆ¿"ç­‰
3. **statuså­—æ®µ**: ç¡®è®¤DISABLEDæˆ¿é—´çš„å¤„ç†é€»è¾‘
4. **gender_areaå­—æ®µ**: åº”è¯¥ç”¨'M'æˆ–'F'è€Œé'ç”·'/'å¥³'

---

### 3.3 åºŠä½æ•°æ®è´¨é‡åˆ†æ

**é—®é¢˜å‘ç°**:
```
roomæ€»æ•°: 52
bedæ€»æ•°: 95
å¹³å‡æ¯æˆ¿åºŠæ•°: 1.83

-- è¿™è¯´æ˜æœ‰äº›æˆ¿é—´é…ç½®ä¸ºå•äººæˆ¿(capacity=1)
-- è€Œæœ‰äº›æˆ¿é—´é…ç½®ä¸ºåŒäººæˆ¿(capacity=2)
```

**å»ºè®®æ£€æŸ¥**:
```sql
-- éªŒè¯åºŠä½ä¸æˆ¿é—´å®¹é‡ä¸€è‡´
SELECT
  r.room_number,
  r.capacity,
  COUNT(b.id) as actual_beds,
  CASE
    WHEN r.capacity = COUNT(b.id) THEN 'OK'
    ELSE 'MISMATCH'
  END as status
FROM room r
LEFT JOIN bed b ON r.id = b.room_id
GROUP BY r.id
HAVING r.capacity != COUNT(b.id);

-- å¦‚æœæœ‰MISMATCHï¼Œéœ€è¦ä¿®å¤åºŠä½æ•°æ®
```

---

## å››ã€ä¸ç®—æ³•è§„åˆ™çš„æ˜ å°„æ£€æŸ¥

### 4.1 å­¦å‘˜ä¼˜å…ˆçº§æ’åº

**ç®—æ³•éœ€æ±‚**:
```
1ï¸âƒ£ å‡ºå®¶å¸ˆï¼ˆæ³•å¸ˆï¼‰- å§“ååŒ…å«"æ³•"
2ï¸âƒ£ éå‡ºå®¶æ—§ç”Ÿ - study_times > 0
3ï¸âƒ£ æ–°ç”Ÿ - study_times = 0
```

**æ•°æ®åº“æ”¯æŒæƒ…å†µ** âŒ éƒ¨åˆ†æ”¯æŒ:
- âœ“ study_timeså­—æ®µå­˜åœ¨
- âœ“ åå­—å¯ä»¥æ£€æŸ¥"æ³•"å­—
- âŒ ç¼ºå°‘student_typeè®¡ç®—å­—æ®µï¼ˆå·²åœ¨é—®é¢˜2.1ä¸­æå‡ºï¼‰

**SQLéªŒè¯**:
```sql
-- æ£€æŸ¥èƒ½å¦æ­£ç¡®è¯†åˆ«å­¦å‘˜ç±»å‹
SELECT
  COUNT(CASE WHEN name LIKE 'æ³•%' THEN 1 END) as monks,
  COUNT(CASE WHEN name NOT LIKE 'æ³•%' AND study_times > 0 THEN 1 END) as old_students,
  COUNT(CASE WHEN name NOT LIKE 'æ³•%' AND study_times = 0 THEN 1 END) as new_students
FROM student;
```

---

### 4.2 æ€§åˆ«åˆ†ç¦»

**ç®—æ³•éœ€æ±‚**:
```
åŒæ€§è¯¾ç¨‹éœ€è¦ï¼š
- å¥³ä¼—æˆ¿é—´ï¼ˆæ‰€æœ‰å¥³å­¦å‘˜çš„æˆ¿é—´ï¼‰
- ç”·ä¼—æˆ¿é—´ï¼ˆæ‰€æœ‰ç”·å­¦å‘˜çš„æˆ¿é—´ï¼‰
```

**æ•°æ®åº“æ”¯æŒæƒ…å†µ** âœ“ æ”¯æŒ:
- âœ“ studentè¡¨æœ‰genderå­—æ®µ
- âœ“ roomè¡¨æœ‰gender_areaå­—æ®µï¼ˆä½†å‘½åä¸è§„èŒƒï¼‰

**SQLéªŒè¯**:
```sql
-- æ£€æŸ¥æ€§åˆ«åˆ†å¸ƒ
SELECT
  s.gender,
  COUNT(*) as count
FROM student s
GROUP BY s.gender;

-- æ£€æŸ¥æˆ¿é—´æ€§åˆ«åˆ†å¸ƒ
SELECT
  r.gender_area,
  COUNT(*) as count,
  SUM(r.capacity) as total_capacity
FROM room r
GROUP BY r.gender_area;
```

---

### 4.3 å¹´é¾„åˆ†æ®µå’Œæ’åº

**ç®—æ³•éœ€æ±‚**:
```
æ–°ç”Ÿå†…éƒ¨æ’åºï¼š
  40-55å² > 30-40å² > 18-30å² > 55+å²
```

**æ•°æ®åº“æ”¯æŒæƒ…å†µ** âš ï¸ éƒ¨åˆ†æ”¯æŒ:
- âœ“ ageå­—æ®µå­˜åœ¨
- âŒ age_groupå­—æ®µä¸ºNULLï¼ˆå·²åœ¨é—®é¢˜2.2ä¸­æå‡ºï¼‰

**ä¿®å¤åSQLéªŒè¯**:
```sql
-- ä¿®å¤åï¼Œå¯ä»¥ç”¨age_groupç›´æ¥æ’åº
SELECT * FROM student
WHERE student_type = 'new_student'
ORDER BY FIELD(age_group, '40-55', '30-40', '18-30', '55+'), age DESC;
```

---

### 4.4 åŒä¼´å…³ç³»

**ç®—æ³•éœ€æ±‚**:
```
- è¯†åˆ«åŒä¼´å…³ç³»ï¼ˆfellow_listå­—æ®µï¼‰
- ç”ŸæˆåŒä¼´ç»„IDï¼ˆfellow_group_idï¼‰
- åœ¨åˆ†é…æ—¶ä¼˜å…ˆå°†åŒä¼´æ”¾åœ¨åŒä¸€æˆ¿é—´
```

**æ•°æ®åº“æ”¯æŒæƒ…å†µ** âœ“ æ”¯æŒ:
- âœ“ studentè¡¨æœ‰fellow_listå­—æ®µï¼ˆé€—å·åˆ†éš”ï¼‰
- âœ“ studentè¡¨æœ‰fellow_group_idå­—æ®µ
- âœ“ fellow_relationè¡¨å­˜åœ¨ï¼ˆä½†æ•°æ®å¯èƒ½æœªåˆå§‹åŒ–ï¼‰

**SQLéªŒè¯**:
```sql
-- æ£€æŸ¥åŒä¼´æ•°æ®
SELECT
  COUNT(CASE WHEN fellow_list IS NOT NULL THEN 1 END) as students_with_fellows,
  COUNT(CASE WHEN fellow_group_id IS NOT NULL THEN 1 END) as students_with_group_id
FROM student;

-- å¦‚æœfellow_group_idæœªåˆå§‹åŒ–ï¼Œéœ€è¦è¿è¡ŒåŒä¼´è¯†åˆ«ç®—æ³•
```

---

## äº”ã€æ”¹è¿›å»ºè®®ä¼˜å…ˆçº§

### ğŸ”´ ç´§æ€¥ï¼ˆå¿…é¡»ä¿®å¤ï¼Œå½±å“åŠŸèƒ½ï¼‰

1. **æ·»åŠ student_typeå­—æ®µ**ï¼ˆé—®é¢˜2.1ï¼‰
   - å½±å“ï¼šå­¦å‘˜ä¼˜å…ˆçº§æ’åº
   - ä¿®å¤æ—¶é—´ï¼š5åˆ†é’Ÿ
   - SQLï¼šè§é—®é¢˜2.1

2. **å¡«å……age_groupæ•°æ®**ï¼ˆé—®é¢˜2.2ï¼‰
   - å½±å“ï¼šç¦…å ‚åº§ä½åˆ†é…
   - ä¿®å¤æ—¶é—´ï¼š5åˆ†é’Ÿ
   - SQLï¼šè§é—®é¢˜2.2

3. **æ·»åŠ is_reservedå’Œreserved_forå­—æ®µ**ï¼ˆé—®é¢˜2.3ï¼‰
   - å½±å“ï¼šé¢„ç•™æˆ¿é—´ç®¡ç†
   - ä¿®å¤æ—¶é—´ï¼š5åˆ†é’Ÿ
   - SQLï¼šè§é—®é¢˜2.3

---

### ğŸŸ¡ é‡è¦ï¼ˆåº”è¯¥ä¿®å¤ï¼Œæ€§èƒ½æˆ–æ•°æ®æ¸…æ™°åº¦ï¼‰

4. **æ·»åŠ center_idå†—ä½™å­—æ®µåˆ°Studentè¡¨**ï¼ˆé—®é¢˜2.4ï¼‰
   - å½±å“ï¼šæŸ¥è¯¢æ€§èƒ½ï¼ˆJOINè¡¨å‡å°‘ï¼‰
   - ä¿®å¤æ—¶é—´ï¼š10åˆ†é’Ÿ
   - SQLï¼šè§é—®é¢˜2.4

5. **æ ‡å‡†åŒ–Roomè¡¨gender_areaå­—æ®µ**ï¼ˆé—®é¢˜2.7ï¼‰
   - å½±å“ï¼šå­—æ®µä¸€è‡´æ€§ã€å¯ç»´æŠ¤æ€§
   - ä¿®å¤æ—¶é—´ï¼š5åˆ†é’Ÿ
   - SQLï¼šè§é—®é¢˜2.7

6. **éªŒè¯å’Œä¿®å¤bedè¡¨çŠ¶æ€å€¼**ï¼ˆé—®é¢˜2.5ï¼‰
   - å½±å“ï¼šåºŠä½çŠ¶æ€æ¸…æ™°åº¦
   - ä¿®å¤æ—¶é—´ï¼š5åˆ†é’Ÿ
   - SQLï¼šè§é—®é¢˜2.5

---

### ğŸŸ¢ å¯é€‰ï¼ˆæ•°æ®è´¨é‡å’ŒéªŒè¯ï¼‰

7. **æ•°æ®å®Œæ•´æ€§æ£€æŸ¥å’Œä¿®å¤**ï¼ˆç« èŠ‚3ï¼‰
   - æ£€æŸ¥ç¼ºå¤±çš„æ€§åˆ«ã€å¹´é¾„ç­‰å­—æ®µ
   - ä¿®å¤æ—¶é—´ï¼š10-30åˆ†é’Ÿ
   - SQLï¼šè§ç« èŠ‚3

---

## å…­ã€å®Œæ•´ä¿®å¤è„šæœ¬

```sql
-- ====== ç¦…ä¿®ä¸­å¿ƒæ’åºŠç³»ç»Ÿ - æ•°æ®åº“ä¿®å¤è„šæœ¬ ======
-- æ‰§è¡Œé¡ºåºï¼šé€ä¸ªæ‰§è¡Œï¼Œæ¯ä¸ªæ“ä½œåéªŒè¯

-- ====== æ­¥éª¤1ï¼šæ·»åŠ student_typeå­—æ®µï¼ˆç´§æ€¥ï¼‰======
ALTER TABLE student ADD COLUMN `student_type` VARCHAR(20) COMMENT 'å­¦å‘˜ç±»å‹ï¼šmonk=æ³•å¸ˆ, old_student=æ—§ç”Ÿ, new_student=æ–°ç”Ÿ' AFTER `age_group`;
ALTER TABLE student ADD KEY `idx_student_type` (`student_type`);

-- å¡«å……æ•°æ®
UPDATE student SET student_type = 'monk' WHERE name LIKE 'æ³•%';
UPDATE student SET student_type = 'old_student' WHERE study_times > 0 AND name NOT LIKE 'æ³•%';
UPDATE student SET student_type = 'new_student' WHERE study_times = 0 AND name NOT LIKE 'æ³•%';

-- éªŒè¯
SELECT student_type, COUNT(*) FROM student GROUP BY student_type;

-- ====== æ­¥éª¤2ï¼šå¡«å……age_groupæ•°æ®ï¼ˆç´§æ€¥ï¼‰======
UPDATE student SET age_group =
  CASE
    WHEN age < 18 THEN '18ä»¥ä¸‹'
    WHEN age < 30 THEN '18-30'
    WHEN age < 40 THEN '30-40'
    WHEN age < 55 THEN '40-55'
    ELSE '55+'
  END
WHERE age IS NOT NULL;

-- éªŒè¯
SELECT age_group, COUNT(*) FROM student GROUP BY age_group;

-- ====== æ­¥éª¤3ï¼šæ·»åŠ æˆ¿é—´é¢„ç•™å­—æ®µï¼ˆç´§æ€¥ï¼‰======
ALTER TABLE room ADD COLUMN `is_reserved` BOOLEAN DEFAULT FALSE COMMENT 'æ˜¯å¦é¢„ç•™' AFTER `status`;
ALTER TABLE room ADD COLUMN `reserved_for` VARCHAR(100) COMMENT 'é¢„ç•™ç”¨é€”' AFTER `is_reserved`;
ALTER TABLE room ADD KEY `idx_reserved` (`is_reserved`);

-- ====== æ­¥éª¤4ï¼šæ·»åŠ Studentè¡¨center_idå­—æ®µï¼ˆé‡è¦ï¼‰======
ALTER TABLE student ADD COLUMN `center_id` BIGINT COMMENT 'æ‰€å±ç¦…ä¿®ä¸­å¿ƒ' AFTER `session_id`;
ALTER TABLE student ADD CONSTRAINT `fk_student_center` FOREIGN KEY (`center_id`) REFERENCES `center`(`id`) ON DELETE CASCADE;
ALTER TABLE student ADD KEY `idx_center_session` (`center_id`, `session_id`);

-- å¡«å……center_id
UPDATE student s
JOIN session ss ON s.session_id = ss.id
SET s.center_id = ss.center_id;

-- éªŒè¯
SELECT center_id, COUNT(*) FROM student GROUP BY center_id;

-- ====== æ­¥éª¤5ï¼šæ ‡å‡†åŒ–Roomè¡¨genderå­—æ®µï¼ˆé‡è¦ï¼‰======
-- é‡å‘½åå­—æ®µ
ALTER TABLE room CHANGE COLUMN `gender_area` `gender` VARCHAR(1) COMMENT 'æ€§åˆ«åŒºåŸŸï¼šM=ç”·ä¼—, F=å¥³ä¼—';

-- æ ‡å‡†åŒ–æ•°æ®å€¼
UPDATE room SET gender = 'M' WHERE gender IN ('ç”·', 'M');
UPDATE room SET gender = 'F' WHERE gender IN ('å¥³', 'F');

-- æ·»åŠ ç´¢å¼•
ALTER TABLE room ADD KEY `idx_center_gender` (`center_id`, `gender`);

-- ====== æ­¥éª¤6ï¼šæ›´æ–°bedè¡¨çŠ¶æ€æ³¨é‡Šï¼ˆå¯é€‰ï¼‰======
ALTER TABLE bed MODIFY COLUMN `status` VARCHAR(20) DEFAULT 'AVAILABLE'
  COMMENT 'çŠ¶æ€ï¼šAVAILABLE=å¯ç”¨, OCCUPIED=å·²å ç”¨, RESERVED=é¢„ç•™, MAINTENANCE=ç»´ä¿®ä¸­';

-- ====== æ­¥éª¤7ï¼šæ•°æ®è´¨é‡æ£€æŸ¥======
-- æ£€æŸ¥æ˜¯å¦æœ‰ç¼ºå¤±çš„å…³é”®æ•°æ®
SELECT
  'missing_gender' as check_item,
  COUNT(*) as count
FROM student WHERE gender IS NULL
UNION ALL
SELECT
  'missing_age',
  COUNT(*)
FROM student WHERE age IS NULL
UNION ALL
SELECT
  'missing_student_type',
  COUNT(*)
FROM student WHERE student_type IS NULL
UNION ALL
SELECT
  'missing_age_group',
  COUNT(*)
FROM student WHERE age_group IS NULL;

-- éªŒè¯æˆ¿é—´å’ŒåºŠä½ä¸€è‡´æ€§
SELECT
  r.room_number,
  r.capacity,
  COUNT(b.id) as actual_beds,
  CASE
    WHEN r.capacity = COUNT(b.id) THEN 'OK'
    ELSE 'MISMATCH'
  END as status
FROM room r
LEFT JOIN bed b ON r.id = b.room_id
GROUP BY r.id
HAVING r.capacity != COUNT(b.id);

-- ====== æ­¥éª¤8ï¼šæœ€ç»ˆéªŒè¯======
-- éªŒè¯æ‰€æœ‰è¡¨éƒ½æ­£ç¡®é…ç½®
SELECT
  (SELECT COUNT(*) FROM student) as student_count,
  (SELECT COUNT(*) FROM room) as room_count,
  (SELECT COUNT(*) FROM bed) as bed_count,
  (SELECT COUNT(*) FROM center) as center_count,
  (SELECT COUNT(*) FROM session) as session_count;
```

---

## ä¸ƒã€ä¿®å¤åéªŒè¯æ¸…å•

ä¿®å¤å®Œæˆåï¼Œè¯·è¿è¡Œä»¥ä¸‹éªŒè¯SQLç¡®ä¿ä¸€åˆ‡æ­£å¸¸ï¼š

```sql
-- 1. å­¦å‘˜ä¼˜å…ˆçº§æ’åºéªŒè¯
SELECT name, student_type, age, age_group, study_times
FROM student
ORDER BY
  FIELD(student_type, 'monk', 'old_student', 'new_student'),
  CASE WHEN student_type = 'old_student' THEN study_times ELSE NULL END DESC,
  CASE WHEN student_type = 'new_student' THEN age ELSE NULL END DESC
LIMIT 10;

-- 2. æ€§åˆ«åˆ†ç¦»éªŒè¯
SELECT
  s.gender,
  st.student_type,
  COUNT(*) as count,
  COUNT(DISTINCT s.age_group) as age_groups
FROM student s
GROUP BY s.gender, st.student_type;

-- 3. æˆ¿é—´å’ŒåºŠä½éªŒè¯
SELECT
  r.room_number,
  r.gender,
  r.room_type,
  r.capacity,
  COUNT(b.id) as actual_beds,
  CASE WHEN r.is_reserved = TRUE THEN 'é¢„ç•™' ELSE 'å¯ç”¨' END as reservation_status
FROM room r
LEFT JOIN bed b ON r.id = b.room_id
GROUP BY r.id
ORDER BY r.room_number;

-- 4. åŒä¼´å…³ç³»åˆå§‹åŒ–éªŒè¯
SELECT
  COUNT(CASE WHEN fellow_list IS NOT NULL THEN 1 END) as with_fellow_list,
  COUNT(CASE WHEN fellow_group_id IS NOT NULL THEN 1 END) as with_group_id
FROM student;
```

---

## å…«ã€æ€»ç»“

### å½“å‰çŠ¶æ€

| é¡¹ç›® | è¯„åˆ† | è¯´æ˜ |
|------|------|------|
| å­¦å‘˜æ•°æ® | 60% | gender/ageå®Œæ•´ï¼Œä½†ç¼ºstudent_type, age_groupæœªå¡«å…… |
| æˆ¿é—´æ•°æ® | 75% | ç¼ºis_reserved/reserved_for, genderå­—æ®µåä¸è§„èŒƒ |
| åºŠä½æ•°æ® | 80% | åŸºæœ¬å®Œæ•´ï¼Œä½†éœ€éªŒè¯capacityä¸€è‡´æ€§ |
| ç¦…å ‚é…ç½® | 95% | è¡¨ç»“æ„å®Œæ•´ï¼Œæ”¯æŒå¤æ‚é…ç½® |
| **æ€»ä½“è¯„åˆ†** | **70%** | **å¯ç”¨ä½†éœ€ä¿®å¤é‡è¦å­—æ®µåæ‰èƒ½è¿è¡Œåˆ†é…ç®—æ³•** |

### ä¿®å¤å·¥ä½œé‡

- **ç´§æ€¥ä¿®å¤**: 3é¡¹ï¼Œçº¦15åˆ†é’Ÿ
- **é‡è¦ä¼˜åŒ–**: 3é¡¹ï¼Œçº¦15åˆ†é’Ÿ
- **æ•°æ®éªŒè¯**: å¯é€‰ï¼Œçº¦20åˆ†é’Ÿ
- **æ€»é¢„è®¡**: 30-50åˆ†é’Ÿ

### åç»­å»ºè®®

1. âœ… ç«‹å³æ‰§è¡Œç´§æ€¥ä¿®å¤è„šæœ¬
2. âœ… æ‰§è¡Œå®Œæ•´ä¿®å¤è„šæœ¬ï¼ˆæ­¥éª¤1-8ï¼‰
3. âœ… è¿è¡Œä¿®å¤åéªŒè¯æ¸…å•
4. âœ… ç¡®è®¤æ‰€æœ‰å­¦å‘˜éƒ½æœ‰æœ‰æ•ˆçš„åŒä¼´å…³ç³»æ•°æ®ï¼ˆè‹¥æœ‰åŒä¼´ï¼‰
5. âœ… å¼€å§‹å®ç°è‡ªåŠ¨åˆ†é…ç®—æ³•

---

**æ–‡æ¡£å®Œæˆ**ï¼š2025-11-05
**çŠ¶æ€**ï¼šå¾…æ‰§è¡Œä¿®å¤è„šæœ¬
**ä¸‹ä¸€æ­¥**ï¼šè‡ªåŠ¨åˆ†é…ç®—æ³•å®ç°
