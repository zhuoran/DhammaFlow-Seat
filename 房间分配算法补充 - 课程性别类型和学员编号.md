# 房间分配算法补充文档
## 课程性别类型与学员编号重新分配

**版本**: 1.0
**日期**: 2025-11-05
**基础**: Excel VBA宏代码分析
**补充内容**: 课程性别类型处理 + 学员编号重新分配逻辑

---

## 一、课程性别类型处理（新增）

### 1.1 课程性别类型分类

在原有的房间分配算法基础上，**需要先判断课程的性别类型**，这决定了后续的分配策略。

#### **3种课程类型定义**

| 课程类型 | 中文名称 | 配置值 | 说明 |
|---------|---------|--------|------|
| **MALE_ONLY** | 男众课程 | "男众" | 仅有男学员参加 |
| **FEMALE_ONLY** | 女众课程 | "女众" | 仅有女学员参加 |
| **CO_ED** | 双性课程 | "双性" | 男女学员混合参加 |

---

### 1.2 课程性别类型判断流程

```
┌─────────────────────────────────────┐
│  读取课程配置（从Session表）        │
│  获取 course_gender_type 字段       │
└────────────┬────────────────────────┘
             │
             ▼
    ┌─ 判断课程性别 ─┐
    │               │
 男众课程      双性课程      女众课程
    │               │
    ▼               ▼               ▼
 MALE_ONLY    CO_ED      FEMALE_ONLY
    │               │               │
    ▼               ▼               ▼
 仅用A楼房间   A楼用男房间   仅用B楼房间
             B楼用女房间
```

### 1.3 配置存储方案

#### **数据库设计建议**

在Session表中添加新字段：

```sql
ALTER TABLE session ADD COLUMN `course_gender_type` VARCHAR(20) DEFAULT 'CO_ED'
  COMMENT '课程性别类型：MALE_ONLY=男众, FEMALE_ONLY=女众, CO_ED=双性';
ALTER TABLE session ADD COLUMN `gender_separated` BOOLEAN DEFAULT FALSE
  COMMENT '是否需要性别分离处理';

-- 值说明：
-- - MALE_ONLY: 仅有男学员，所有房间用男众楼
-- - FEMALE_ONLY: 仅有女学员，所有房间用女众楼
-- - CO_ED: 男女混合，需要分别分配男众楼和女众楼房间（默认）
```

### 1.4 Java实现建议

```java
// Session.java 中添加
public enum CourseGenderType {
    MALE_ONLY("男众"),      // 仅男众
    FEMALE_ONLY("女众"),    // 仅女众
    CO_ED("双性");          // 双性混合

    private String displayName;

    CourseGenderType(String displayName) {
        this.displayName = displayName;
    }
}

// Session.java 中添加属性
private CourseGenderType courseGenderType;  // 课程性别类型
private Boolean genderSeparated;            // 是否需要性别分离

// 判断逻辑
public boolean isMaleOnlyCourse() {
    return courseGenderType == CourseGenderType.MALE_ONLY;
}

public boolean isFemaleOnlyCourse() {
    return courseGenderType == CourseGenderType.FEMALE_ONLY;
}

public boolean isCoEdCourse() {
    return courseGenderType == CourseGenderType.CO_ED;
}
```

### 1.5 课程类型对分配流程的影响

#### **男众课程（MALE_ONLY）处理**

```
分配步骤：
┌─ 步骤1：清空所有房间（仅男众楼房间）
├─ 步骤2：分配出家师到男法师房
├─ 步骤3：分配旧生到男旧生房
├─ 步骤4：分配新生到男新生房
├─ 步骤5：分配老年新生到男老人房
├─ 步骤6：检查同伴关系（仅男众内部）
├─ 步骤7：生成男众禅堂座位
└─ 步骤8：不生成女众禅堂座位（无学员）

特殊处理：
  • 所有学员性别检查：确保都是M（男众）
  • 女法工区域：不生成或标记为空
  • 女众禅堂：不生成
```

#### **女众课程（FEMALE_ONLY）处理**

```
分配步骤：
┌─ 步骤1：清空所有房间（仅女众楼房间）
├─ 步骤2：分配出家师到女法师房
├─ 步骤3：分配旧生到女旧生房
├─ 步骤4：分配新生到女新生房
├─ 步骤5：分配老年新生到女老人房
├─ 步骤6：检查同伴关系（仅女众内部）
├─ 步骤7：生成女众禅堂座位
└─ 步骤8：不生成男众禅堂座位（无学员）

特殊处理：
  • 所有学员性别检查：确保都是F（女众）
  • 男法工区域：不生成或标记为空
  • 男众禅堂：不生成
```

#### **双性课程（CO_ED）处理**

```
分配步骤：
┌─ 步骤1：清空所有房间（男众楼和女众楼）
├─ 步骤2A：按性别分流
│  ├─ 女众分支：分配女出家师、女旧生、女新生
│  └─ 男众分支：分配男出家师、男旧生、男新生
├─ 步骤3：检查同伴关系
│  ├─ 同伴在同一性别：直接同房
│  └─ 同伴在不同性别：标记分离警告
├─ 步骤4：生成女众禅堂座位
├─ 步骤5：生成男众禅堂座位
└─ 步骤6：合并座位表（女→男顺序或按区域）

特殊处理：
  • 男女房间分别统计和验证
  • 同伴关系跨性别时需要特殊处理
  • 禅堂座位使用不同的编号方式区分
  • 法工区域：男众表只填男法工，女众表只填女法工
```

---

## 二、学员编号重新分配（新增）

### 2.1 学员编号概念说明

**编号的含义和用途**：

```
编号 ≠ 学员ID
编号 ≠ 优先级
编号 ≠ 房号

编号 = 禅堂座位号，用于：
  • 禅堂指定座位位置
  • 长期课程期间学员固定坐位
  • 便于点名、考勤、颁发证书
  • 生成座位表、座位牌、座位指引
```

### 2.2 编号方式分类

#### **3种编号方式定义**

| 编号方式 | 代码 | 编号规则 | 示例 | 适用场景 |
|---------|------|---------|------|----------|
| **顺序编号** | NumType=0 | 1, 2, 3, 4, 5... | 座位号：1,2,3,4,5... | 单一禅堂或单性别课程 |
| **奇数编号** | NumType=1 | 1, 3, 5, 7, 9... | 座位号：1,3,5,7... | 双性课程A区（男众或女众） |
| **偶数编号** | NumType=2 | 2, 4, 6, 8, 10... | 座位号：2,4,6,8... | 双性课程B区（另一性别） |

#### **配置存储方案**

在MeditationHallConfig表中添加/确保存在以下字段：

```sql
-- 已存在的字段
- numbering_type (SEQUENTIAL=0/顺序, ODD=1/奇数, EVEN=2/偶数)
- seat_number_prefix (座位号前缀，如"A", "B")
- monk_seat_prefix (法师座位号前缀)

-- 需要添加的字段（如未存在）
ALTER TABLE meditation_hall_config ADD COLUMN `numbering_start` INT DEFAULT 1
  COMMENT '编号起始值（通常为1）';
ALTER TABLE meditation_hall_config ADD COLUMN `numbering_rule` VARCHAR(100)
  COMMENT '编号规则描述（如"顺序编号、按座位物理位置"）';
```

### 2.3 编号分配的完整流程

#### **第一阶段：房间分配时（不涉及编号）**

```
学员表
    ↓
按优先级排序
（出家师→旧生→新生）
    ↓
分配到房间和床位
（无编号，仅有room_id和bed_id）
    ↓
生成分配临时表（allocation表）
```

#### **第二阶段：禅堂座位生成时（初始编号）**

```
分配临时表（房间分配结果）
    ↓
读取禅堂配置（MeditationHallConfig）
    ↓
┌─ 第一轮：填充出家师座位 ────────────────────┐
│                                            │
│ 从法师座位起始位置开始                      │
│ 按行偏移间距排列                            │
│ 编号：法师1、法师2、法师3...                │
│ （独立序列，不与在家学员混合）              │
└────────────────────────────────────────────┘
    ↓
┌─ 第二轮：填充在家学员座位 ────────────────────┐
│                                             │
│ 从开始单元格起始位置开始                     │
│ 按行列顺序（row-major）遍历座位             │
│ 根据编号方式计算座位号：                     │
│   • 顺序：i=1,2,3,4,5...                   │
│   • 奇数：i=1,3,5,7,9...                   │
│   • 偶数：i=2,4,6,8,10...                  │
│ 填入座位号+座位前缀（如"B1", "B3", "B5"）  │
└────────────────────────────────────────────┘
    ↓
生成禅堂过渡座位表（过渡表）
```

#### **第三阶段：禅堂座位确认时（重新编号）**

```
禅堂过渡座位表（包含初始编号）
    ↓
管理员审核和调整（可能交换座位、调整编号）
    ↓
┌─ 重新编号操作 ─────────────────────────────┐
│                                           │
│ 遍历所有有效座位（跳过空座位和法师座位）  │
│                                           │
│ 初始化计数器 i = 1                       │
│                                           │
│ FOR 每个座位                              │
│   IF 座位非空 AND 不是法师                │
│     根据编号方式计算新座位号：             │
│     • 顺序：编号 = i                      │
│     • 奇数：编号 = i*2 - 1               │
│     • 偶数：编号 = i*2                   │
│                                           │
│     写入新座位号 = 前缀 + 编号             │
│     i = i + 1                             │
│   END IF                                   │
│ END FOR                                    │
│                                           │
│ 结果：确保所有学员座位号连续、唯一        │
└────────────────────────────────────────────┘
    ↓
生成最终禅堂座位表
    ↓
输出供养表、座位指引、座位牌等
```

### 2.4 编号生成的具体算法

#### **伪代码：初始编号函数**

```
Function GenerateInitialMeditationSeating(
    allocation: AllocationList,
    hallConfig: MeditationHallConfig,
    students: StudentList
) -> MeditationSeatingList {

    seatingList = new List<MeditationSeating>

    // 步骤1：分配法师座位（独立序列）
    monkSeating = FilterByStudentType(students, "monk")
    monkIndex = 1
    currentCell = ParseCell(hallConfig.monk_start_cell)

    FOR each monk in monkSeating {
        seatingNumber = hallConfig.monk_seat_prefix + monkIndex
        AddToSeatingList(seatingList, seatingNumber, monk)
        currentCell.row += hallConfig.row_offset
        monkIndex++
    }

    // 步骤2：分配在家学员座位
    nonMonkSeating = FilterByStudentType(students, NOT "monk")
    studentIndex = 1
    currentCell = ParseCell(hallConfig.begin_cell)

    FOR row = 1 TO hallConfig.used_rows {
        FOR col = 1 TO hallConfig.used_cols {
            IF studentIndex <= nonMonkSeating.Count {
                seatNumber = CalculateSeatNumber(
                    studentIndex,
                    hallConfig.numbering_type  // 0=顺序, 1=奇数, 2=偶数
                )

                seatingNumber = hallConfig.seat_number_prefix + seatNumber
                AddToSeatingList(seatingList, seatingNumber, nonMonkSeating[studentIndex])

                studentIndex++
            }
            currentCell.col += hallConfig.col_offset
        }
        currentCell.row += hallConfig.row_offset
        currentCell.col = ParseCell(hallConfig.begin_cell).col
    }

    RETURN seatingList
}

Function CalculateSeatNumber(index: Integer, numberingType: Integer) -> Integer {
    SWITCH numberingType {
        CASE 0:  // 顺序编号
            RETURN index  // 1,2,3,4,5...
        CASE 1:  // 奇数编号
            RETURN index * 2 - 1  // 1,3,5,7,9...
        CASE 2:  // 偶数编号
            RETURN index * 2  // 2,4,6,8,10...
    }
}
```

#### **伪代码：重新编号函数**

```
Function RegenerateMeditationSeating(
    existingSeating: MeditationSeatingList,
    hallConfig: MeditationHallConfig
) -> MeditationSeatingList {

    updatedSeating = new List<MeditationSeating>
    studentIndex = 1

    FOR each existingSeating as seating {
        IF seating.is_empty OR seating.is_monk {
            // 保持法师座位和空座位不变
            updatedSeating.Add(seating)
        } ELSE {
            // 重新计算在家学员座位号
            newSeatNumber = CalculateSeatNumber(
                studentIndex,
                hallConfig.numbering_type
            )

            seating.seat_number = hallConfig.seat_number_prefix + newSeatNumber
            updatedSeating.Add(seating)
            studentIndex++
        }
    }

    RETURN updatedSeating
}
```

### 2.5 编号方式选择指南

#### **顺序编号（0）使用场景**

**适用**：
- 单一性别课程（全男或全女）
- 仅有一个禅堂的中心
- 编号不需要区分区域

**特点**：
```
编号序列：1, 2, 3, 4, 5, 6, 7, 8, 9, 10...
座位号示例：1, 2, 3, 4, 5, 6, 7, 8, 9, 10...
```

#### **奇数编号（1）使用场景**

**适用**：
- 双性课程的第一个禅堂区域（A区）
- 需要用奇数区分男众或女众座位

**特点**：
```
编号序列：1, 3, 5, 7, 9, 11...
座位号示例：A1, A3, A5, A7, A9, A11...
使用奇数编号，与偶数区域相区别
```

#### **偶数编号（2）使用场景**

**适用**：
- 双性课程的第二个禅堂区域（B区）
- 需要用偶数区分男众或女众座位

**特点**：
```
编号序列：2, 4, 6, 8, 10, 12...
座位号示例：B2, B4, B6, B8, B10, B12...
使用偶数编号，与奇数区域相区别
```

### 2.6 双性课程的编号实例

#### **示例场景**

- 双性课程，男女各50人
- 禅堂分A区（男众）和B区（女众）
- A区配置：奇数编号（NumType=1），前缀"A"
- B区配置：偶数编号（NumType=2），前缀"B"

#### **编号结果**

```
A区（男众）禅堂座位表：
┌─────────────────────────────────┐
│ 座位号  │ 房号  │ 学员姓名      │
├─────────────────────────────────┤
│ A1      │ A101  │ 王某（男）    │
│ A3      │ A102  │ 李某（男）    │
│ A5      │ A103  │ 张某（男）    │
│ A7      │ A104  │ 刘某（男）    │
│ ...     │ ...   │ ...           │
│ A99     │ A150  │ 最后一人      │
└─────────────────────────────────┘

B区（女众）禅堂座位表：
┌─────────────────────────────────┐
│ 座位号  │ 房号  │ 学员姓名      │
├─────────────────────────────────┤
│ B2      │ B101  │ 王某（女）    │
│ B4      │ B102  │ 李某（女）    │
│ B6      │ B103  │ 张某（女）    │
│ B8      │ B104  │ 刘某（女）    │
│ ...     │ ...   │ ...           │
│ B100    │ B150  │ 最后一人      │
└─────────────────────────────────┘

特点：
  • A区：1, 3, 5, 7, ... 99（奇数，50个）
  • B区：2, 4, 6, 8, ... 100（偶数，50个）
  • 通过编号一目了然地区分男女
  • 便于快速定位座位
```

---

## 三、修改后的完整分配流程

### 3.1 整合课程类型和编号的分配流程

```
┌────────────────────────────────────────────────────────┐
│ 步骤0：验证课程基础配置                                  │
│ ├─ 读取课程类型（MALE_ONLY/FEMALE_ONLY/CO_ED）         │
│ ├─ 读取禅堂编号方式（顺序/奇数/偶数）                  │
│ ├─ 验证学员性别数据完整性                              │
│ └─ 验证房间配置与课程类型一致                          │
└────────┬───────────────────────────────────────────────┘
         │
         ▼
┌────────────────────────────────────────────────────────┐
│ 步骤1：学员预处理（按课程类型）                          │
│ ├─ 如果是MALE_ONLY：筛选所有M性别学员                  │
│ ├─ 如果是FEMALE_ONLY：筛选所有F性别学员               │
│ └─ 如果是CO_ED：分别处理M和F学员                      │
│   ├─ 识别法师、旧生、新生                              │
│   ├─ 识别同伴关系                                      │
│   └─ 排序学员（优先级、修学次数、年龄）                │
└────────┬───────────────────────────────────────────────┘
         │
         ▼
┌────────────────────────────────────────────────────────┐
│ 步骤2：房间分配（按课程类型和性别）                      │
│                                                         │
│ IF MALE_ONLY:                                          │
│   └─ 仅使用男众楼房间进行分配                          │
│                                                         │
│ ELSE IF FEMALE_ONLY:                                   │
│   └─ 仅使用女众楼房间进行分配                          │
│                                                         │
│ ELSE IF CO_ED:                                         │
│   ├─ 男众流程：分配男学员到男众楼房间                  │
│   └─ 女众流程：分配女学员到女众楼房间                  │
│     （两个流程独立并行执行）                           │
│                                                         │
│ 各流程内部：                                            │
│   ├─ 分配出家师→法师房                                │
│   ├─ 分配旧生→旧生房                                  │
│   ├─ 分配新生→新生房                                  │
│   └─ 分配老年新生→老人房                              │
└────────┬───────────────────────────────────────────────┘
         │
         ▼
┌────────────────────────────────────────────────────────┐
│ 步骤3：冲突检测（按性别）                                │
│ ├─ 同伴分离检测                                        │
│ │  ├─ 同性伴侣：直接同房                              │
│ │  └─ 异性伴侣：标记分离警告                          │
│ ├─ 房间超额检测                                        │
│ ├─ 预留房间被占用检测                                  │
│ └─ 性别数据异常检测                                    │
└────────┬───────────────────────────────────────────────┘
         │
         ▼
┌────────────────────────────────────────────────────────┐
│ 步骤4：禅堂座位生成（初始编号）                          │
│                                                         │
│ IF MALE_ONLY:                                          │
│   └─ 生成单一禅堂座位表（仅男众）                      │
│      编号方式：顺序编号（或配置指定）                  │
│                                                         │
│ ELSE IF FEMALE_ONLY:                                   │
│   └─ 生成单一禅堂座位表（仅女众）                      │
│      编号方式：顺序编号（或配置指定）                  │
│                                                         │
│ ELSE IF CO_ED:                                         │
│   ├─ 生成女众禅堂座位表                                │
│   │  ├─ 分配法师座位（独立编号）                      │
│   │  └─ 分配学员座位（编号方式：奇数/偶数）          │
│   └─ 生成男众禅堂座位表                                │
│      ├─ 分配法师座位（独立编号）                      │
│      └─ 分配学员座位（编号方式：奇数/偶数）          │
└────────┬───────────────────────────────────────────────┘
         │
         ▼
┌────────────────────────────────────────────────────────┐
│ 步骤5：人工审核与调整                                    │
│ ├─ 审核房间分配方案                                    │
│ ├─ 解决冲突和特殊需求                                  │
│ ├─ 审核禅堂座位布局                                    │
│ └─ 可能进行座位交换、重新分配等                        │
└────────┬───────────────────────────────────────────────┘
         │
         ▼
┌────────────────────────────────────────────────────────┐
│ 步骤6：禅堂座位重新编号（最终确认）                      │
│ ├─ 遍历所有有效座位                                    │
│ ├─ 跳过法师座位和空座位                                │
│ ├─ 重新计算编号（确保连续性）                          │
│ └─ 根据编号方式重新赋值                                │
│    ├─ 顺序：1, 2, 3, 4, 5...                         │
│    ├─ 奇数：1, 3, 5, 7, 9...                         │
│    └─ 偶数：2, 4, 6, 8, 10...                        │
└────────┬───────────────────────────────────────────────┘
         │
         ▼
┌────────────────────────────────────────────────────────┐
│ 步骤7：报表生成与导出                                    │
│ ├─ 生成床位分配表（按性别、按楼号分页）                │
│ ├─ 生成禅堂座位表（按区域、按编号）                    │
│ ├─ 生成供养表、座位指引等                              │
│ └─ 导出为PDF/Excel                                    │
└────────┬───────────────────────────────────────────────┘
         │
         ▼
┌────────────────────────────────────────────────────────┐
│ 步骤8：数据交付和存档                                    │
│ ├─ 版本控制：保存分配方案版本                          │
│ ├─ 备份：备份分配结果                                  │
│ └─ 交付：将数据交付给其他系统                          │
└────────────────────────────────────────────────────────┘
```

### 3.2 修改数据库Schema以支持新逻辑

```sql
-- 1. Session表添加课程性别类型
ALTER TABLE session ADD COLUMN `course_gender_type` VARCHAR(20) DEFAULT 'CO_ED'
  COMMENT '课程性别类型：MALE_ONLY=男众, FEMALE_ONLY=女众, CO_ED=双性' AFTER `course_type`;

-- 2. MeditationHallConfig表确保编号相关字段存在
ALTER TABLE meditation_hall_config ADD COLUMN `numbering_start` INT DEFAULT 1
  COMMENT '编号起始值（通常为1）' AFTER `numbering_type`;
ALTER TABLE meditation_hall_config ADD COLUMN `numbering_rule` VARCHAR(200)
  COMMENT '编号规则描述（如"顺序编号、按座位物理位置、每个禅堂独立计数"）' AFTER `numbering_start`;

-- 3. MeditationSeat表确保完整记录编号
ALTER TABLE meditation_seat ADD COLUMN `is_renumbered` BOOLEAN DEFAULT FALSE
  COMMENT '该座位是否已进行最终编号' AFTER `seat_number`;
ALTER TABLE meditation_seat ADD COLUMN `original_seat_number` VARCHAR(20)
  COMMENT '原始座位号（编号前的座位号）' AFTER `is_renumbered`;
```

---

## 四、修改前/后对比

### 4.1 算法变化对比

| 项目 | 修改前 | 修改后 |
|------|--------|--------|
| **课程类型判断** | 无 | 必须先判断课程类型（单性/双性） |
| **房间分配策略** | 统一处理 | 根据课程类型分别处理 |
| **性别分离** | 隐含的、不明确的 | 显式判断、清晰的三种流程 |
| **同伴关系处理** | 仅考虑同性伴侣 | 区分同性和异性伴侣，分别处理 |
| **编号方式** | 在禅堂配置中 | 明确的三种编号方式和选择规则 |
| **编号时机** | 座位生成时一次 | 座位生成时+座位确认时（两次） |
| **禅堂座位** | 生成一张表 | 根据课程类型生成1张或2张表 |

---

## 五、实现优先级

### 🔴 **必须实现**

1. **课程性别类型判断逻辑**
   - 添加course_gender_type字段
   - 实现三种课程类型的判断函数
   - 根据课程类型分支处理

2. **学员编号重新分配逻辑**
   - 实现初始编号函数
   - 实现重新编号函数
   - 支持三种编号方式

### 🟡 **应该实现**

3. **异性伴侣处理**
   - 检测同伴性别是否一致
   - 标记异性伴侣分离

4. **禅堂座位两次编号**
   - 座位生成时初始编号
   - 座位确认时最终编号

### 🟢 **可选实现**

5. **编号规则文档**
   - 在UI中显示编号方式说明
   - 提供编号规则预览

---

## 六、总结

### 关键概念回顾

| 概念 | 说明 |
|------|------|
| **课程性别类型** | 决定是否需要性别分离分配，有3种：男众、女众、双性 |
| **编号方式** | 决定座位号如何计算，有3种：顺序、奇数、偶数 |
| **初始编号** | 禅堂座位生成时执行，按座位位置顺序赋号 |
| **重新编号** | 座位确认时执行，确保编号连续唯一 |
| **编号与分配的关系** | 房间分配和编号独立，编号仅用于禅堂座位定位 |

### 验证清单

在实现时，请确保：

- [ ] 数据库已添加course_gender_type字段
- [ ] Java代码支持三种课程类型判断
- [ ] 房间分配逻辑根据课程类型分支执行
- [ ] 禅堂座位生成支持三种编号方式
- [ ] 实现了重新编号逻辑
- [ ] 异性伴侣被正确识别和标记
- [ ] 禅堂座位表显示正确的编号结果
- [ ] 所有报表基于最终编号号生成

---

**文档完成**：2025-11-05
**状态**：待集成到主算法文档
**下一步**：更新主算法文档，合并本补充内容
