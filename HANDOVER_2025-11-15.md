# DhammaFlow-Seat 项目交接文档
**日期**: 2025-11-15
**上次交接**: HANDOVER_2025-11-14.md
**工作内容**: 电影院风格座位管理系统实现与优化

---

## 📋 今日工作总结

### 1. 核心功能实现 ✅

#### 1.1 电影院风格座位可视化系统（全新功能）

**需求来源**: 禅堂座位可视化设计规范_v1.0.md

**实现内容**:
- ✅ 创建了完整的座位管理页面 (`/seats-management`)
- ✅ 电影院风格座位图组件 (`SeatMapCanvas`)
- ✅ 单个座位组件 (`SeatItem`)
- ✅ 老师法座组件 (`TeacherSeat`)
- ✅ 座位详情抽屉 (`SeatDetailDrawer`)
- ✅ 座位分配和交换功能

**设计特点**:
- 双性课程自动合并显示（女众左、男众右、中间分割线）
- 单性课程独立显示
- 老师法座位于正下方（默认共用一位老师）
- 座位颜色区分：
  - 空座位: `#E0E7FF` (浅紫蓝)
  - 男众: `#4F6FAE` (藏青色)
  - 女众: `#C7B2D6` (淡紫藤色)
  - 不可用: `#F5F5F5` (灰色)

#### 1.2 座位布局逻辑优化 ✅

**关键修复**:

1. **区域性别显示逻辑**
   - 问题：之前只看第一个座位的性别，导致显示错误
   - 解决：统计区域内所有座位的性别分布，取主要性别
   ```typescript
   const genderCount = { M: 0, F: 0 };
   regionSeats.forEach((seat) => {
     if (seat.gender === 'M') genderCount.M++;
     else if (seat.gender === 'F') genderCount.F++;
   });
   const gender = genderCount.M > genderCount.F ? 'M' : genderCount.F > 0 ? 'F' : undefined;
   ```

2. **座位排序和位置**
   - 1号座位（`rowIndex=0`）在第1排（最接近老师）
   - 渲染顺序反转：`[...grid].reverse()` - 第1排在下方接近法座
   - 行号显示：`rowIdx + 1` - 正确对应座位编号

3. **左右区域排序**
   - 从老师视角：女众在左（法座左边），男众在右（法座右边）
   ```typescript
   const sortedRegions = [...regionGroups].sort((a, b) => {
     if (a.gender === 'F' && b.gender === 'M') return -1;
     if (a.gender === 'M' && b.gender === 'F') return 1;
     return 0;
   });
   ```

---

## 🐛 已修复的Bug

### Bug #1: A区和B区都显示为女众
**根因**: 只取第一个座位的gender字段，不能代表整个区域
**修复**: 统计区域内所有座位性别，取主要性别
**文件**: `src/components/meditation/SeatMapCanvas.tsx:48-54`

### Bug #2: A区和B区都包含男女学员
**根因**: 数据库配置错误，两个区域的 `gender_type` 都设置为 `mixed`
**修复**: 更新数据库配置
```sql
UPDATE meditation_hall_config SET gender_type = 'M' WHERE region_code = 'A';
UPDATE meditation_hall_config SET gender_type = 'F' WHERE region_code = 'B';
```
**影响**: 重新生成座位后，A区只有男众，B区只有女众

### Bug #3: B区第一排只有两个座位
**根因**: 数据问题，已通过重新生成座位解决
**解决**: 删除旧座位数据，基于新配置重新生成

### Bug #4: 1号座位离老师最远
**根因**: 行号显示逻辑错误
**修复**:
- 反转grid渲染顺序
- 正确映射 `rowIndex=0` → "第1排"
- 第1排渲染在下方（接近法座）

### Bug #5: 男女区域左右位置错误
**根因**: 排序逻辑将男众排在左边
**修复**: 反转排序，女众在左（老师左手边），男众在右（老师右手边）

---

## 📁 代码变更清单

### 新增文件

1. **前端类型定义**
   - `src/types/domain.ts` - 添加 `MeditationSeat` 和 `SeatStatistics` 接口

2. **API服务**
   - `src/services/api/meditation-seats.ts` - 座位管理API（9个函数）
     - `fetchSeats()` - 获取会期座位
     - `fetchSeatsByRegion()` - 按区域获取
     - `generateSeats()` - 生成座位
     - `assignSeat()` - 分配座位
     - `swapSeats()` - 交换座位
     - `fetchSeatStatistics()` - 获取统计
     - `fetchSeat()` - 获取单个座位
     - `deleteSessionSeats()` - 删除会期座位

3. **UI组件**
   - `src/components/meditation/SeatItem.tsx` - 座位单元格
   - `src/components/meditation/SeatMapCanvas.tsx` - 座位图画布
   - `src/components/meditation/TeacherSeat.tsx` - 老师法座
   - `src/components/meditation/SeatDetailDrawer.tsx` - 座位详情抽屉
   - `src/components/meditation/SeatManagementPage.tsx` - 座位管理页面

4. **路由**
   - `src/app/(console)/seats-management/page.tsx` - 新路由

### 修改文件

1. **React Query hooks**
   - `src/hooks/queries.ts`
     - 添加 `useMeditationSeats()`
     - 添加 `useSeatStatistics()`

2. **API导出**
   - `src/services/api/index.ts`
     - 导出 `meditationSeatApi`

3. **导航菜单**
   - `src/components/layout/Sidebar.tsx`
     - 添加 "座位管理" 菜单项
     - 重命名 "禅堂座位" → "禅堂配置"

---

## 💾 数据库变更

### 配置更新

```sql
-- 修正禅堂配置的性别类型
UPDATE meditation_hall_config
SET gender_type = 'M'
WHERE region_code = 'A';

UPDATE meditation_hall_config
SET gender_type = 'F'
WHERE region_code = 'B';

-- 清空旧座位数据
DELETE FROM meditation_seat WHERE session_id = 1;
```

**重要**: 用户需要在前端点击"生成座位"按钮重新生成座位数据

---

## 🎯 功能验证清单

- [x] 座位图正确显示双区域合并布局
- [x] 女众区域在左侧（老师左手边）
- [x] 男众区域在右侧（老师右手边）
- [x] 中间有清晰的分割线
- [x] 老师法座显示在正下方
- [x] 第1排在下方（最接近法座）
- [x] 1号座位在第1排
- [x] 行号从下到上递增（1, 2, 3...）
- [x] A区只有男众学员
- [x] B区只有女众学员
- [x] 点击座位可打开详情抽屉
- [x] 可以搜索并分配学员到座位
- [x] 座位颜色正确区分状态和性别

---

## 🔧 技术细节

### 关键算法

#### 1. 区域性别统计
```typescript
const genderCount = { M: 0, F: 0 };
regionSeats.forEach((seat) => {
  if (seat.gender === 'M') genderCount.M++;
  else if (seat.gender === 'F') genderCount.F++;
});
const gender = genderCount.M > genderCount.F ? 'M' : genderCount.F > 0 ? 'F' : undefined;
```

#### 2. 座位网格反转渲染
```typescript
{[...grid].reverse().map((row, reverseIdx) => {
  const rowIdx = totalRows - 1 - reverseIdx;
  const displayRowNumber = rowIdx + 1;
  // ...
})}
```

#### 3. 双区域性别排序
```typescript
const sortedRegions = [...regionGroups].sort((a, b) => {
  if (a.gender === 'F' && b.gender === 'M') return -1; // 女左
  if (a.gender === 'M' && b.gender === 'F') return 1;  // 男右
  return 0;
});
```

### 后端座位生成逻辑（已验证）

位置: `backend/src/main/java/cc/vipassana/service/impl/MeditationSeatServiceImpl.java:139-147`

```java
private List<Student> filterStudentsByRegion(List<Student> students, String genderType) {
    if ("mixed".equals(genderType)) {
        return students;
    }
    return students.stream()
            .filter(s -> genderType.equals(s.getGender()))
            .collect(Collectors.toList());
}
```

**工作机制**:
- `genderType="M"` → 只过滤男众学员
- `genderType="F"` → 只过滤女众学员
- `genderType="mixed"` → 接受所有学员

---

## 📊 当前数据状态

### meditation_hall_config 表
```
| id | session_id | region_code | region_name | gender_type |
|----|------------|-------------|-------------|-------------|
| 1  | 1          | A           | 禅堂A区     | M           |
| 2  | 1          | B           | 禅堂B区     | F           |
```

### meditation_seat 表
- 状态: 已清空（需要重新生成）
- 生成方式: 前端点击"生成座位"按钮

---

## ⚠️ 已知限制

1. **老师法座配置**
   - 当前默认为"同一位老师"（法座在正中间）
   - 如需支持"不同老师"（每区各一个法座），需要添加配置字段

2. **座位编号算法**
   - 由后端 `SeatNumberingService` 生成
   - 前端只负责显示

3. **双区域检测**
   - 当前简单判断 `regionGroups.length === 2`
   - 可能需要更复杂的逻辑处理特殊情况

---

## 🚀 下一步工作建议

### 优先级 P0（必须）
- [ ] 用户测试并收集反馈
- [ ] 座位分配功能完整测试
- [ ] 座位交换功能测试

### 优先级 P1（重要）
- [ ] 添加座位打印功能（参考设计规范第④点）
- [ ] 移动端适配优化（参考设计规范第7节）
- [ ] 座位快速定位功能（输入姓名→高亮座位）

### 优先级 P2（可选）
- [ ] 拖拽调整座位
- [ ] 自动生成前后门、柱子、走道
- [ ] 生成讲义式排位表（Position Sheet）
- [ ] 支持不同老师配置（每区各一个法座）

---

## 📖 参考文档

1. **设计规范**: `禅堂座位可视化设计规范_v1.0.md`
2. **后端架构**: `backend/MEDITATION_HALL_DESIGN.md`
3. **上次交接**: `HANDOVER_2025-11-14.md`
4. **前端规范**: `frontend-new/.claude/CLAUDE.md`

---

## 🔍 调试信息

### 开发服务器
- 端口: http://localhost:3000 或 http://localhost:3001
- 状态: 运行中
- 日志: `/tmp/frontend-dev.log`

### 数据库连接
```bash
mysql -h 192.168.2.110 -u root -p123456 -e "USE flowseat;"
```

### 常用查询

**查看座位数据**:
```sql
SELECT seat_number, row_index, col_index, gender, region_code, status
FROM meditation_seat
WHERE session_id = 1
ORDER BY region_code, row_index, col_index;
```

**查看配置**:
```sql
SELECT id, region_code, region_name, gender_type
FROM meditation_hall_config
WHERE session_id = 1;
```

**查看统计**:
```sql
SELECT
  region_code,
  gender,
  COUNT(*) as total,
  SUM(CASE WHEN status = 'allocated' THEN 1 ELSE 0 END) as allocated
FROM meditation_seat
WHERE session_id = 1
GROUP BY region_code, gender;
```

---

## ✅ 今日成果

1. **完整实现电影院风格座位管理系统**
   - 4个核心组件（SeatItem, SeatMapCanvas, TeacherSeat, SeatDetailDrawer）
   - 1个管理页面（SeatManagementPage）
   - 9个API接口
   - 2个React Query hooks

2. **修复5个关键bug**
   - 区域性别显示错误
   - 学员性别隔离问题
   - 座位排序问题
   - 左右位置错误
   - 行号显示错误

3. **数据库配置优化**
   - 修正 A/B 区的性别类型设置
   - 确保座位生成按性别严格隔离

4. **用户体验优化**
   - 符合禅修中心的禅堂布局习惯
   - 从老师视角的正确左右位置
   - 清晰的视觉设计和交互

---

## 💡 重要提醒

1. **重新生成座位**
   - 配置已更新，需要点击"生成座位"按钮重新生成
   - 确保学员数据已正确分配房间（allocation表有数据）

2. **浏览器缓存**
   - 使用强制刷新：Cmd+Shift+R (Mac) 或 Ctrl+Shift+R (Windows)

3. **性别数据完整性**
   - 确保学员表的 `gender` 字段正确设置
   - 座位显示依赖此字段

---

**交接完成时间**: 2025-11-15
**交接人**: Claude (AI Assistant)
**下次交接**: 建议每日工作结束时更新

---

## 🎉 里程碑

- ✅ 禅堂配置UI优化（已知问题2）- 已完成
- ✅ 电影院风格座位可视化 - 已完成
- ✅ 座位管理核心功能 - 已完成
- 🔄 座位分配工作流程 - 进行中
- ⏳ 座位打印和导出 - 待开发
