# DhammaFlow-Seat 交接（禅堂座位可视化未修复）—2025-11-28

## 当前状态
- 禅堂座位可视化仍有未解决的错位问题（女区最后一排/底部对齐偶发偏移），仅做了列反转与样式放大，未完全按设计稿对齐。
- 后端已限制每会期只保留 1 条非空禅堂配置；启动时的 ConfigLoader 被禁用，避免重启覆盖配置；生成时如果配置为空/多条直接报错。
- 新增 `POST /api/hall-configs/upsert` 覆盖式写入配置：同会期仅留 1 条，layout 为空会报错。
- 座位生成：SeatAllocator 只做到“按性别拆区，旧生行升序填充，新生行升序填充，空位留远端”，未实现 PRD 要求的“旧生前排+新生右→左竖列”。

## 关键变更位置
- 后端
  - `loader/ConfigLoader.java`：`@Component` 注释掉，启动不再导入配置。
  - `controller/MeditationHallConfigController.java`：新增 `POST /api/hall-configs/upsert`。
  - `service/impl/MeditationHallConfigServiceImpl.java`：`upsertBySession` 覆盖同会期配置，layout 为空报错；`listBySession` 只返回最新一条有 layout 的配置。
  - `service/impl/MeditationSeatServiceImpl.java`：生成前强校验“仅 1 条非空配置”，否则抛错。
  - `service/seat/SeatAllocator.java`：按性别拆区，旧生行升序填充，新生行升序填充；未实现 PRD 的旧生前排/新生竖列分布。
- 前端（`frontend-new`）
  - 禅堂配置页使用 upsert 保存唯一配置，展示当前配置概要（session 维度覆盖）。
  - `SeatMapCanvas.tsx`：移除跨区补空行，按实际行数渲染；左区列反转；底部对齐依赖 `items-end`；SeatItem 放大显示姓名/年龄/课次/服务次数/修学总次数。
  - `SeatManagementPage.tsx`：座位与学员信息合并展示，使用新 upsert 流程生成/清空座位。

## 未解决 & 风险
- **禅堂座位可视化错位**：双区（AB_SPLIT/DUAL）下，女区最后一排/底部偶发偏移；未实现按 `maxRows` 补齐、未做跨区统一行高，对齐仍不稳定。需要复现后在 `SeatMapCanvas` 中按左右区最大行数补齐顶部空行、保持底部对齐，并仅对左区/女区做列反转。
- **座位分配规则不符 PRD**：SeatAllocator 新学生填充仍是行升序、列升序，缺失“旧生前排 + 新生右→左竖列”策略。
- **配置缺失会导致生成失败**：生成前严格要求仅 1 条非空 layout；若前端保存空配置或重复配置会直接抛错，需要先保存有效配置。

## 数据/环境提示
- DB 期望：每会期仅 1 条非空 `meditation_hall_config.layout_config`；重复会被 upsert 清理。此前手动插入过一条有效配置（id=24，AB_SPLIT/DUAL），若被清空需先在前端重新保存。
- 清空座位仅影响 `meditation_seat` 表，不会清理禅堂配置。

## 建议的下一步
1) 先在前端保存一次有效禅堂配置（AB_SPLIT/DUAL），确认 DB 只剩 1 条非空配置，再触发生成。  
2) 复现并修复 SeatMapCanvas 对齐：按左右区 `maxRows` 补齐空行，列反转仅对左区/女区生效，确认行号与法座方向一致。  
3) 按 PRD 重写 SeatAllocator：旧生优先前排，新生按右→左竖列填充，空位留远端；补充回归用例。  
4) 如可视化仍偏移，结合设计稿校正 `SeatItem` 尺寸和网格间距，必要时添加快照/截图验证。
5) 优化重构禅堂配置数据库表结构，确保会期唯一非空配置且字段贴合前端模板（模板、编号方式、用途等）并便于扩展。  
6) 修正禅堂座位样式：列反转、底部对齐、行高间距、跨区对齐按设计稿统一，避免女区最后一排错位。  
7) 支持手动快速调整座位（如拖拽或快捷交换），同步更新座位与学员绑定。  
8) 调整完成后的打印功能：按最终布局生成打印视图，确保行列顺序与可视化一致。
