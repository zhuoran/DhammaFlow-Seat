# 禅修中心智能排床与禅堂座位分配系统 - PRD文档

**版本号**: 1.1
**最后更新**: 2025-11-01
**文档所有者**: 技术架构团队
**目标平台**: Web应用（替代Excel VBA宏系统）

**更新说明**：
- v1.1 (2025-11-01): 基于Excel实际系统分析，完善禅堂座位布局规则、性别分离流程、年龄分段考虑、数据库字段补充

---

## 目录

1. [产品概述](#产品概述)
2. [核心需求](#核心需求)
3. [系统架构](#系统架构)
4. [数据模型](#数据模型)
5. [功能模块](#功能模块)
6. [业务流程](#业务流程)
7. [UI/UX设计要求](#uiux设计要求)
8. [非功能性需求](#非功能性需求)
9. [技术栈建议](#技术栈建议)
10. [实现阶段](#实现阶段)

---

## 产品概述

### 背景

禅修中心定期组织禅修课程（10日课、20日课、30日课、45日课等），需要自动化管理学员的房间分配和禅堂座位安排。原有系统基于Excel宏实现，存在以下问题：

- 依赖特定的Excel环境，可维护性差
- 宏代码分散，难以追踪和修改
- 无法实时预览和调整
- 协作困难，容易产生版本冲突

### 目标

构建一个**Web应用系统**，实现学员信息导入、房间自动分配、禅堂座位动态生成的完整工作流，支持人工审核和修改，最终生成可打印的正式安排表。

### 产品定位

- **用户群**: 禅修中心管理员、排床专员
- **核心价值**: 自动化繁琐的房间分配工作，减少人力成本，提高工作效率
- **使用场景**: 每次课程开班前的学员住房分配（通常1-2周前开始）

---

## 核心需求

### 需求0：禅修中心管理

**功能描述**：
- 管理禅修中心的基本信息（中心名称、地址、联系方式等）
- 每个中心独立维护自己的房间、禅堂、课程期次等资源
- 支持多禅修中心的独立运营

**中心属性**：
```
中心名称(必填), 地址, 联系电话, 联系人, 中心简介, 备注
```

**业务规则**：
- 每个中心的房间配置、禅堂配置、课程期次都是独立的
- 房间一旦设置完成通常保持不变（除非中心扩建）
- 禅堂配置也相对固定
- 课程期次和学员分配是变动的

**使用场景**：
```
禅修中心A
├── 房间配置（固定：B楼100间、A楼80间）
├── 禅堂配置（固定：A区、B区）
└── 课程期次1、期次2、期次3...（动态添加）

禅修中心B
├── 房间配置（固定：C楼50间、D楼60间）
├── 禅堂配置（固定：只有A区）
└── 课程期次1、期次2...（动态添加）
```

---

### 需求1：学员信息管理

**功能描述**：
- 支持批量导入学员信息（CSV、Excel、JSON格式）
- 支持手工添加/编辑单个学员信息
- 学员字段包括：学号、姓名、身份证、年龄、城市、电话、修学次数、课程参加记录、同伴选择、特殊需求等
- 支持学员信息导出

**输入数据**：
```
学号, 姓名, 身份证, 年龄, 城市, 电话,
修学次数, 10日课程次数, 四念住课程次数, 20日课程次数, 30日课程次数, 45日课程次数,
服务次数, 同伴, 特殊需求
```

**业务规则**：
- 法师（姓名以"法"开头）优先级最高
- 旧生（修学次数>0）优先级高于新生
- 同伴关系：允许指定与其他学员同住
- 课程类型：包括10日课、四念住课、20日课、30日课、45日课等

---

### 需求2：房间配置管理

**功能描述**：
- 为指定禅修中心配置房间信息（房号、容量、类型等）
- 支持按修学属性（法师房、旧生房、新生房）分类
- 支持标记预留房间（法工、讲师等特殊人员）
- **关键特性**：房间配置设置一次后通常保持不变，仅在中心扩建时更新

**房间属性**：
```
房号(必填), 楼号, 楼层, 容量(1/2), 房间类型(法师房/旧生房/新生房/其他),
使用状态(启用/禁用), 是否预留, 预留用途, 备注
```

**房间分类说明**：
- **法师房** - 分配给法师（修行者）
- **旧生房** - 分配给参加过课程的旧生
- **新生房** - 分配给第一次参加课程的新生
- **其他房** - 法工等特殊人员

**简化配置流程**：
1. **初始化配置**（一次性操作）
   - 在禅修中心创建时，批量导入或手工输入所有房间信息
   - Excel导入格式：房号、楼号、楼层、容量、房间类型、备注

2. **房间分类分配**（可选）
   - 系统可以自动推荐房间类型，管理员确认
   - 或者手工逐间分配房间类型

3. **预留房间标记**（可选）
   - 标记某些房间为预留（不参与学员分配）
   - 预留房间的用途说明（如"法工房"、"讲师房"）

4. **启用/禁用房间**（维护操作）
   - 房间出现问题时可禁用，使其不参与分配
   - 维修完成后重新启用

**特殊房间处理**：
- 预留房间不会参与自动分配
- 禁用房间会从可用列表中排除
- 同一房间内最多2张床，系统自动管理床位

---

### 需求3：自动房间分配

**功能描述**：
- 基于学员优先级、性别、年龄和房间类型，自动生成分配方案
- 支持性别分离（双性课程需分别分配男众女众）
- 支持同伴保护（同伴尽量分配到同一房间）
- 支持年龄分段考虑（同优先级内按年龄排序）
- 支持打乱分配（避免同优先级学员聚集）
- 生成临时分配表供人工审核

**分配算法**：

```
分配流程（双性课程示例）：
┌─ 按性别分流 ────────────────────────┐
├─ 女众流程                           │
│  学员表 → 过滤女众 → 排序 → 分配 → │
│         女众房间分配结果              │
├─ 男众流程                           │
│  学员表 → 过滤男众 → 排序 → 分配 → │
│         男众房间分配结果              │
└─────────────────────────────────────┘

分配优先级（同性别内部）：
  1. 法师学员 → 分配到"法师房"
  2. 非法师旧生 → 分配到"旧生房"
     - 按修学次数降序排列
     - 同修学次数则按年龄降序
  3. 非法师新生 → 分配到"新生房"
     - 按年龄分段排列：
       - 18-30岁有同伴 > 一般18-30岁
       - 30-40岁
       - 40-55岁
       - 60+ (特殊考虑)

同伴处理：
  - 同伴优先分配到同一房间
  - 同伴分配时考虑性别（男女同伴应分离到对应性别房间）
  - 如果同伴无法同房，标记为"需要手工调整"
  - 同伴在同性别内必须分配在靠近的房间（至少同楼）

房间容量处理：
  - 单人房只放1人
  - 双人房优先放2人，不足才单人安排
  - 超额时给予提示
  - 考虑房间类型优先级：法师房 > 旧生房 > 新生房

性别分离规则（针对双性课程）：
  - 女众使用女众楼（如B楼）
  - 男众使用男众楼（如A楼）
  - 可以跨楼使用（AB楼都用女众/男众房间）
  - 分配过程完全独立，最后合并结果
```

---

### 需求4：禅堂座位动态生成

**功能描述**：
- 根据最终房间分配方案，自动生成禅堂座位表
- 支持多种编号方式（顺序、奇数、偶数）
- 支持禅堂双区域管理（A区、B区，宽度和行数可配置）
- 支持按性别分离的座位布局
- 支持按年龄分段的座位安排规则
- 座位号与房号-床号绑定
- 支持法师座位、法工座位、旧生席位的特殊标记

**禅堂区域配置**：
```
禅堂区域A（女众或混合）：
  - 区域宽度（列数）：4 (可选择"自动")
  - 行数：自动计算
  - 有效座位范围：Excel范围（如A5:E20）
  - 起始单元格：D5
  - 行列偏移：1, 1

禅堂区域B（男众或混合）：
  - 区域宽度（列数）：10 (可选择"自动")
  - 行数：自动计算
  - 有效座位范围：Excel范围（如A22:E37）
  - 起始单元格：D22
  - 行列偏移：1, 1
```

**禅堂座位布局规则**（根据性别分离）：

#### 女众区布局：
```
位置分布（从左到右）：
┌──────────────────────────────────┐
│ 法师座  │ 18-30岁有同伴  │ 30-40岁 │  法座
│(垂直)   │ 18-30岁一般    │ 40-55岁 │(右侧)
│         │ 旧生座位        │ 60+    │
└──────────────────────────────────┘

座位分类：
1. 法师座位（黄色标记）- 最顶端，垂直排列
2. 旧生座位（黄色背景）
   - 按年龄分段分配
   - 优先放置有同伴的学员
3. 新生座位（白色背景）
   - 按年龄分段分配：18-30 > 30-40 > 40-55 > 60+
   - 同年龄段内按修学次数排序
```

#### 男众区布局：
```
位置分布（从左到右）：
┌──────────────────────────────────┐
│ 法师座  │ 40-55岁    │ 30-40岁 │  法座
│(垂直)   │ 30-40岁    │ 18-30岁 │(右侧)
│         │ 18-30岁有同伴 │有同伴  │
│         │ 旧生座位     │        │
└──────────────────────────────────┘

座位分类：
1. 法师座位 - 最顶端，垂直排列
2. 旧生座位
   - 按年龄分段分配（男众倾向于放置年长者在靠前位置）
   - 优先放置有同伴的学员
3. 新生座位
   - 按年龄分段分配：40-55 > 30-40 > 18-30有同伴 > 18-30一般 > 60+
   - 同年龄段内按修学次数排序
```

**编号规则**：
- **顺序编号**: 1, 2, 3, 4, ... (从左上到右下，行优先)
- **奇数编号**（A区）: 1, 3, 5, 7, ...
- **偶数编号**（B区）: 2, 4, 6, 8, ...
- **座位号前缀**: 可自定义（如"A"、"B"等）

**座位生成算法**：
```
1. 根据课程类型判断是否需要性别分离
   if 双性课程:
     按性别分别生成女众座位表和男众座位表
   else:
     生成统一座位表

2. 计算座位布局
   if UsedRow == 0 (自动):
     CHANCOLS = UsedCol 或 MaxCol  (区域宽度)
     CHANROWS = ceil(非法师人数 / CHANCOLS)
   else (手动):
     CHANROWS = UsedRow
     CHANCOLS = ceil(非法师人数 / CHANROWS)

3. 分配法师座位
   from ProStart (法师座位起始位置), 按 RowOffset 间距
   编号: StuNunHead_Pro + "1", "2", ...

4. 按年龄分段排序学员
   对于同性别的旧生和新生，按年龄分段进行排序

5. 分配学员座位（按优先级）
   双层循环: for row in 1..CHANROWS:
            for col in 1..CHANCOLS:
   按编号方式：
   if NumType == 0 (顺序):
     座位号 = i (1,2,3,4,...)
   if NumType == 1 (奇数):
     座位号 = i*2-1 (1,3,5,7,...)
   if NumType == 2 (偶数):
     座位号 = i*2 (2,4,6,8,...)
   座位内容 = 学员的房号-床号

6. 处理同伴关系
   if 同伴在不同禅堂:
     标记为"同伴分离"
     尝试调换学员以保持同伴关系
```

---

### 需求5：人工审核与调整

**功能描述**：
- 展示自动分配结果
- 支持手工修改学员房间分配
- 支持手工调整禅堂座位
- 支持撤销/恢复操作
- 实时预览修改结果

**调整类型**：
- 交换两个学员的房间
- 单个学员重新分配房间
- 标记特殊学员（需要特殊照顾）
- 处理冲突告警（同伴分离、超额房间等）

---

### 需求6：输出与导出

**功能描述**：
- 生成正式床位分配表（可打印）
- 生成正式禅堂座位表（可打印）
- 生成法工座位表
- 生成布施（Dana）统计表
- 支持多种导出格式（PDF、Excel、CSV）

**输出内容**：
```
床位分配表：房号-床号与学员姓名、身份证、年龄、修学属性的对应关系
禅堂座位表：座位号与房号-床号、学员姓名的对应关系
法工座位表：法工编号与姓名、房号、修学年限的对应关系
```

---

## 系统架构

### 高层架构图

```
┌─────────────────────────────────────────────────────────────┐
│                     前端Web应用 (React/Vue)                  │
├─────────────────────────────────────────────────────────────┤
│  ├─ 学员管理模块      │ ├─ 房间配置模块                      │
│  ├─ 分配方案生成      │ ├─ 禅堂配置模块                      │
│  ├─ 人工审核与调整    │ ├─ 报表导出模块                      │
│  └─ 实时预览          │ └─ 数据导入导出                      │
└─────────────────────────────────────────────────────────────┘
                        ↕ (REST API / GraphQL)
┌─────────────────────────────────────────────────────────────┐
│                  后端业务逻辑层 (Node/Python)                │
├─────────────────────────────────────────────────────────────┤
│  ├─ 学员管理服务      │ ├─ 分配算法引擎                      │
│  ├─ 房间管理服务      │ ├─ 禅堂座位生成服务                  │
│  ├─ 配置管理服务      │ ├─ 验证与冲突检测服务                │
│  └─ 报表生成服务      │ └─ 数据导入导出服务                  │
└─────────────────────────────────────────────────────────────┘
                        ↕ (SQL / ORM)
┌─────────────────────────────────────────────────────────────┐
│              数据层 (PostgreSQL / MySQL)                     │
├─────────────────────────────────────────────────────────────┤
│  ├─ 学员表             │ ├─ 房间表                           │
│  ├─ 房间分配表         │ ├─ 禅堂配置表                       │
│  ├─ 同伴关系表         │ ├─ 分配方案表                       │
│  └─ 变更日志表         │ └─ 导出记录表                       │
└─────────────────────────────────────────────────────────────┘
```

### 模块划分

| 模块 | 职责 | 依赖 |
|------|------|------|
| **学员管理模块** | CRUD学员信息，批量导入，同伴关系识别 | 数据库 |
| **房间配置模块** | CRUD房间信息，预留房间管理，房间分类 | 数据库 |
| **分配算法模块** | 核心分配逻辑，优先级处理，同伴保护，打乱算法 | 学员模块、房间模块 |
| **禅堂座位模块** | 座位布局计算，编号方式处理，座位分配 | 分配算法模块 |
| **审核与调整模块** | 提供UI与数据接口，支持实时修改与预览 | 分配算法、禅堂座位 |
| **报表生成模块** | 生成各类输出表格，支持多种格式导出 | 学员模块、分配结果 |
| **数据导入导出模块** | 处理多种输入格式，导出为Excel/PDF/CSV | 数据库 |

---

## 数据模型

### 核心实体

#### 0. 禅修中心 (Center)

```
id (PK)                    : UUID
center_name                : String (中心名称) *必填、唯一
address                    : String (地址)
contact_phone              : String (联系电话)
contact_person             : String (联系人)
center_description         : String (中心简介)
status                     : Enum (运营中/暂停/已关闭)
notes                      : String (备注)
created_at                 : Timestamp
updated_at                 : Timestamp
```

**业务规则**：
- 每个禅修中心的房间、禅堂、课程期次都是独立的
- 中心名称在全系统内唯一
- 中心一旦创建，所有后续资源都关联到该中心

---

#### 1. 学员 (Student)

```
id (PK)                    : UUID
student_number             : String (学号)
name                       : String (姓名) *必填
id_card                    : String (身份证)
age                        : Integer (年龄)
gender                     : Enum (M男众/F女众) *新增 *必填
age_group                  : String (年龄分段，如"18-30"、"30-40"等) *新增 *计算字段
city                       : String (城市)
phone                      : String (电话)
study_times                : Integer (修学次数，默认0) *关键字段，表示总的修学参课次数
course_10day_times         : Integer (10日课程参修次数)
course_4mindfulness_times  : Integer (四念住课程参修次数)
course_20day_times         : Integer (20日课程参修次数)
course_30day_times         : Integer (30日课程参修次数)
course_45day_times         : Integer (45日课程参修次数)
service_times              : Integer (服务次数)
special_notes              : String (特殊需求)
fellow_list                : String (同伴名单，逗号分隔)
fellow_group_id            : Integer (同伴组编号)
category                   : Enum (法师/旧生/新生) *计算字段
priority                   : Integer (优先级，1=最高) *计算字段
room_assignment            : FK(RoomAssignment)
created_at                 : Timestamp
updated_at                 : Timestamp
```

**计算规则**：
```
category =
  if 姓名包含"法" then "法师"
  else if study_times > 0 then "旧生"
  else "新生"

priority =
  if category == "法师" then 1
  else if category == "旧生" then 2
  else 3
```

---

#### 2. 房间 (Room)

```
id (PK)                    : UUID
center_id                  : FK(Center) (所属禅修中心) *必填
room_number                : String (房号，如B101、A112) *必填
building                   : String (楼号，如B、A)
floor                      : Integer (楼层)
capacity                   : Integer (容量，1或2) *必填
room_type                  : Enum (法师房/旧生房/新生房/其他) *必填
status                     : Enum (启用/禁用/维修中)
is_reserved                : Boolean (是否预留，默认false)
reserved_for               : String (预留用途，如"法工房"、"讲师房")
special_tag                : String (特殊标签)
notes                      : String (备注)
created_at                 : Timestamp
updated_at                 : Timestamp
```

**唯一约束**：
- (center_id, room_number) - 同一中心内房号唯一

**索引**：
- (center_id, room_type)
- (center_id, status)
- room_type
- status

---

#### 3. 床位 (Bed)

```
id (PK)                    : UUID
room_id (FK)               : FK(Room)
bed_number                 : Integer (房间内床号，1或2)
bed_code                   : String (唯一床号，如B101-1) *虚拟字段
position                   : Enum (下铺/上铺)
status                     : Enum (可用/不可用/维修中)
created_at                 : Timestamp
updated_at                 : Timestamp
```

**唯一约束**: (room_id, bed_number)

---

#### 4. 房间分配方案 (AllocationScheme)

```
id (PK)                    : UUID
session_id                 : FK(Session)
student_id (FK)            : FK(Student)
bed_id (FK)                : FK(Bed)
allocation_type            : Enum (自动/手工调整/冲突解决)
allocation_reason          : String (分配原因，如"法师优先"、"旧生旧生")
bed_code                   : String (床号代码，如B101-1) *虚拟字段
is_temporary               : Boolean (是否临时分配，默认true)
conflict_flag              : Boolean (是否有冲突)
conflict_reason            : String (冲突原因)
created_at                 : Timestamp
updated_at                 : Timestamp
```

**索引**：
- session_id
- student_id
- is_temporary

---

#### 5. 课程期次 (Session)

```
id (PK)                    : UUID
center_id                  : FK(Center) (所属禅修中心) *必填
session_code               : String (期次代码，如2025-Spring-20day) *必填
course_type                : Enum (10日课/四念住课/20日课/30日课/45日课) *课程类型
start_date                 : Date
end_date                   : Date
expected_students          : Integer (预期学员数)
status                     : Enum (规划中/分配中/已完成/已进行/已结束)
allocation_finalized_at    : Timestamp (分配确认时间)
notes                      : String (期次说明)
created_at                 : Timestamp
updated_at                 : Timestamp
```

**唯一约束**：
- (center_id, session_code) - 同一中心内期次代码唯一

---

#### 6. 禅堂配置 (MeditationHallConfig)

```
id (PK)                    : UUID
center_id                  : FK(Center) (所属禅修中心) *必填
session_id                 : FK(Session) (关联课程期次)
hall_name                  : String (禅堂名称，如"A区"、"B区")
region_name                : String (区域名称，对应A、B等) *新增
region_code                : String (区域代码，如"A"、"B") *新增
valid_area                 : String (有效座位范围，如A5:E20)
begin_cell                 : String (起始单元格，如D5)
row_offset                 : Integer (行偏移)
col_offset                 : Integer (列偏移)
max_rows                   : Integer (最大行数)
max_cols                   : Integer (最大列数)
region_width               : Integer (区域宽度/列数，如4或10) *新增
region_rows                : Integer (区域行数，0=自动计算) *新增
used_rows                  : Integer (实际使用行数，0=自动计算)
used_cols                  : Integer (实际使用列数)
is_auto_width              : Boolean (宽度是否自动计算，默认false) *新增
is_auto_rows               : Boolean (行数是否自动计算，默认true) *新增
numbering_type             : Enum (顺序/奇数/偶数)
seat_number_prefix         : String (座位号前缀，如"A"、"B")
gender_separated           : Boolean (是否需要性别分离，默认false) *新增
gender_type                : Enum (F女众/M男众/mixed混合) *新增
monk_start_cell            : String (法师座位起始)
monk_max_count             : Integer (法师最大数)
monk_seat_prefix           : String (法师座位号前缀)
old_student_reserved_list  : String (旧生保留席位列表)
dhamma_worker_area1        : String (法工1座位范围)
dhamma_worker_area2        : String (法工2座位范围)
created_at                 : Timestamp
updated_at                 : Timestamp
```

---

#### 7. 禅堂座位分配 (MeditationSeatAllocation)

```
id (PK)                    : UUID
session_id                 : FK(Session)
hall_id                    : FK(MeditationHallConfig)
seat_number                : String (座位号，如"1"、"2"、"3") *必填
student_id                 : FK(Student)
bed_code                   : String (房号-床号，如B101-1)
seat_type                  : Enum (法师座/学员座/法工座)
is_old_student             : Boolean (是否旧生)
age_group                  : String (年龄分段，如"18-30"、"30-40"等) *新增
gender                     : Enum (M男众/F女众) *新增
region_code                : String (所属区域，如"A"、"B") *新增
row_index                  : Integer (座位所在行)
col_index                  : Integer (座位所在列)
row_position               : Integer (在性别分组内的行位置) *新增
col_position               : Integer (在性别分组内的列位置) *新增
is_with_companion          : Boolean (是否有同伴) *新增
companion_seat_id          : UUID (同伴座位ID) *新增
created_at                 : Timestamp
updated_at                 : Timestamp
```

**索引**：
- (session_id, hall_id, seat_number) - 唯一
- (session_id, gender, region_code) - 用于性别分离查询
- (student_id, session_id) - 用于学员座位查询

---

#### 8. 同伴关系 (FellowRelation)

```
id (PK)                    : UUID
session_id                 : FK(Session)
fellow_group_id            : Integer (同伴组编号)
primary_student_id         : FK(Student) (指定同伴的学员)
related_students           : Array<UUID> (同伴学员ID列表)
separation_flag            : Boolean (是否被分离，默认false)
separation_reason          : String (分离原因，如"不同禅堂")
created_at                 : Timestamp
updated_at                 : Timestamp
```

---

### 关键计算字段

#### 学员优先级顺序

```
法师 (前ProStuCount个学员)
  ↓ (按修学次数降序)
非法师旧生 (中间NonProOldStuCount个学员)
  ↓ (按总修学次数降序)
非法师新生 (后面学员)
  ↓ (按年龄降序)
```

---

## 功能模块

### 模块1: 学员管理

#### 功能1.1: 学员列表查看

**场景**: 管理员查看当前期次的所有学员

**用户故事**:
> 作为排床专员，我想看到所有已注册学员的信息，包括姓名、修学次数、年龄等，以便理解学员构成。

**功能需求**:
- 表格显示所有学员（分页，每页50条）
- 支持按姓名、身份证、修学次数搜索
- 支持按优先级、修学属性排序
- 显示同伴标记（同一组的学员用相同颜色高亮）
- 显示分配状态（未分配/已分配/已调整）

**UI元素**:
```
[搜索框] [排序下拉] [导出] [导入]
┌─────────────────────────────────┐
│ 姓名  │ 修学次数 │ 年龄 │ 同伴 │ ...│
├─────────────────────────────────┤
│法*玲  │   15    │ 52 │ 法*梅│[管理]
│李*宏  │    2    │ 38 │ 王*红│[管理]
│王*红  │    2    │ 36 │ 李*宏│[管理]
└─────────────────────────────────┘
```

---

#### 功能1.2: 学员信息编辑

**场景**: 管理员修正学员信息或添加特殊需求

**用户故事**:
> 作为排床专员，我想编辑学员的年龄、城市等信息，或添加特殊需求（如"需要靠近卫生间"），以便分配时考虑。

**功能需求**:
- 支持编辑学员的所有字段（除学号和姓名外）
- 编辑时自动重新计算优先级和分类
- 变更历史可追踪
- 支持批量编辑（如批量导入修学次数更新）

**业务规则**:
- 同伴名单修改后，自动识别和更新同伴关系（fellowIndex）

---

#### 功能1.3: 同伴关系管理

**场景**: 标记和管理想要同住的学员

**用户故事**:
> 作为排床专员，我想能够看到哪些学员希望同住，系统自动将他们标记为同一组。

**功能需求**:
- 显示同伴关系图（学员与其同伴的关系）
- 支持手工添加/删除同伴关系
- 自动识别同伴关系传递性（A的同伴是B，B的同伴是C，则A、B、C为同一组）
- 在分配时标记"同伴分离冲突"

**算法** (CheckFriend):
```
for each 学员A:
  if A的同伴列表非空:
    for each 学员B in A的同伴列表:
      if A.fellowIndex > 0:
        B.fellowIndex = A.fellowIndex
      else if B.fellowIndex > 0:
        A.fellowIndex = B.fellowIndex
      else:
        创建新的 fellowIndex
```

---

#### 功能1.4: 数据导入

**场景**: 批量导入学员信息

**用户故事**:
> 作为管理员，我想批量导入学员注册数据（来自报名系统的Excel或CSV），而不是手工逐个输入。

**功能需求**:
- 支持CSV、Excel格式导入
- 自动映射列到学员字段
- 显示导入预览和验证结果
- 支持"覆盖"或"追加"模式
- 错误提示和日志记录

**导入数据格式示例**:
```
学号,姓名,身份证,年龄,城市,电话,修学次数,10日课,四念住课,20日课,30日课,45日课,服务次数,同伴,特殊需求
1,法玲,1234567890,52,杭州,13800000001,15,2,1,3,2,1,0,法梅,
2,李宏,1234567891,38,北京,13800000002,2,0,0,1,1,0,0,王红,
3,王红,1234567892,36,北京,13800000003,2,1,0,1,0,0,0,李宏,靠近卫生间
```

---

### 模块2: 房间配置

#### 功能2.1: 房间信息维护

**场景**: 配置禅修中心的房间基础数据

**用户故事**:
> 作为管理员，我想管理禅修中心的房间信息（房号、容量、楼层等），以便系统在分配时引用。

**功能需求**:
- 房间列表展示（支持按楼号、房间类型筛选）
- 支持新增、编辑、删除房间
- 房间编辑时验证房号唯一性
- 支持批量导入房间配置（从上一期复制）
- 房间状态管理（启用/禁用/维修中）

**房间表示法**:
```
B101, B102, B103, B104, B105, ..., B311 (女众楼)
A111, A112, A113, ..., A319 (男众楼)
```

**房间分类示例**:
```
法师房: B101-B107, A111-A113
旧生房: B108-B111, A215-A223
新生房: B201-B214, A312-A319
```

---

#### 功能2.2: 房间容量编辑

**场景**: 调整房间的单双人配置

**用户故事**:
> 作为管理员，我想能够标记哪些房间是单人房，哪些是双人房，以便分配算法知道该房间能容纳多少人。

**功能需求**:
- 为每个房间设置容量（1或2）
- 支持批量修改容量
- 修改后显示提示（如"该配置会影响已分配学员"）

---

#### 功能2.3: 预留房间管理

**场景**: 标记特殊预留房间

**用户故事**:
> 作为管理员，我想标记某些房间为预留（如法工房、讲师房），使其在自动分配时被排除或特殊处理。

**功能需求**:
- 支持标记房间为"预留"
- 预留房间在分配界面显示为灰色/锁定状态
- 预留房间可指定预留用途（自由文本）
- 在最终报表中标记预留信息

---

### 模块3: 分配算法

#### 功能3.1: 自动分配

**场景**: 根据学员优先级和房间类型，自动生成分配方案

**用户故事**:
> 作为排床专员，我想一键生成自动分配方案，而不是手工逐个分配，以节省时间。

**功能需求**:
- 一键触发自动分配
- 显示分配过程日志（分配了多少法师、多少旧生等）
- 自动识别冲突和警告（如同伴分离、房间超额）
- 支持"重新分配"（丢弃之前的方案）

**分配流程**:

```
1. 输入验证
   ✓ 检查学员数据完整性
   ✓ 检查房间配置完整性

2. 学员预处理
   ✓ 识别法师、旧生、新生
   ✓ 识别同伴关系（fellowIndex）
   ✓ 排序学员（优先级排序）

3. 分配策略
   for each 优先级 in [法师, 非法师旧生, 非法师新生, 年长新生]:
     for each 学员 in 该优先级:
       获取可用房间列表（按类型）
       打乱房间内的床位顺序
       for each 可用床位:
         if 同伴已分配:
           尝试与同伴同房
         分配学员到该床位
         标记床位为已使用
         break

4. 冲突检测
   ✓ 检查同伴分离
   ✓ 检查房间超额
   ✓ 检查预留房间被占用

5. 返回分配方案
```

**关键算法: DisruptBed()**
```
输入: 房间列表 (如["B101", "B102", "B103"])
输出: 打乱后的床位列表

for each 房间:
  获取该房间的所有床位 (如B101-1, B101-2)
  随机打乱顺序
  添加到输出列表
```

---

#### 功能3.2: 分配验证与冲突检测

**场景**: 检测分配结果的问题

**用户故事**:
> 作为排床专员，我想在分配完成后看到所有的冲突和警告，以便进行手工调整。

**功能需求**:
- 显示冲突列表（同伴分离、房间超额等）
- 为每个冲突提供建议解决方案
- 支持按冲突严重程度排序（错误/警告/提示）

**冲突类型**:
```
ERROR:
  - 房间超额：分配人数 > 房间容量
  - 无可用床位：超过房间总容量

WARNING:
  - 同伴分离：同伴被分配到不同房间
  - 预留房间被占用：分配到了预留房间

INFO:
  - 学员无分配：未分配到任何房间
```

---

#### 功能3.3: 同伴保护机制

**场景**: 处理同伴关系

**用户故事**:
> 作为排床专员，我想确保希望同住的学员尽量被分配到同一房间，如果无法同房则进行特殊标记。

**功能需求**:
- 在分配时，同伴优先分配到同一房间
- 如果同伴无法同房，检查是否可以调换其他学员
- 标记为"同伴分离"，等待人工审核

**同伴调整策略** (SplitFellow):
```
if 同伴A和B在不同禅堂:
  尝试将B替换为禅堂内的其他学员
  择优原则：
    - 如果A和B都是旧生：找修学次数接近的学员交换
    - 如果A是旧生、B是新生：找年龄接近的学员交换
```

---

### 模块4: 禅堂座位管理

#### 功能4.1: 禅堂配置

**场景**: 配置禅堂的座位布局和编号规则

**用户故事**:
> 作为管理员，我想配置禅堂的座位布局（如A区、B区），包括起始位置、行列数、编号方式等，以便系统自动生成座位表。

**功能需求**:
- 配置禅堂基本信息（名称、有效范围）
- 配置座位起始位置和偏移
- 配置座位编号方式（顺序/奇数/偶数）
- 配置法师座位位置和数量
- 配置旧生保留席位列表
- 配置法工座位范围

**配置表示法**:
```
禅堂A区:
  有效范围: A5:E20
  起始单元格: D5
  行偏移: 1, 列偏移: 1
  最大行: 10, 最大列: 5
  编号方式: 奇数 (1,3,5,...)
  座位号前缀: A

禅堂B区:
  有效范围: A22:E37
  起始单元格: D22
  行偏移: 1, 列偏移: 1
  最大行: 10, 最大列: 5
  编号方式: 偶数 (2,4,6,...)
  座位号前缀: B
```

---

#### 功能4.2: 禅堂座位自动生成

**场景**: 根据房间分配方案，自动生成禅堂座位表

**用户故事**:
> 作为排床专员，我完成房间分配后，系统应该自动生成禅堂座位表，显示每个座位号对应的学员房号-床号。

**功能需求**:
- 一键生成禅堂座位表
- 显示生成过程和统计信息（法师座位数、学员座位数、法工座位数）
- 支持多个禅堂（A区、B区）同时生成
- 显示座位与房号-床号的绑定关系

**座位生成算法** (setMedHall):

```
1. 清空座位区域

2. 计算座位布局
   if UsedRow == 0 (自动):
     CHANCOLS = UsedCol 或 MaxCol
     CHANROWS = ceil(非法师人数 / CHANCOLS)
   else (手动):
     CHANROWS = UsedRow
     CHANCOLS = ceil(非法师人数 / CHANROWS)

3. 分配法师座位
   from ProStart, 按 RowOffset 间距
   编号: StuNunHead_Pro + "1", "2", ...

4. 分配学员座位
   双层循环: for row in 1..CHANROWS:
            for col in 1..CHANCOLS:

   按编号方式：
   if NumType == 0 (顺序):
     座位号 = i (1,2,3,4,...)
   if NumType == 1 (奇数):
     座位号 = i*2-1 (1,3,5,7,...)
   if NumType == 2 (偶数):
     座位号 = i*2 (2,4,6,8,...)

   座位内容 = 学员的房号-床号

5. 处理同伴关系
   if 同伴在不同禅堂:
     标记为"同伴分离"
     尝试调换学员以保持同伴关系
```

---

#### 功能4.3: 禅堂座位预览

**场景**: 预览禅堂座位表的布局

**用户故事**:
> 作为管理员，我想在最终确认前预览禅堂座位的实际布局（座位号、房号-床号等），以便检查是否正确。

**功能需求**:
- 以表格形式展示座位布局
- 突出显示法师座位、法工座位、旧生座位
- 支持按座位号排序或按房号排序
- 实时更新（修改分配方案后立即更新）

---

### 模块5: 人工审核与调整

#### 功能5.1: 分配结果审核

**场景**: 审核自动分配方案，发现问题

**用户故事**:
> 作为排床专员，我想看到自动分配的结果，并检查是否有问题需要手工调整。

**功能需求**:
- 显示分配方案的统计信息（法师XX人、旧生XX人、新生XX人）
- 显示冲突警告列表
- 支持按不同维度查看（按学员、按房间、按禅堂）
- 一键导出当前分配方案为Excel

**审核视图**:
```
┌─ 分配统计 ────────────────────┐
│ 总人数: 100 | 法师: 5 | 旧生: 25 | 新生: 70
│ 法师房: 5/5 | 旧生房: 25/30 | 新生房: 70/80
└───────────────────────────────┘

┌─ 冲突警告 ────────────────────┐
│ 同伴分离 (3): 王红-李宏, ...
│ 房间超额 (0):
│ 无分配 (0):
└───────────────────────────────┘
```

---

#### 功能5.2: 房间分配手工调整

**场景**: 修改学员的房间分配

**用户故事**:
> 作为排床专员，我想手工调整某个学员的房间分配（如将学员A从B101换到B102，或将两个学员交换房间），以解决分配冲突或满足特殊需求。

**功能需求**:
- 支持选择学员后修改其房间分配
- 支持两个学员之间的房间交换
- 修改后实时更新禅堂座位
- 支持撤销和恢复操作
- 标记"手工调整"以便追踪

**调整操作**:
```
操作1: 重新分配单个学员
  选择学员 → 选择目标房间/床位 → 确认 → 更新

操作2: 交换两个学员
  选择学员A → 选择学员B → 交换 → 确认 → 更新

操作3: 批量调整
  选择多个学员 → 移动到目标房间 → 确认 → 更新
```

---

#### 功能5.3: 禅堂座位手工调整

**场景**: 修改禅堂座位分配

**用户故事**:
> 作为管理员，我想在禅堂座位表中进行调整（如交换两个座位、调整座位号等），以满足特殊需求。

**功能需求**:
- 支持在座位表上直接拖拽修改
- 支持修改座位号
- 修改后自动更新房间-座位的映射关系
- 实时验证修改的合法性（如防止座位号重复）

---

#### 功能5.4: 变更历史与审计

**场景**: 追踪所有的修改记录

**用户故事**:
> 作为管理员，我想查看谁在什么时间修改了什么内容，以便追踪问题和维护数据完整性。

**功能需求**:
- 记录所有修改操作（操作人、操作时间、操作内容、变更前后对比）
- 支持按日期、操作人、操作类型筛选
- 支持恢复到历史某个版本
- 导出审计日志

---

### 模块6: 报表生成与导出

#### 功能6.1: 最终床位分配表

**场景**: 生成正式的床位分配表供打印

**用户故事**:
> 作为管理员，我想生成一份正式的床位分配表（房号-床号与学员信息的对应表），用于贴在各房间门口或发给学员。

**功能需求**:
- 生成标准格式的床位分配表
- 按房号排序，显示房号、床号、学员姓名、身份证、年龄、修学属性等
- 支持按楼号、性别分页
- 支持打印和导出为PDF/Excel

**表格格式**:
```
女众房间分配表
房号  | 床号 | 姓名  | 身份证       | 年龄 | 修学属性
------|------|-------|-----------|------|-------
B101  | 1    | 法玲  | 110000000 | 52   | 法师
B101  | 2    | 李宏  | 110000001 | 38   | 旧生
B102  | 1    | 王红  | 110000002 | 36   | 旧生
```

---

#### 功能6.2: 禅堂座位表

**场景**: 生成正式的禅堂座位表

**用户故事**:
> 作为管理员，我想生成禅堂座位表（座位号与房号-床号、学员姓名的对应表），用于禅堂参考。

**功能需求**:
- 生成禅堂座位表（包含A区、B区的座位分配）
- 显示座位号、房号-床号、学员姓名
- 特殊标记（法师座位用[M]、旧生座位用[O]、法工座位用[D]）
- 支持打印和导出为PDF/Excel

**表格格式**:
```
禅堂A区座位表
座位号 | 房号-床号 | 姓名  | 备注
-------|----------|-------|-------
1[M]   | -        | 法玲  | 法师
3      | B101-1   | 李宏  | 旧生
5      | B101-2   | 王红  | 旧生
7      | B102-1   | 张三  | 新生
```

---

#### 功能6.3: 统计与总结表

**场景**: 生成各类统计和总结报表

**用户故事**:
> 作为管理员，我想看到各类统计信息（如法师人数、旧生人数、房间占用率等），以便了解分配情况。

**功能需求**:
- 生成统计摘要（总人数、法师数、旧生数、新生数）
- 生成房间占用统计（房间数、占用率、平均入住人数）
- 生成禅堂座位统计（法师座位数、学员座位数、法工座位数）
- 生成同伴分离警告统计

---

#### 功能6.4: 多格式导出

**场景**: 将报表导出为不同格式

**用户故事**:
> 作为管理员，我想将报表导出为Excel或PDF格式，以便进一步编辑或分享。

**功能需求**:
- 支持导出为Excel（.xlsx）
- 支持导出为PDF（带格式化）
- 支持导出为CSV（用于数据分析）
- 导出时保留格式和颜色

**导出选项**:
```
┌─ 导出报表 ─────────────────┐
│ □ 床位分配表
│ □ 禅堂座位表 (A区)
│ □ 禅堂座位表 (B区)
│ □ 法工座位表
│ □ 统计摘要
│
│ 格式: [Excel] [PDF] [CSV]
│ [导出]
└────────────────────────────┘
```

---

### 模块7: 数据导入导出

#### 功能7.1: 学员数据导入

（已在功能1.4中详细描述）

#### 功能7.2: 房间配置导入

**场景**: 批量导入房间配置

**用户故事**:
> 作为管理员，我想从上一期的房间配置导入本期的配置，以节省时间。

**功能需求**:
- 支持从历史期次复制房间配置
- 支持上传Excel文件导入房间信息
- 支持验证和预览导入结果

---

#### 功能7.3: 分配方案导出与备份

**场景**: 备份和分享分配方案

**用户故事**:
> 作为管理员，我想备份当前的分配方案，以便后续恢复或对比。

**功能需求**:
- 支持导出分配方案为JSON或Excel
- 支持从JSON导入分配方案恢复
- 自动定期备份（每次操作后）
- 显示备份版本列表和时间戳

---

## 业务流程

### 完整工作流

```
┌─────────────────────────────────────────────────────────────┐
│ 步骤1: 课程期次创建                                           │
│ 管理员创建新的课程期次（如2025-春季-20日课）                 │
│ 配置期次基本信息、禅堂参数、房间分类、性别分离等             │
└────────────────┬────────────────────────────────────────────┘
                 ↓
┌─────────────────────────────────────────────────────────────┐
│ 步骤2: 学员导入                                               │
│ 批量导入学员注册数据（CSV或Excel），包含性别和年龄信息       │
│ 系统自动识别法师、旧生、新生，计算优先级、年龄分段          │
│ 识别同伴关系，标记特殊需求                                   │
└────────────────┬────────────────────────────────────────────┘
                 ↓
┌─────────────────────────────────────────────────────────────┐
│ 步骤3: 学员信息审核与调整                                     │
│ 排床专员检查学员信息是否完整和正确                           │
│ 修正错误的性别、年龄、修学次数、同伴关系等                   │
└────────────────┬────────────────────────────────────────────┘
                 ↓
┌─────────────────────────────────────────────────────────────┐
│ 步骤4: 自动房间分配（考虑性别分离和年龄分段）                │
│                                                              │
│ 若为双性课程：                                               │
│   ├─ 按性别分流（女众和男众分别处理）                        │
│   │  ├─ 女众流程:                                            │
│   │  │   学员表 → 过滤女众 → 排序 → 分配女众房间 →         │
│   │  │   女众房间分配结果                                     │
│   │  ├─ 男众流程:                                            │
│   │  │   学员表 → 过滤男众 → 排序 → 分配男众房间 →         │
│   │  │   男众房间分配结果                                     │
│   │  └─ 合并结果                                             │
│                                                              │
│ 同性别内部排序考虑：                                         │
│   ├─ 优先级：法师 > 旧生 > 新生                              │
│   ├─ 修学次数：按降序（旧生和新生内部）                      │
│   └─ 年龄分段：18-30、30-40、40-55、60+ 等                 │
│                                                              │
│ 系统生成临时分配方案，显示冲突和警告                         │
└────────────────┬────────────────────────────────────────────┘
                 ↓
┌─────────────────────────────────────────────────────────────┐
│ 步骤5: 分配结果审核与手工调整                                 │
│ 排床专员检查分配结果，处理冲突和特殊需求                     │
│ 手工修改个别学员的房间分配，解决同伴分离等问题               │
│ 标记所有调整，生成调整日志                                   │
└────────────────┬────────────────────────────────────────────┘
                 ↓
┌─────────────────────────────────────────────────────────────┐
│ 步骤6: 禅堂座位自动生成（考虑性别和年龄分段布局）            │
│                                                              │
│ 若需要性别分离：                                             │
│   ├─ 女众禅堂座位表（按布局规则分配）                        │
│   │  ├─ 法师座位（最顶端）                                   │
│   │  ├─ 旧生座位（中间偏左和左）                            │
│   │  └─ 新生座位（按年龄分段：18-30 > 30-40 > 40-55）    │
│   ├─ 男众禅堂座位表（按布局规则分配）                        │
│   │  ├─ 法师座位（最顶端）                                   │
│   │  ├─ 旧生座位（中间和靠后）                              │
│   │  └─ 新生座位（按年龄分段：40-55 > 30-40 > 18-30）   │
│   └─ 生成最终的座位表，显示座位号与房号-床号的绑定          │
│                                                              │
│ 处理同伴关系和特殊座位（标记分离情况）                       │
└────────────────┬────────────────────────────────────────────┘
                 ↓
┌─────────────────────────────────────────────────────────────┐
│ 步骤7: 禅堂座位审核与调整                                     │
│ 管理员检查禅堂座位布局（女众区和男众区分别审核）             │
│ 如有需要，手工调整座位（如交换座位、调整编号等）             │
└────────────────┬────────────────────────────────────────────┘
                 ↓
┌─────────────────────────────────────────────────────────────┐
│ 步骤8: 最终确认与锁定                                         │
│ 管理员确认所有分配已正确                                     │
│ 将分配方案标记为"已确认"，锁定进一步修改                     │
└────────────────┬────────────────────────────────────────────┘
                 ↓
┌─────────────────────────────────────────────────────────────┐
│ 步骤9: 报表生成与导出                                         │
│ 生成最终的床位分配表（按性别分页）                           │
│ 生成禅堂座位表（按区域分页）                                 │
│ 导出为PDF或Excel，分发给各部门                               │
│ 备份分配方案                                                 │
└────────────────┬────────────────────────────────────────────┘
                 ↓
┌─────────────────────────────────────────────────────────────┐
│ 步骤10: 数据交付                                              │
│ 将最终数据导出供其他系统使用                                 │
│ （如通知系统、报到系统等）                                   │
└─────────────────────────────────────────────────────────────┘
```

---

### 人工审核流程

```
┌─ 审核决策 ──────────────────────────────┐
│ 发现冲突或问题                          │
├─────────────────────────────────────┤
│ 冲突类型        │ 处理方式              │
├─────────────────────────────────────┤
│ 同伴分离        │ 交换学员，重新分配   │
│ 房间超额        │ 移动学员到其他房间   │
│ 特殊需求        │ 手工分配到合适房间   │
│ 优先级冲突      │ 考虑整体均衡，调整   │
└─────────────────────────────────────┘
```

---

## UI/UX设计要求

### 总体设计原则

1. **简洁高效**: 减少操作步骤，快速完成分配和调整
2. **实时反馈**: 修改后立即显示结果和影响
3. **可视化**: 用表格、图表、颜色标记等方式展示数据
4. **容错性**: 支持撤销和恢复，防止误操作

### 关键页面设计

#### 页面1: 仪表盘

```
┌─────────────────────────────────────────────┐
│ 禅修中心智能排床系统                         │
├─────────────────────────────────────────────┤
│                                              │
│ 当前期次: 2025年春季20日课 | 开始: 2025-03-01
│ 期次状态: 分配中 | 进度: 60%                │
│                                              │
├─────────────────────────────────────────────┤
│  [快速操作]                                  │
│  ┌──────────┐ ┌──────────┐ ┌──────────┐   │
│  │ 导入学员 │ │ 自动分配 │ │ 查看结果 │   │
│  └──────────┘ └──────────┘ └──────────┘   │
│                                              │
├─────────────────────────────────────────────┤
│  [关键指标]                                  │
│  ┌─────────────────────────────────────┐   │
│  │ 总学员: 100  │ 法师: 5  │ 旧生: 30  │  │
│  │ 新生: 65     │ 已分配: 95 │ 未分配: 5 │  │
│  │ 冲突: 3      │ 房间占用: 95/100     │  │
│  └─────────────────────────────────────┘   │
│                                              │
├─────────────────────────────────────────────┤
│  [最近操作]                                  │
│  • 2025-10-31 10:30 - 自动分配完成          │
│  • 2025-10-31 10:15 - 导入100名学员         │
│  • 2025-10-31 09:45 - 创建新期次             │
│                                              │
└─────────────────────────────────────────────┘
```

#### 页面2: 学员列表

```
┌──────────────────────────────────────────────────┐
│ 学员管理 - 2025年春季20日课                      │
├──────────────────────────────────────────────────┤
│  [搜索]___________  [按优先级▼]  [导出]  [导入] │
├──────────────────────────────────────────────────┤
│ │姓名  │修学│年龄│优先级 │同伴│分配状态  │操作│
├──────────────────────────────────────────────────┤
│ │法玲  │15  │52  │法师   │-  │B101-1   │编辑│
│ │李宏  │2   │38  │旧生   │王红│B102-1  │编辑│
│ │王红  │2   │36  │旧生   │李宏│B102-2  │编辑│
│ │张三  │0   │28  │新生   │-  │B103-1  │编辑│
│ │未分配│    │    │       │   │        │编辑│
├──────────────────────────────────────────────────┤
│ 显示 1-50 / 100 页码 [1] [2] [下一页]             │
└──────────────────────────────────────────────────┘
```

#### 页面3: 分配结果审核

```
┌──────────────────────────────────────────────────┐
│ 分配结果审核                                     │
├──────────────────────────────────────────────────┤
│  统计信息                   │ 冲突警告              │
│  ────────────────────────  │ ──────────────────  │
│  总人数: 100                │ 同伴分离 (3)         │
│  法师: 5                    │  • 王红 - 李宏      │
│  旧生: 30                   │  • 张三 - 李四      │
│  新生: 65                   │  • 王五 - 赵六      │
│  已分配: 95                 │                     │
│  未分配: 5                  │ 房间超额 (0)        │
│                             │                     │
│ [接受分配] [修改分配] [重新分配]                  │
└──────────────────────────────────────────────────┘
```

#### 页面4: 房间分配详情

```
┌──────────────────────────────────────────────────┐
│ 房间分配详情 - 女众楼                             │
├──────────────────────────────────────────────────┤
│  [楼号▼: 女众楼] [排序: 按房号]                   │
├──────────────────────────────────────────────────┤
│ 房号 │容量│床1      │床2      │占用│操作          │
├──────────────────────────────────────────────────┤
│ B101 │2   │法玲     │李宏     │2/2 │[调整]       │
│ B102 │2   │王红     │张三     │2/2 │[调整]       │
│ B103 │1   │李四     │-        │1/1 │[调整]       │
│ B104 │2   │-        │-        │0/2 │[分配]       │
├──────────────────────────────────────────────────┤
│ 显示 1-20 / 50 页码 [1] [2] [3] [下一页]          │
└──────────────────────────────────────────────────┘
```

#### 页面5: 禅堂座位表预览

```
┌──────────────────────────────────────────────────┐
│ 禅堂座位表 - A区                                  │
├──────────────────────────────────────────────────┤
│         列1      列2      列3      列4      列5     │
├──────────────────────────────────────────────────┤
│ 行1  │ 1[M]法玲│ 2      │ 3李宏  │ 4      │ 5王红  │
│      │ B101   │        │ B101   │        │ B102  │
├──────────────────────────────────────────────────┤
│ 行2  │ 7张三  │ 8[O]   │ 9李四  │ 10     │ 11    │
│      │ B103   │ B104   │ B105   │        │       │
├──────────────────────────────────────────────────┤
│ 行3  │        │        │        │        │       │
│      │        │        │        │        │       │
│...                                              │
├──────────────────────────────────────────────────┤
│ [编辑] [刷新] [导出] [打印预览]                  │
└──────────────────────────────────────────────────┘
```

---

## 非功能性需求

### 性能需求

- **页面加载时间**: < 3秒
- **列表操作**: 支持10000条学员数据，保持流畅
- **分配算法**: 100名学员的分配应在10秒内完成
- **搜索响应**: < 1秒
- **并发用户**: 支持10个并发用户

### 可靠性需求

- **系统可用性**: >= 99%
- **数据备份**: 每天自动备份，支持30天历史恢复
- **故障恢复**: 故障恢复时间 < 1小时

### 安全需求

- **身份认证**: 支持用户登录（用户名/密码 或 OAuth）
- **访问控制**: 基于角色的访问控制（RBAC）
  - 管理员: 全部操作
  - 排床专员: 导入、分配、审核、导出
  - 查看员: 仅查看报表
- **数据加密**: 敏感数据（身份证等）加密存储
- **审计日志**: 所有操作记录不可修改

### 易用性需求

- **用户培训**: 提供系统使用指南和教程视频
- **在线帮助**: 每个页面提供上下文帮助
- **错误提示**: 清晰的中文错误提示和解决建议

### 可维护性需求

- **代码质量**: 遵循编码规范，代码覆盖率 > 80%
- **文档完整**: 包括API文档、部署指南、故障排查指南
- **日志详细**: 记录关键操作和错误信息，便于问题排查

---

## 技术栈建议

### 前端

- **框架**: React 18+ 或 Vue 3+
- **状态管理**: Redux / Vuex / Pinia
- **UI组件库**: Ant Design / Element UI
- **图表库**: ECharts 或 Chart.js（用于统计展示）
- **表格**: TanStack Table（React）或 Element Table（Vue）
- **导出**: xlsx（Excel）、jsPDF（PDF）
- **构建工具**: Vite

### 后端

- **语言**: Node.js (Express/Fastify) 或 Python (FastAPI/Django)
- **数据库**: PostgreSQL (推荐) 或 MySQL
- **ORM**: Sequelize / TypeORM (Node) 或 SQLAlchemy (Python)
- **API**: REST + 可选的GraphQL
- **任务队列**: Bull (Node) 或 Celery (Python)，用于异步导出
- **缓存**: Redis，缓存学员列表、房间配置等
- **文件处理**: multer (Node) 或 python-multipart，处理导入文件

### 部署

- **容器化**: Docker + Docker Compose
- **编排**: Kubernetes (可选，如需高可用)
- **CI/CD**: GitHub Actions / GitLab CI
- **监控**: Prometheus + Grafana
- **日志**: ELK Stack 或 Loki

### 开发工具

- **版本控制**: Git + GitHub/GitLab
- **代码检查**: ESLint (JS) / Pylint (Python)
- **测试**: Jest (前端) / Pytest (后端)
- **API文档**: Swagger / OpenAPI

---

## 实现阶段

### 阶段1: 基础模块 (4-6周)

**目标**: 实现学员管理和房间配置

**功能清单**:
- ✓ 用户认证与权限管理
- ✓ 学员CRUD和批量导入
- ✓ 房间CRUD和配置
- ✓ 基础仪表盘和学员列表页面
- ✓ 数据库设计和初始化
- ✓ API接口设计

**可交付物**:
- 用户账户系统
- 学员管理模块（完整的CRUD）
- 房间配置模块
- 基础Web UI

### 阶段2: 分配算法 (3-4周)

**目标**: 实现核心的房间分配算法

**功能清单**:
- ✓ 学员分组和排序逻辑
- ✓ 同伴关系识别和管理
- ✓ 房间分配算法（含优先级、打乱、同伴保护）
- ✓ 冲突检测
- ✓ 分配结果验证

**可交付物**:
- 完整的分配算法实现
- 单元测试（覆盖各种场景）
- 算法文档和伪代码

### 阶段3: 审核与调整 (2-3周)

**目标**: 实现人工审核和修改功能

**功能清单**:
- ✓ 分配结果审核页面
- ✓ 房间分配调整（单个和交换）
- ✓ 禅堂座位手工调整
- ✓ 变更历史记录
- ✓ 撤销和恢复功能

**可交付物**:
- 审核和调整UI
- 调整逻辑和验证

### 阶段4: 禅堂座位 (2-3周)

**目标**: 实现禅堂座位的自动生成和管理

**功能清单**:
- ✓ 禅堂配置管理
- ✓ 座位生成算法（含多种编号方式）
- ✓ 座位预览和验证
- ✓ 座位手工调整

**可交付物**:
- 禅堂配置模块
- 座位生成和展示UI

### 阶段5: 报表与导出 (2周)

**目标**: 实现报表生成和多格式导出

**功能清单**:
- ✓ 床位分配表生成
- ✓ 禅堂座位表生成
- ✓ 统计和总结报表
- ✓ Excel导出
- ✓ PDF导出
- ✓ CSV导出

**可交付物**:
- 报表生成模块
- 导出功能

### 阶段6: 优化和上线 (2-3周)

**目标**: 性能优化、安全加固、部署准备

**功能清单**:
- ✓ 性能优化（缓存、索引、查询优化）
- ✓ 安全审计和加固
- ✓ 用户使用指南和培训视频
- ✓ 完整的系统文档
- ✓ 容器化和部署配置
- ✓ 用户验收测试（UAT）

**可交付物**:
- 性能基准报告
- 安全审计报告
- 部署包和上线指南

---

## 技术债和风险

### 已识别的风险

1. **同伴关系的复杂性**: 同伴间的传递性关系和冲突可能复杂，需要充分测试
   - *缓解*: 设计完整的测试用例，支持手工修改

2. **房间容量不足**: 学员人数可能超过房间容量
   - *缓解*: 自动警告，支持临时扩展配置

3. **禅堂座位布局多样性**: 不同禅修中心的禅堂布局差异大
   - *缓解*: 灵活的配置选项，支持自定义模板

4. **性能瓶颈**: 大数据量下的分配算法性能
   - *缓解*: 优化算法，使用缓存和异步处理

---

## 反馈与迭代

### 用户反馈渠道

- 系统内反馈表单
- 每月一次的用户意见收集会议
- 邮件反馈 (feedback@center.org)

### 迭代计划

- **V1.0**: 实现所有核心功能
- **V1.1**: 根据用户反馈进行改进
- **V2.0**: 添加AI辅助分配建议

---

## 附录

### A. 词汇表

| 术语 | 定义 |
|------|------|
| 学员 | 参加禅修课程的人 |
| 法师 | 姓名以"法"开头的学员，优先级最高 |
| 旧生 | 之前参加过课程的学员 (修学次数 > 0) |
| 新生 | 第一次参加课程的学员 (修学次数 = 0) |
| 房号 | 宿舍房间的编号，如B101、A112 |
| 床号 | 房间内的床号，通常为1或2 |
| 床位 | 房号+床号的组合，如B101-1 |
| 同伴 | 希望同住的学员 |
| 同伴组 | 相互关联的同伴集合 |
| 禅堂 | 集体冥想的场所 |
| 座位号 | 禅堂内的座位编号，如1、3、5等 |
| 期次 | 一个完整的课程周期（如2025年春季20日课） |
| 法工 | 参与服务的学员 |
| 分配方案 | 学员到房间和禅堂座位的映射 |

---

**文档结束**

