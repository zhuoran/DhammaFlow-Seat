# 禅堂配置设计与实现对比分析

**分析日期**: 2025-11-15  
**对比范围**: 文档设计（房间分配算法规则确认文档.md 9.1节） vs 实际实现

---

## 一、文档定义的配置参数（9.1节）

| 参数 | 说明 | 例子 | 对应数据库字段 |
|------|------|------|---------------|
| **有效范围** | 禅堂座位区域的单元格范围 | A5:E20 | `valid_area` |
| **起始单元格** | 座位分配的开始位置 | D5 | `begin_cell` |
| **行偏移** | 行之间的间距（用于排列） | 1 | `row_offset` |
| **列偏移** | 列之间的间距（用于排列） | 1 | `col_offset` |
| **最大行数** | 禅堂座位的最大行数 | 10 | `max_rows` |
| **最大列数** | 禅堂座位的最大列数 | 5 | `max_cols` |
| **实际行数** | 实际使用的行数（0=自动计算） | 0 | `region_rows` ⚠️ |
| **实际列数** | 实际使用的列数 | 4 | `used_cols` |
| **编号方式** | 座位号的编号规则 | 顺序/奇数/偶数 | `numbering_type` |
| **座位前缀** | 座位号的前缀 | A / B | `seat_number_prefix` / `seat_prefix` |

---

## 二、实际实现中的字段

### 2.1 基础字段（与文档对应）

```java
// MeditationHallConfig.java
private String validArea;              // ✅ 有效范围
private String beginCell;              // ✅ 起始单元格
private Integer rowOffset;             // ✅ 行偏移
private Integer colOffset;             // ✅ 列偏移
private Integer maxRows;               // ✅ 最大行数
private Integer maxCols;               // ✅ 最大列数
private Integer usedRows;              // ✅ 已使用行数
private Integer usedCols;              // ✅ 已使用列数
private String numberingType;          // ✅ 编号类型
private String seatNumberPrefix;       // ✅ 座位编号前缀
private String seatPrefix;             // ✅ 座位号前缀（别名）
```

### 2.2 新增字段（文档中未提及）

```java
// 区域相关
private Long centerId;                 // 所属禅修中心
private String regionName;             // 区域名称 (如"A区"、"B区")
private String regionCode;             // 区域代码 (如"A"、"B")
private Integer regionWidth;          // 区域宽度（列数，如4或10）
private Integer regionRows;            // 区域行数（0=自动计算）
private Boolean isAutoWidth;          // 宽度是否自动计算
private Boolean isAutoRows;           // 行数是否自动计算

// 性别相关
private Boolean genderSeparated;      // 是否需要性别分离
private String genderType;             // 性别类型：F=女众/M=男众/mixed=混合

// 法师座位相关
private String monkStartCell;          // 法师起始单元格
private Integer monkMaxCount;          // 法师最大数量
private String monkSeatPrefix;         // 法师座位前缀

// 预留和法工区域
private String oldStudentReservedList; // 旧生预留座位列表
private String dhammaWorkerArea1;      // 法工区域1
private String dhammaWorkerArea2;      // 法工区域2

// 新布局系统（JSON配置）
private String layoutConfig;           // 新的布局配置(JSON)
private String supportedGenders;       // 支持的性别集合，逗号分隔
private String hallUsage;              // 禅堂使用模式：SINGLE/DUAL/MIXED
```

---

## 三、关键差异分析

### 3.1 命名不一致问题

| 文档术语 | 实际字段 | 问题 |
|---------|---------|------|
| **实际行数** | `region_rows` | 文档说"实际行数"，但代码用`region_rows`，语义更偏向"区域行数" |
| **实际列数** | `used_cols` | 文档说"实际列数"，代码用`used_cols`（已使用列数），语义一致但命名不同 |

**建议**：
- 文档中的"实际行数"应该对应 `region_rows`（区域行数）
- 文档中的"实际列数"应该对应 `region_width`（区域宽度/列数），而不是 `used_cols`

### 3.2 文档缺失的重要字段

文档中**完全没有提及**以下重要配置：

1. **区域概念**（`region_code`, `region_name`）
   - 用于区分A区、B区等不同区域
   - 双性课程中非常重要

2. **自动计算标志**（`is_auto_width`, `is_auto_rows`）
   - 控制是否自动计算宽度和行数
   - 影响座位生成的灵活性

3. **法师座位配置**（`monk_start_cell`, `monk_max_count`, `monk_seat_prefix`）
   - 文档9.3节提到"法师座位"，但没有说明如何配置

4. **新布局系统**（`layout_config`）
   - JSON格式的布局配置
   - 支持更复杂的布局定义（sections, reserved slots等）

### 3.3 字段用途的变化

#### `valid_area` 和 `begin_cell`
- **文档描述**：Excel风格的单元格范围（如"A5:E20"）
- **实际用途**：在legacy模式下使用，新布局系统（`layout_config`）中可能不再使用

#### `row_offset` 和 `col_offset`
- **文档描述**：行/列之间的间距
- **实际用途**：在legacy布局中用于计算座位位置，新布局系统中由sections定义

---

## 四、配置加载和使用流程

### 4.1 配置来源

1. **数据库表**：`meditation_hall_config`
2. **YAML配置文件**：`config/centers.yaml`（通过`ConfigLoader`加载）
3. **JSON布局配置**：`layout_config`字段（新系统）

### 4.2 布局编译流程

```
MeditationHallConfig (数据库)
    ↓
LayoutCompiler.loadLayout()
    ├─ 如果有 layout_config (JSON) → 解析JSON
    └─ 否则 → buildLegacyLayout() (使用传统字段)
    ↓
HallLayout (结构化布局对象)
    ↓
LayoutCompiler.compile()
    ↓
CompiledLayout (编译后的布局，包含SeatCell列表)
```

### 4.3 Legacy vs 新布局系统

**Legacy模式**（使用传统字段）：
- 使用 `region_width`, `region_rows` 定义简单矩形区域
- 单一section，所有座位相同purpose

**新布局系统**（使用`layout_config` JSON）：
- 支持多个sections（法师区、旧生区、新生区等）
- 支持reserved slots（预留座位）
- 更灵活的布局定义

---

## 五、问题和建议

### 5.1 文档更新建议

1. **补充区域相关配置**
   - 添加 `region_code`, `region_name` 说明
   - 说明双性课程中区域的作用

2. **补充法师座位配置**
   - 添加 `monk_start_cell`, `monk_max_count`, `monk_seat_prefix` 说明
   - 与9.3节"分配法师座位"对应

3. **说明新旧两套系统**
   - Legacy配置（传统字段）
   - 新布局系统（JSON配置）
   - 两者的关系和迁移路径

4. **修正字段命名**
   - "实际行数" → "区域行数"（`region_rows`）
   - "实际列数" → "区域宽度"（`region_width`）

### 5.2 实现改进建议

1. **字段命名统一**
   - `used_cols` 和 `region_width` 的关系需要明确
   - 考虑是否保留 `used_rows` 和 `used_cols`（可能已废弃）

2. **配置验证**
   - 添加配置完整性检查
   - Legacy和新系统不能混用

3. **文档化JSON格式**
   - `layout_config` 的JSON schema需要文档化
   - 提供配置示例

---

## 六、配置示例对比

### 6.1 文档中的配置示例（假设）

```
有效范围: A5:E20
起始单元格: D5
行偏移: 1
列偏移: 1
最大行数: 10
最大列数: 5
实际行数: 0 (自动计算)
实际列数: 4
编号方式: 顺序
座位前缀: A
```

### 6.2 实际数据库配置（Legacy模式）

```sql
INSERT INTO meditation_hall_config (
    session_id, region_code, region_name,
    valid_area, begin_cell,
    row_offset, col_offset,
    max_rows, max_cols,
    region_width, region_rows,
    is_auto_rows,
    numbering_type, seat_prefix,
    gender_type
) VALUES (
    1, 'A', '禅堂A区',
    'A5:E20', 'D5',
    1, 1,
    10, 5,
    4, 0,  -- region_rows=0 表示自动计算
    TRUE,
    'SEQUENTIAL', 'A',
    'M'
);
```

### 6.3 新布局系统（JSON配置）

```json
{
  "originRow": 0,
  "originCol": 0,
  "totalRows": 10,
  "totalCols": 4,
  "autoRows": true,
  "sections": [
    {
      "name": "法师区",
      "purpose": "MONK",
      "rowStart": 0,
      "rowEnd": 2,
      "colStart": 0,
      "colEnd": 0
    },
    {
      "name": "学员区",
      "purpose": "MIXED",
      "rowStart": 0,
      "rowEnd": 9,
      "colStart": 1,
      "colEnd": 3
    }
  ],
  "numbering": {
    "mode": "SEQUENTIAL",
    "prefix": "A"
  }
}
```

---

## 七、讨论要点

1. **文档是否需要更新**以反映实际实现？
2. **Legacy配置和新布局系统**的关系和迁移策略？
3. **字段命名**是否需要统一和规范化？
4. **配置验证**机制是否足够完善？

