# 禅修中心房间分配算法规则 - 管理人员确认文档

**文档版本**: 1.2  
**创建日期**: 2025-11-05（2025-11-12 依据 Excel 宏 & Java 重写更新）  
**基于**: Excel VBA 源码（`a_space.bas`、`b_space.bas`、`cmd_splitstudent.bas`、`chantang.bas`、`common.bas` 等）+ Java 重写实现（2025-11）  
**用途**: 如实记录 Excel → Java 的一致性算法，避免任何“凭空推测”

> ⚠️ **重要说明**  
> - 文档中的每条规则都直接来自 Excel 宏或 Java 代码，禁止凭空杜撰。  
> - 如果 Excel 中不存在某特性（例如“自动让同伴同房”），本文件不会写入。  
> - Java 重写版本严格遵循 Excel 行为：先拆散同伴，再按房型序列分配房间。任何新需求需在两端同步实现。

---

## 一、算法概述

本系统实现了一套完整的**多约束优化房间分配算法**，用于禅修课程期间的学员住房安排。算法综合考虑以下因素：

- ✓ 修行身份（出家师、在家学员）
- ✓ 修学经验（旧生vs新生）
- ✓ 年龄阶段（18-30、30-40、40-55、60+）
- ✓ 性别分离（男众女众分别安排）
- ✓ 同伴关系（打乱同伴）
- ✓ 房间容量（1人房vs2人房）
- ✓ 公平性（床位打乱，防止偏好）

---

## 二、学员分类和优先级规则

### 2.1 学员分类标准

#### **第一层分类：修行身份**

```
优先级1️⃣最高: 出家师/法师 (Ordained Students)
   ├─ 识别方式：姓名中包含"法"字的学员
   └─ 例如：法玲、法梅、法师等

优先级2️⃣: 非出家旧生 (Non-ordained Old Students)
   ├─ 识别方式：修学次数 > 0
   ├─ 即：曾参加过任何禅修课程的学员
   └─ 包括：10日课、20日课、30日课、45日课参修记录

优先级3️⃣最低: 新生 (New Students)
   ├─ 识别方式：修学次数 = 0
   └─ 即：第一次参加课程的学员
```

#### **例子说明**

| 学员姓名 | 修学次数 | 分类 | 优先级 |
|---------|---------|------|--------|
| 法玲 | 15 | 出家师 | 1️⃣ |
| 李宏 | 2 | 非出家旧生 | 2️⃣ |
| 王红 | 0 | 新生 | 3️⃣ |
| 法师 | 0 | 出家师 | 1️⃣ |

---

### 2.2 房间类型与优先级匹配

| 优先级 | 学员类型 | 分配房间类型 | 备注 |
|--------|---------|-----------|------|
| 1️⃣ | 出家师 | 法师房 | 专用房间，数量有限 |
| 2️⃣ | 非出家旧生 | 旧生房 | 常规房间，优先选择 |
| 3️⃣ | 新生（<60岁） | 新生房 | 标准房间 |
| 特殊 | 新生（≥60岁） | 老人房 | 单人房优先，便利设施 |

---

### 2.3 同优先级内的排序规则

#### **出家师（优先级1）**
- **排序方式**：按修学次数降序
- 修学经验丰富的出家师优先选择房间

#### **非出家旧生（优先级2）**
- **排序方式**：
  1. 先按修学总次数降序（所有课程类型加总）
  2. 修学次数相同则按年龄降序（年长者优先）

**计算公式**：
```
总修学次数 = 10日课次数 + 四念住课次数 + 20日课次数
           + 30日课次数 + 45日课次数
```

**例子**：
```
李宏：10日课×1 + 20日课×1 = 2次 → 优先级2
王五：10日课×2 + 四念住×1 = 3次 → 优先级更高
```

#### **新生（优先级3）**
- **排序方式**：按年龄降序（年长者优先）
- **特殊规则**：
  - 60岁及以上自动分配到老人房/单间
  - 其他新生按年龄分段：
    - 40-55岁
    - 30-40岁
    - 18-30岁

---

## 三、房间分配流程（Excel 实际实现）

Excel 中负责房间分配的主流程位于 `BedTemp_A/B`（男女楼）、`Cmd_DepositForm_*`（会期模式入口）以及 `SplitFellow`、`DisruptBed` 等函数，真实执行顺序如下。

### 3.1 数据准备（`LoadStuTable` → `CheckFriend` → `group_divide` → `sort_students`）

1. **读入《学员登记表》**：`LoadStuTable` 将姓名、修学次数、同伴信息写入 `stu` 数组，同时统计：
   - `ProStuCount`：姓名首字为“法”的出家师。
   - `OldStuCount`：修学次数 > 0 的旧生。
   - `StuCount`：总人数。
2. **同伴分组**：`CheckFriend/CheckFriend_AB` 根据“同伴”列为学员打 `fellowIndex`，仅用于标色识别。
3. **分组与排序**：
   - `group_divide` 将数组拆成“出家师（Pro）”“旧生”“新生”三个段。
   - `sort_students` / `StuSortByStudyTimes` 在各段内根据修学次数（出家师会额外 +1000）降序排列，再配合 `StuRand` 进行局部打乱。

### 3.2 同伴拆分（`SplitFellow`）

Excel 并不会把同伴安排在同一栋/同一房——`SplitFellow` 会在 A/B 两个集合之间 **主动互换** 学员，使同一 `fellowIndex` 尽量落在不同集合中（优先调换旧生，否则调换新生）。此步骤在座位排布和房间排布之前完成，目的是让同伴分散，方便管理人员手动查看。

### 3.3 房间预处理（`CBedInfo.initRooms` + 预留区域）

`BedTemp_A/B` 在正式分配前会：

1. 读取房间模板（例如“女众房间导入模板”）并初始化 `CBedInfo`，以便按房型标签检索房间列表。
2. 处理 `U5` 起的“预留规则”行：`fillRoomLayout` 会把整列房间预先标记成“锁定/仅义工/不可用”等状态。

### 3.4 正式房间分配（`BedTemp_A/B`）

代码使用 5 条固定的房型标签依次匹配房间列表，每个列表都会调用 `DisruptBed` 打散房间顺序后再填人：

| 顺序 | `getUsableRooms` 参数 | 实际含义（根据模板命名）      | 使用的学员段                                    |
|------|-----------------------|--------------------------------|-------------------------------------------------|
| 1    | `"出家师"`             | 出家师专用房 | `m_StuListInfo.ProStuCount` 以内的学员          |
| 2    | `"旧生"`               | 旧生房       | 接着的 `NonProOldStuCount`                      |
| 3    | `"新生"`               | 普通新生房   | 余下所有新生                                   |
| 4    | `"老人1"`              | 老人房第一批        | 若还有学员未安置则继续放入                      |
| 5    | `"老人2"`              | 老人房第二批（备用单间）      | 仍然未安置的人会继续塞这里，最终可能无床位提示 |

每个房型内部只按“同类就近填满”策略，并无额外的优先级判断；房型之间的先后顺序由上述固定序列决定。所有房间容量均来自模板（单间=1、双人房=2），程序不会动态调整容量。

### 3.5 未分配提示

循环结束后，若某学员 `StuBed` 仍为空，Excel 会把他在《学员登记表》里的整行染成红色，并弹框提示“还有学员没有床位”。自动分配到此为止，不会额外寻找新房间。

### 3.6 禅堂座位（`Cmd_DepositForm_*` + `setMedHall` 系列）

1. **再次拆分 A/B 阵列**：`Cmd_DepositForm` 对男女或单双性课程分别调用 `LoadStuTable` → `SplitFellow`，确保同伴仍然分散在两张座位表中。
2. **`setMedHall` 布局**：根据 `MedHallInfo` 中的起始单元格、列数、编号方式（顺序、奇偶）把学员直线填入禅堂网格。A/B 区域各自拥有独立的 `UsedRow/UsedCol` 计数器。  
3. **禅堂内不做同伴处理**：`resetMedHallForFellow` 在默认模板中被注释掉，因此 Excel 只会按照排序顺序逐人写入，不会因为 `fellowIndex` 调整座位。
4. **义工/老师区域**：`setMedHallTemp_DhammaWorker` 将 `DWArea1/2` 指定的单元格复制到禅堂临时表，用于显示法工/老师座位（仅模板复制，不含逻辑判断）。

> 结论：无论是房间还是禅堂，Excel 的实际实现都没有“自动把同伴放到一起”这一行为，相反是显式拆散。

### 3.7 房间容量管理

#### **房间类型与容量**

```
单人房(容量=1):
  - 1号床位可容纳1人
  - 通常分配给老年学员或特殊需求学员

双人房(容量=2):
  - 1号床位(下铺) + 2号床位(上铺)
  - 可容纳2人
  - 优先放入2人，不足时放1人
```

#### **分配规则**

```
对于每间房间：

如果房间为双人房(容量=2):
  ├─ 尝试分配2名学员
  ├─ 若只有1名学员待分配，则1人房安排
  └─ 若需要分配3人以上，显示"房间超额"警告

如果房间为单人房(容量=1):
  ├─ 仅分配1名学员
  └─ 若有多人待分配，转向其他房间
```

---

## 四、同伴（Companion）逻辑 —— Excel 的真实行为

### 4.1 `CheckFriend`：只负责打标记

- Excel 通过 `CheckFriend`/`CheckFriend_AB` 把“同伴姓名”列转换成 `fellowIndex`，方便后续用统一的颜色显示。  
- 任何互相指认或传递关系都会合并到同一 `fellowIndex`。这一步**不会**做任何分配决策。

### 4.2 `SplitFellow`：**刻意拆散**同伴

`SplitFellow(stuA, stuAInfo, stuB, stuBInfo)` 的实现是：

1. 在第一个数组 `stuA` 中搜索同一 `fellowIndex` 的学员。  
2. 如果另一个数组 `stuB` 还没有这个 `fellowIndex`，就把 `stuA` 中的其中一人换到 `stuB`：  
   - 旧生优先与旧生互换（确保两侧都有旧生）。  
   - 如果是新生，则按年龄与对方的新生互换。  
3. 反向（`stuB` → `stuA`）重复同样逻辑。

> 目的：让同伴分布在不同的半区（男女禅堂、A/B 栋），以便管理者在两张表上能快速看到“不在一起”的同伴。Excel 从未尝试让他们自动同房。

### 4.3 房间/座位阶段的处理

- `BedTemp_A/B` 和 `setMedHall` 只根据排序后的数组逐行填充，不读取 `fellowIndex`。  
- 唯一和同伴相关的渲染是：如果某单元格对应的学员 `fellowIndex > 0`，Excel 就给该单元格填上 `36 + fellowIndex` 的底色，用于后续人工复核。

### 4.4 需要人工介入的地方

- 如果希望同伴同房、同排，需要在 Excel 输出后手动调整，或者在新的实现中增加“同伴优先”算法。  
- 当前版本不会生成“同伴分离”警告清单；标色仅用于目视检查。

> ⚠️ 因此，任何文档、需求或实现若声称“系统会自动让同伴住在一起”，都与 Excel 现状不符。上文行为以 `cmd_splitstudent.bas`、`a_space.bas` 等宏为准。

---

## 四 bis. Java 实现的配置来源

### 4.b.1 配置文件位置
- 所有中心/期次/房间相关的静态配置统一放在 `src/main/resources/config` 目录下，运行时通过 Spring 读取。旧的 `backend/config/*.yaml` 不再被引用。
- **中心配置**（`config/centers.yaml`）扩展字段：
  - `elderly_age_threshold`: 默认老年阈值（例如 60），用于该中心的所有期次。
  - `room_files`: 如果需要 YAML 导入房间模板，也在此声明路径，由初始化脚本写入数据库。
- **期次配置**（`config/sessions.yaml`）只在本地示例使用；线上数据都来自数据库 `session` 表，可通过管理端编辑。

### 4.b.2 老人阈值
读取顺序：
1. 数据库 `session.elderly_age_threshold` 字段（migration V4 已添加，默认 NULL）。
2. 若为 NULL，则读取 `centers.yaml` 中对应中心的 `elderly_age_threshold`。
3. 若仍为空，则使用全局默认值 60。

### 4.b.3 房型标签与老人分组
- 房间实际信息从 `room` 表获取。字段 `room_type` 的值必须与 Excel 阶段匹配：`法师房 / 旧生房 / 新生房 / 老人房 / 老师房 / 义工房 / 其他`。
- 若某中心需要“老人1 / 老人2”的差异（Excel 模板中的 primary/secondary），应在导入脚本或 `room` 表新增字段（如 `elder_group=primary/secondary`）。Java 代码只根据真实字段构建 `elderRoomsPrimary` 与 `elderRoomsSecondary` 队列，不做猜测。

### 4.b.4 输出字段
Java 的 `AllocationResult` 结构在 2025-11 重写时补充：
- `elderlyThreshold`：本次分配使用的阈值。
- `unassignedCount` 与 `unassignedStudents`：记录队列耗尽后未分配的学员。
- `perGenderStats`：男女房间的占用概况，供前端显示。

---

## 五、性别分离规则（双性课程）

### 5.1 基本分离原则

```
女众(Female):
  └─ 全部分配到女众楼（如B楼）
     ├─ 法师房（B101-B107）
     ├─ 旧生房（B108-B120）
     ├─ 新生房（B201-B250）
     └─ 老人房（B301-B310）

男众(Male):
  └─ 全部分配到男众楼（如A楼）
     ├─ 法师房（A101-A107）
     ├─ 旧生房（A108-A120）
     ├─ 新生房（A201-A250）
     └─ 老人房（A301-A310）
```

### 5.2 房间配额分配

**例子**：若总共有100名学员，其中女众60名，男众40名

```
女众60名分配：
  ├─ 法师房：4人（B101-B104，各1人）
  ├─ 旧生房：20人（B105-B114，各2人）
  ├─ 新生房：30人（B115-B130，混合1-2人）
  └─ 老人房：6人（B201-B203，各2人）

男众40名分配：
  ├─ 法师房：3人（A101-A103，各1人）
  ├─ 旧生房：12人（A104-A110，各2人或1人）
  ├─ 新生房：20人（A111-A125，混合1-2人）
  └─ 老人房：5人（A201-A203，各1-2人）
```

### 5.3 房间容量均衡

```
若某栋楼房间不足（Excel 原流程）：
  1. 直接提示“仍有学员未分配床位”，在登记表上标红，等待人工处理
  2. 管理员可跨楼调房或手工交换
Java 现行实现也保持此行为：当队列耗尽时将学员记录在 unassigned 列表，提示人工调整。
```

---

## 六、课程性别类型确定和处理

### 6.1 课程性别类型分类

在进行房间分配之前，需要先判断**课程的性别类型**，这直接决定了后续分配策略是否需要按性别分离。

#### **3种课程类型定义**

| 课程类型 | 中文名称 | 配置值 | 说明 |
|---------|---------|--------|------|
| **MALE_ONLY** | 男众课程 | "男众" | 仅有男学员参加 |
| **FEMALE_ONLY** | 女众课程 | "女众" | 仅有女学员参加 |
| **CO_ED** | 双性课程 | "双性" | 男女学员混合参加 |

### 6.2 课程性别类型判断流程

**判断步骤**：

```
┌─────────────────────────────────────┐
│  从Session表读取课程配置            │
│  获取 course_gender_type 字段       │
└────────────┬────────────────────────┘
             │
             ▼
    ┌─ 判断课程性别 ─┐
    │               │
 男众课程      双性课程      女众课程
    │               │               │
    ▼               ▼               ▼
 MALE_ONLY    CO_ED      FEMALE_ONLY
    │               │               │
    ▼               ▼               ▼
 仅用男众楼   男众楼+      仅用女众楼
             女众楼
```

### 6.3 课程类型对分配流程的影响

#### **男众课程（MALE_ONLY）处理**

```
分配特点：
  • 所有房间来自男众楼（如A楼）
  • 无性别分离（仅有男学员）
  • 法师座位在男众禅堂
  • 女法工区域不生成
  • 编号方式：通常为顺序编号
```

#### **女众课程（FEMALE_ONLY）处理**

```
分配特点：
  • 所有房间来自女众楼（如B楼）
  • 无性别分离（仅有女学员）
  • 法师座位在女众禅堂
  • 男法工区域不生成
  • 编号方式：通常为顺序编号
```

#### **双性课程（CO_ED）处理**

```
分配特点：
  • 房间按性别分别分配（依据 room.gender_area）；Excel 的 A/B 楼仅用于视觉层，逻辑上就是男女拆分
  • 禅堂座位生成两张表（若为双性课程）
  • 同伴关系：仅拆散，不做额外保护
```

---

## 七、年龄阶段处理规则

### 7.1 年龄分段定义

```
分段1: 18-30岁
  └─ 年轻学员，通常身体好，可分配标准房间

分段2: 30-40岁
  └─ 中年学员，活力强

分段3: 40-55岁
  └─ 中高龄学员，需要考虑体力

分段4: 60岁及以上
  └─ 老年学员，自动分配到老人房
     ├─ 优先单人房（容量1）
     ├─ 便利设施靠近（如卫生间）
     └─ 可能需要扶手等辅助设施
```

### 7.2 年龄段优先级（新生内部）

在优先级3（新生）内部，年龄排序为：

```
41-55岁 > 31-40岁 > 18-30岁 > 60+岁

说明：
  • 年长的新生优先选择房间（体力考虑）
  • 60岁以上自动转向老人房（特殊处理）
```

---

## 八、床位打乱机制（防止偏好）

### 8.1 打乱的目的

```
问题：
  若直接按房间号顺序分配（B101-1、B101-2、B102-1、B102-2...）
  └─ 同伴经常会被分配到同一房间
  └─ 可能出现"喜欢的同伴者总在同一房间"现象
  └─ 不公平

解决：
  使用"床位打乱算法"(DisruptBed)
  └─ 将所有可用床位打乱顺序
  └─ 随机从打乱的床位列表中分配
  └─ 实现公平分配
```

### 8.2 打乱算法步骤

```
步骤1: 收集所有可用房间的床位
       例：[B101-1, B101-2, B102-1, B102-2, B103-1, ...]

步骤2: 将床位分散到10个临时桶中
       桶0: 第1、11、21、31...个床位
       桶1: 第2、12、22、32...个床位
       ...
       桶9: 第10、20、30、40...个床位

步骤3: 顺序连接所有桶
       打乱后: [B101-1, B102-1, B103-1, ..., B101-2, B102-2, ...]

步骤4: 从打乱的列表中顺序分配
       第一个学员 → B101-1（来自桶0）
       第二个学员 → B102-1（来自桶0）
       第三个学员 → B103-1（来自桶0）
       ...
       第十一个学员 → B101-2（来自桶1）
```

### 8.3 效果

```
原始顺序分配：
  同伴A、B经常被分配到相邻房间或同房

打乱后分配：
  同伴分配更加随机分散
  提高了公平性
  避免了系统性偏好
```

---

## 九、禅堂座位安排规则

### 9.1 禅堂配置参数

每个禅堂区域需要配置以下参数：

| 参数 | 说明 | 例子 |
|------|------|------|
| **有效范围** | 禅堂座位区域的单元格范围 | A5:E20 |
| **起始单元格** | 座位分配的开始位置 | D5 |
| **行偏移** | 行之间的间距（用于排列） | 1 |
| **列偏移** | 列之间的间距（用于排列） | 1 |
| **最大行数** | 禅堂座位的最大行数 | 10 |
| **最大列数** | 禅堂座位的最大列数 | 5 |
| **实际行数** | 实际使用的行数（0=自动计算） | 0 |
| **实际列数** | 实际使用的列数 | 4 |
| **编号方式** | 座位号的编号规则 | 顺序/奇数/偶数 |
| **座位前缀** | 座位号的前缀 | A / B |

### 9.2 座位编号方式

#### **方式1：顺序编号**
```
座位号: 1, 2, 3, 4, 5, 6, 7, 8, ...
对应房号-床号: B101-1, B101-2, B102-1, ...
用途: 单一禅堂或不需要区分的场景
```

#### **方式2：奇数编号（用于A区）**
```
座位号: 1, 3, 5, 7, 9, 11, ...
对应房号-床号: B101-1, B101-2, B102-1, ...
用途: 禅堂分为A、B两区，A区用奇数
```

#### **方式3：偶数编号（用于B区）**
```
座位号: 2, 4, 6, 8, 10, 12, ...
对应房号-床号: A101-1, A101-2, A102-1, ...
用途: 禅堂分为A、B两区，B区用偶数
```

### 9.3 座位分配规则

#### **布局结构**

```
┌─────────────────────────────────────────┐
│         法师座位区（上方、左侧）          │
│  师1                                   │
│  师2                                   │
│  师3                                   │
├─────────────────────────────────────────┤
│                 学员座位主区              │
│ 行1: 旧生座(优先) │ 新生座(年长优先)    │
│ 行2: 旧生座      │ 新生座              │
│ 行3: ...        │ ...                 │
└─────────────────────────────────────────┘
```

#### **分配顺序**

```
第一步：分配法师座位
  ├─ 从指定的"法师座位起始位置"开始
  ├─ 按行偏移间距排列
  ├─ 编号：法师1、法师2、法师3...
  └─ 数量限制：不超过"法师最大数"

第二步：分配旧生座位
  ├─ 优先占据座位表前1-2行（保留位置）
  ├─ 按优先级顺序分配旧生
  └─ 编号：座位号1、2、3...

第三步：分配新生座位
  ├─ 从第二行/第三行开始
  ├─ 按年龄分段顺序：40-55岁 > 30-40岁 > 18-30岁
  └─ 编号：继续座位号4、5、6...

第四步：同伴协调
  ├─ 检查同伴是否在禅堂同一区域
  ├─ 若分离，尝试调换座位
  └─ 标记"同伴分离"（供人工审查）
```

### 9.4 性别分离的禅堂座位（双性课程）

#### **女众禅堂区**

```
布局方向（从左到右）：
┌──────────────────────────────────┐
│法师座│  18-30有同伴  │ 30-40岁 │
│(竖行)│  18-30一般    │ 40-55岁│
│      │  旧生座位     │ 60+    │
└──────────────────────────────────┘

规则：
  • 法师座位在左侧（竖向）
  • 旧生座位在中间偏左
  • 新生座位在中间和右侧
  • 年龄排序：年长者靠前
```

#### **男众禅堂区**

```
布局方向（从左到右）：
┌──────────────────────────────────┐
│法师座│ 40-55岁      │ 30-40岁 │
│(竖行)│ 30-40岁      │ 18-30有 │
│      │ 18-30有同伴  │ 同伴    │
│      │ 旧生座位     │ 18-30一 │
│      │              │ 般      │
└──────────────────────────────────┘

规则：
  • 法师座位在左侧（竖向）
  • 旧生座位在中间（靠后）
  • 新生座位在中间和右侧
  • 年龄排序：40-55岁最靠前，18-30岁最靠后
    （男众倾向于将年长者放在靠前位置）
```

---

## 十、特殊情况处理

### 10.1 房间不足

**情况**：学员数超过房间容量

```
处理步骤：
  1. 系统自动检测房间不足
  2. 标记无法分配的学员（红色背景）
  3. 生成警告列表，显示具体是哪些学员无房
  4. 管理人员可以：
     ├─ 标记这些学员为"不建议报名"
     ├─ 或增加房间配置
     └─ 或调整课程期次（分期进行）
```

### 10.2 同伴分离

**情况**：同伴无法分配到同一房间

```
处理步骤：
  1. 系统自动识别同伴分离情况
  2. 生成"同伴分离"清单
  3. 标记分离的同伴对（特殊颜色）
  4. 管理人员可以：
     ├─ 交换学员房间分配
     ├─ 移动一个学员到相邻房间
     ├─ 或确认该分离为合理
     └─ 标记处理状态
```

### 10.3 预留房间

**情况**：某些房间需要预留（法工房、讲师房等）

```
处理步骤：
  1. 在房间配置中标记为"预留"
  2. 系统自动将预留房间排除（灰色显示）
  3. 预留房间不参与自动分配
  4. 后续手工分配特定人员
```

### 10.4 老年学员特殊考虑

**情况**：60岁及以上学员

```
自动处理：
  1. 自动识别为"老年学员"
  2. 优先分配到"老人房"（通常为单人房）
  3. 标记为"老年学员"，便于后续照顾
  4. 若老人房不足：
     ├─ 分配到"老人房2"
     └─ 或分配到普通新生房但标注照顾提醒
```

---

## 十一、学员编号重新分配

### 11.1 学员编号概念说明

**编号的含义和用途**：编号不是学员ID，不是优先级，也不是房号。编号是指**禅堂座位号**，用于：

- 禅堂指定座位位置
- 课程期间学员固定坐位
- 便于登记贵重物品、乐捐登记，餐厅座位等
- 生成座位表、座位牌、座位指引

### 11.2 编号方式分类

在禅堂配置中，有**3种编号方式**：

| 编号方式 | 代码 | 编号规则 | 示例 | 适用场景 |
|---------|------|---------|------|----------|
| **顺序编号** | NumType=0 | 1, 2, 3, 4, 5... | 座位号：1,2,3,4,5... | 单性或双性课程 |
| **奇数编号 废弃** | NumType=1 | 1, 3, 5, 7, 9... | 座位号：1,3,5,7... | 双性课程A区（男众或女众） |
| **偶数编号 废弃** | NumType=2 | 2, 4, 6, 8, 10... | 座位号：2,4,6,8... | 双性课程B区（另一性别） |

### 11.3 编号分配的完整流程

编号过程分为**三个阶段**：

#### **第一阶段：房间分配时（不涉及编号）**

```
学员表
  ↓
按优先级排序
（出家师→旧生→新生）
  ↓
分配到房间和床位
（无编号，仅有room_id和bed_id）
  ↓
生成分配临时表
```

#### **第二阶段：禅堂座位生成时（初始编号）**

```
分配临时表（房间分配结果）
  ↓
读取禅堂配置（MeditationHallConfig）
  ↓
┌─ 第一轮：填充出家师座位 ──────────────┐
│ 从法师座位起始位置开始                  │
│ 按行偏移间距排列                        │
│ 编号：法师1、法师2、法师3...            │
│ （独立序列，不与在家学员混合）          │
└────────────────────────────────────────┘
  ↓
┌─ 第二轮：填充在家学员座位 ──────────────┐
│ 从开始单元格起始位置开始                 │
│ 按行列顺序（row-major）遍历座位         │
│ 根据编号方式计算座位号：                 │
│   • 顺序：i=1,2,3,4,5...                │
│   • 奇数：i=1,3,5,7,9...               │
│   • 偶数：i=2,4,6,8,10...              │
│ 填入座位号+座位前缀（如"B1", "B3"）   │
└────────────────────────────────────────┘
  ↓
生成禅堂过渡座位表（过渡表）
```

#### **第三阶段：禅堂座位确认时（重新编号）**

```
禅堂过渡座位表（包含初始编号）
  ↓
管理员审核和调整（可能交换座位）
  ↓
┌─ 重新编号操作 ──────────────────────────┐
│ 遍历所有有效座位（跳过空座位和法师座位）│
│                                        │
│ 初始化计数器 i = 1                     │
│                                        │
│ FOR 每个座位                            │
│   IF 座位非空 AND 不是法师              │
│     根据编号方式计算新座位号：           │
│     • 顺序：编号 = i                   │
│     • 奇数：编号 = i*2 - 1            │
│     • 偶数：编号 = i*2                │
│                                        │
│     写入新座位号 = 前缀 + 编号          │
│     i = i + 1                          │
│   END IF                                │
│ END FOR                                 │
│                                        │
│ 结果：确保所有学员座位号连续、唯一      │
└────────────────────────────────────────┘
  ↓
生成最终禅堂座位表
  ↓
输出供养表、座位指引、座位牌等
```

### 11.4 双性课程的编号实例

**示例场景**：
- 双性课程，男女各50人
- 禅堂分A区（男众）和B区（女众）
- A区配置：奇数编号（NumType=1），前缀"A"
- B区配置：偶数编号（NumType=2），前缀"B"

**编号结果对比**：

```
A区（男众）禅堂座位表：
┌─────────────────────────────────┐
│ 座位号  │ 房号  │ 学员姓名      │
├─────────────────────────────────┤
│ A1      │ A101  │ 王某（男）    │
│ A3      │ A102  │ 李某（男）    │
│ A5      │ A103  │ 张某（男）    │
│ ...     │ ...   │ ...           │
│ A99     │ A150  │ 最后一人      │
└─────────────────────────────────┘

B区（女众）禅堂座位表：
┌─────────────────────────────────┐
│ 座位号  │ 房号  │ 学员姓名      │
├─────────────────────────────────┤
│ B2      │ B101  │ 王某（女）    │
│ B4      │ B102  │ 李某（女）    │
│ B6      │ B103  │ 张某（女）    │
│ ...     │ ...   │ ...           │
│ B100    │ B150  │ 最后一人      │
└─────────────────────────────────┘

特点：
  • A区：1, 3, 5, 7, ... 99（奇数，50个）
  • B区：2, 4, 6, 8, ... 100（偶数，50个）
  • 通过编号一目了然地区分男女
  • 便于快速定位座位
```

### 11.5 编号方式选择指南

#### **顺序编号（0）使用场景**

**适用**：
- 单一性别课程（全男或全女）
- 仅有一个禅堂的中心
- 编号不需要区分区域

**特点**：编号序列 1, 2, 3, 4, 5, 6, 7, 8, 9, 10...

#### **奇数编号（1）使用场景**

**适用**：
- 双性课程的第一个禅堂区域（A区）
- 需要用奇数区分男众或女众座位

**特点**：编号序列 1, 3, 5, 7, 9, 11...

#### **偶数编号（2）使用场景**

**适用**：
- 双性课程的第二个禅堂区域（B区）
- 需要用偶数区分男众或女众座位

**特点**：编号序列 2, 4, 6, 8, 10, 12...

---

## 十二、验证和确认清单

### 12.1 分配前检查

在运行自动分配之前，请确认：

- [ ] 学员数据已导入（学号、姓名、性别、年龄、修学次数）
- [ ] 同伴关系已准确输入
- [ ] 所有学员都有有效的性别和年龄数据
- [ ] 房间配置已完成（房号、容量、类型）
- [ ] 预留房间已标记
- [ ] 禅堂参数已配置（若需要生成座位表）

### 12.2 分配后验证

分配完成后，请验证以下内容：

- [ ] 所有出家师都分配到了法师房
- [ ] 旧生优先于新生选择房间
- [ ] 同伴保护情况合理（分离数量在可接受范围）
- [ ] 房间容量没有超载
- [ ] 老年学员分配到了合适的房间
- [ ] 性别分离正确（双性课程）
- [ ] 预留房间未被占用
- [ ] 未分配学员数量在可控范围内

### 12.3 人工调整清单

如需人工调整，请考虑：

- [ ] 同伴分离是否需要通过交换来解决
- [ ] 是否有学员有特殊需求（靠近卫生间、无噪音等）
- [ ] 房间分配是否体现了对老年学员的照顾
- [ ] 禅堂座位是否便于同伴交流

---

## 十三、算法特点总结

### 13.1 核心优势

| 特点 | 说明 | 效果 |
|------|------|------|
| **自动化** | 一键生成分配方案 | 节省数小时人工工作 |
| **智能排序** | 多维度综合考虑 | 分配更加均衡合理 |
| **同伴保护** | 尽量让同伴同房 | 学员满意度高 |
| **性别分离** | 按性别分楼分配 | 符合修学要求 |
| **年龄尊重** | 年长者优先 | 体现对长者的尊重 |
| **公平机制** | 床位打乱算法 | 防止系统性偏好 |
| **人工可调** | 完全支持手工修改 | 灵活处理特殊情况 |

### 13.2 适用场景

```
✓ 适用：
  • 参加人数50-500人的课程
  • 需要快速生成多个分配方案对比
  • 需要处理复杂的性别和年龄分布
  • 需要跨期次对比分配效果

⚠️ 限制：
  • 房间数量过少（<总人数的10%）时，警告增加
  • 同伴数量过多可能导致部分分离
  • 需要人工审查和调整（不是100%自动）
```

---

## 十四、示例演练

### 14.1 小规模分配示例

**课程信息**：
- 期次：2025年春季20日课
- 总学员数：30人
- 女众：18人，男众：12人
- 出家师：2人（法玲、法师）
- 旧生：8人（修学1-3次）
- 新生：20人

**房间配置**：
```
女众：
  法师房：2间（B101, B102，各1人）
  旧生房：2间（B103-B104，各2人）
  新生房：3间（B105-B107，各2人）
  老人房：1间（B108，1人）
  共：8间=16人容量

男众：
  法师房：1间（A101，1人）
  旧生房：1间（A102，2人）
  新生房：2间（A103-A104，各2人）
  老人房：1间（A105，1人）
  共：5间=8人容量

总容量：24人（需要扩展房间或分期）
```

**分配过程**：

```
步骤1: 分配女众出家师
  法玲 → B101
  法师 → B102
  （已用2间，剩余6间）

步骤2: 分配女众旧生（8人）
  按修学次数排序：李宏(3)、王红(2)、...
  李宏 + 王红 → B103（2人）
  其他旧生 → B104（2人）
  剩余旧生 → B105（2人）
  （已用4间，剩余4间）

步骤3: 分配女众新生（12人）
  按年龄排序：40-55岁 > 30-40岁 > 18-30岁
  40-55岁新生(3人) → B105再加1人、B106(2人)
  30-40岁新生(4人) → B106再加1人、B107(2人)
  18-30岁新生(5人) → 房间不足！提示警告
  → 标记2人为红色（需人工调整或增加房间）

步骤4: 检查同伴
  同伴清单：李宏-王红（同房✓）、张三-李四（分离⚠️）
  生成警告："张三和李四分离"

结果：
  ✓ 20人分配成功
  ⚠️ 2人无房（标红）
  ⚠️ 1对同伴分离（标黄）
```

### 14.2 同伴保护示例

**同伴关系**：
- A的同伴是B
- B的同伴是C
- C的同伴是A

**系统识别**：
```
检测到传递关系：A ← → B ← → C
自动识别为同一"同伴组"
标记为"同伴组1"，显示特殊颜色
```

**分配过程**：
```
优先级排序后：
  A(旧生) > B(新生) > C(新生)

分配顺序：
  1. A分配到旧生房B103-1
  2. B尝试分配到同一房间B103，容量足够 ✓
     B分配到B103-2（与A同房）
  3. C尝试分配到同一房间B103，已满 ⚠️
     系统尝试分配到相邻房间B104 ✓
     C分配到B104-1（与A、B靠近）
  4. 标记："A、B同房✓，C相邻房✓"
```

---

## 十五、管理人员确认问题

请禅修中心管理人员审阅上述规则，并回答以下问题：

### 15.1 基本规则确认

1. **学员分类规则**是否符合你们中心的实际情况？
   - [ ] 是（完全同意）
   - [ ] 基本同意，需要微调（请注明调整项）
   - [ ] 不同意（请说明原因）

   _微调意见：_________________

2. **优先级顺序**是否合理？（出家师 > 旧生 > 新生）
   - [ ] 是
   - [ ] 不是，应该为：_________________

3. **性别分离规则**是否适用？
   - [ ] 是（全部课程都是双性或需分离）
   - [ ] 否（全部课程都是单性别）
   - [ ] 视课程而定（某些课程需要分离）

### 15.2 特殊需求确认

4. **年龄分段定义**（18-30、30-40、40-55、60+）是否需要调整？
   - [ ] 无需调整
   - [ ] 需要调整，建议为：_________________

5. **老年学员处理**（60岁及以上自动进老人房）：
   - [ ] 同意
   - [ ] 建议改为：_________________

6. **同伴保护策略**（同伴优先同房，无法同房时标注警告）：
   - [ ] 完全同意
   - [ ] 需要加强同伴保护
   - [ ] 需要减弱同伴保护
   - 原因：_________________

### 15.3 房间配置确认

7. 贵中心目前有哪些房间类型？
   ```
   法师房：___间（楼号：___）
   旧生房：___间（楼号：___）
   新生房：___间（楼号：___）
   老人房：___间（楼号：___）
   其他：_________________
   ```

8. 双人房和单人房的比例？
   ```
   双人房（容量2）：___间
   单人房（容量1）：___间
   ```

### 15.4 禅堂配置确认

9. 贵中心的禅堂配置（若需要生成座位表）：
   ```
   禅堂区数量：[ ]A区 [ ]B区 [ ]C区
   
   A区配置：
     有效范围：______（如A5:E20）
     起始位置：______（如D5）
     最大行数：___  最大列数：___
     编号方式：[ ]顺序 [ ]奇数 [ ]偶数
   
   B区配置：
     有效范围：______
     起始位置：______
     最大行数：___  最大列数：___
     编号方式：[ ]顺序 [ ]奇数 [ ]偶数
   ```

### 15.5 新增确认项：课程性别类型和编号方式

11. **课程性别类型**：贵中心的课程属于哪种类型？
    - [ ] 全是男众课程（MALE_ONLY）
    - [ ] 全是女众课程（FEMALE_ONLY）
    - [ ] 混合课程（既有单性别，也有双性）- 需要支持所有三种类型

12. **编号方式**：禅堂座位号的编号方式如何确定？
    - [ ] 顺序编号（1,2,3...）- 用于单性别或单一禅堂
    - [ ] 奇数/偶数编号（1,3,5.../2,4,6...）- 用于双性课程区分男女
    - [ ] 其他方式：_________________

13. **学员编号重新分配**：座位确认时是否需要重新编号？
    - [ ] 是（确保座位号连续唯一）
    - [ ] 否（保持初始编号）

### 15.6 其他建议

10. 对算法还有其他建议或需要特殊处理的情况？
    ```
    _________________________________________________
    _________________________________________________
    _________________________________________________
    ```

---

## 十六、签名与确认

**中心名称**：__________________________
**管理人员**：__________________________
**审阅日期**：__________________________
**签署**：□ 同意所有规则
        □ 同意并有微调（见上述回答）
        □ 不同意，待讨论

**备注**：__________________________

---

## 附录：完整算法流程图

```
┌────────────────────────────────────────────┐
│   输入：学员数据、房间配置和禅堂配置      │
└────────┬─────────────────────────────────┘
         │
         ▼
┌────────────────────────────────────────────┐
│ 步骤0：课程基础验证 → 确定分配策略         │
│ ├─ 确定课程性别类型（男众/女众/双性）    │
│ ├─ 验证学员性别数据完整                  │
│ ├─ 确认禅堂配置和编号方式                │
│ └─ 根据课程类型选择分配路径              │
└────────┬─────────────────────────────────┘
         │
         ▼
┌────────────────────────────────────────────┐
│  步骤1-5：房间分配流程（按性别分流）     │
│  （同第三部分房间分配流程详述）          │
└────────┬─────────────────────────────────┘
         │
         ▼
┌────────────────────────────────────────────┐
│ 步骤6：禅堂座位生成 - 初始编号           │
│ ├─ 生成法师座位（独立编号）              │
│ ├─ 生成在家学员座位                      │
│ ├─ 应用编号方式                          │
│ │  ├─ 顺序：i=1,2,3...                   │
│ │  ├─ 奇数：i=1,3,5...                   │
│ │  └─ 偶数：i=2,4,6...                   │
│ └─ 生成禅堂过渡座位表                    │
└────────┬─────────────────────────────────┘
         │
         ▼
┌────────────────────────────────────────────┐
│ 步骤7：人工审核与调整                     │
│ ├─ 审核房间分配方案                      │
│ ├─ 解决冲突和特殊需求                    │
│ ├─ 审核禅堂座位布局                      │
│ └─ 可能进行座位交换、重新分配            │
└────────┬─────────────────────────────────┘
         │
         ▼
┌────────────────────────────────────────────┐
│ 步骤8：禅堂座位重新编号 - 最终确认       │
│ ├─ 遍历所有有效座位                      │
│ ├─ 跳过法师座位和空座位                  │
│ ├─ 重新计算编号（确保连续性）            │
│ └─ 根据编号方式重新赋值                  │
│    ├─ 顺序：1, 2, 3, 4, 5...            │
│    ├─ 奇数：1, 3, 5, 7, 9...            │
│    └─ 偶数：2, 4, 6, 8, 10...           │
└────────┬─────────────────────────────────┘
         │
         ▼
┌────────────────────────────────────────────┐
│ 步骤9：报表生成与导出                     │
│ ├─ 生成床位分配表（按性别、按楼号）     │
│ ├─ 生成禅堂座位表（按区域、按编号）     │
│ ├─ 生成供养表、座位指引等                │
│ └─ 导出为PDF/Excel                      │
└────────┬─────────────────────────────────┘
         │
         ▼
┌────────────────────────────────────────────┐
│ 步骤10：数据交付和存档                    │
│ ├─ 版本控制：保存分配方案版本            │
│ ├─ 备份：备份分配结果                    │
│ └─ 交付：将数据交付给其他系统            │
└────────────────────────────────────────────┘
```

---

**文档版本**：2.0（集成版 - 包含课程性别类型和学员编号重新分配）
**最后更新**：2025-11-06
**包含内容**：
- ✓ 14个核心算法规则章节
- ✓ 课程性别类型处理（新增）
- ✓ 学员编号重新分配（新增）
- ✓ 完整示例演练
- ✓ 16项管理人员确认问题（包括3项新增项）
- ✓ 完整算法流程图

**状态**：待禅修中心管理人员审阅和确认
