# 禅堂配置模板简化设计方案

## 版本信息
- **文档版本**: v2.0
- **更新日期**: 2025-11-22
- **状态**: 已实施

---

## 一、设计变更说明

### 1.1 变更背景
根据实际使用需求和用户反馈，原有的3个模板（A区女众、B区男众、混合园区）存在以下问题：
1. 单性课程不需要区分男女，增加了选择复杂度
2. 模板名称带有性别标识容易造成混淆
3. 用户核心关注点是"单性"还是"双性"课程

### 1.2 变更内容
**原有设计（3个模板）**：
- A区（女众独立园区）
- B区（男众独立园区）
- 混合园区（双性课程）

**新设计（2个模板）**：
- 单性课程模板
- 双性课程模板

---

## 二、新模板设计

### 2.1 单性课程模板

**ID**: `single-gender`

**名称**: 单性课程模板

**描述**: 适用于男众或女众单独上课，禅堂中仅一种性别，通常不超过100人

**特性**：
- 不区分男女，统一使用一个模板
- 座位编号：顺序编号（1, 2, 3, ...）
- 分区：旧生区（前2-3排）+ 新生区（其余排）
- 默认尺寸：12行 × 8列 = 96座
- 容量上限：100人

**适用场景**：
- 男众单独上课
- 女众单独上课
- 单性别禅修中心

**布局结构**：
```
┌──────────────────────────┐
│      旧生区 (2-3排)       │
├──────────────────────────┤
│                          │
│      新生区 (9-10排)     │
│                          │
└──────────────────────────┘
       老师法座
```

### 2.2 双性课程模板

**ID**: `co-ed`

**名称**: 双性课程模板

**描述**: 适用于男女众混合上课，禅堂包含男女两个独立区域，通常不超过150人

**特性**：
- 自动分为左右两个区域
- 座位编号：带前缀顺序编号（A1, A2, ... / B1, B2, ...）
  - A = 男众区
  - B = 女众区
- 分区：左侧女众区 + 右侧男众区（中间分割线）
- 默认尺寸：15行 × 10列 = 150座
- 容量上限：150人

**适用场景**：
- 男女混合上课
- 双性别禅修中心
- 需要性别隔离的场景

**布局结构**：
```
┌──────────┬─┬──────────┐
│          │ │          │
│  B区女众  │分│  A区男众  │
│          │割│          │
│  (左侧)  │线│  (右侧)  │
│          │ │          │
└──────────┴─┴──────────┘
       老师法座
```

---

## 三、智能配置生成

### 3.1 自动推荐逻辑

系统会根据学员数据和课程类型自动推荐合适的模板：

| 条件 | 推荐模板 |
|------|---------|
| 只有男众 | 单性课程模板 |
| 只有女众 | 单性课程模板 |
| 男女混合 + 课程类型=双性 | 双性课程模板 |
| 男女混合 + 课程类型=单性 | 双性课程模板（自动降级） |

### 3.2 单性课程自动配置

**输入**：
- 学员总数
- 旧生人数
- 新生人数

**输出**：
- 总行数：根据人数自动计算（10-20行）
- 总列数：默认8列
- 旧生区：前2-3排（占总人数20-30%）
- 新生区：其余排数

**示例**：
```
学员数：75人（15旧生 + 60新生）
↓
容量：86座（75 × 1.15 冗余）
↓
配置：11行 × 8列 = 88座
- 旧生区：前3排 × 8列 = 24座（15人）
- 新生区：后8排 × 8列 = 64座（60人）
```

### 3.3 双性课程自动配置

**输入**：
- 男众人数
- 女众人数

**输出**：
- 各区域独立计算行列数
- 使用较大的行数对齐（视觉统一）
- 列数根据人数比例分配

**示例**：
```
男众：22人 → A区：4行 × 6列 = 24座
女众：18人 → B区：4行 × 5列 = 20座
↓
最终配置：
- 总尺寸：4行 × 11列 = 44座
- B区（左）：4行 × 5列 = 20座
- A区（右）：4行 × 6列 = 24座
```

---

## 四、手动调整功能

### 4.1 单性课程调整

用户可以手动调整：
- **总行数**：5-20行
- **总列数**：4-12列

系统实时显示：
- 当前容量
- 报名人数
- 使用率
- 剩余座位

### 4.2 双性课程调整

用户可以独立调整每个区域：

**B区（女众）**：
- 行数：4-12行
- 列数：4-8列

**A区（男众）**：
- 行数：4-12行
- 列数：4-8列

**智能对齐**：
- 两个区域使用较大的行数（保证视觉对齐）
- 列数各自独立

**调整后操作**：
点击"重新生成预览"按钮，立即更新布局预览。

---

## 五、前端实现

### 5.1 模板定义

```typescript
// 文件：frontend-new/src/constants/hall-templates.ts

export type HallTemplateKey = 'single-gender' | 'co-ed'

export const HALL_TEMPLATES: HallTemplate[] = [
  {
    id: 'single-gender',
    name: '单性课程模板',
    description: '适用于男众或女众单独上课，禅堂中仅一种性别，通常不超过100人',
    templateType: '单性课程',
    genderType: 'SINGLE',
    // ... 配置详情
  },
  {
    id: 'co-ed',
    name: '双性课程模板',
    description: '适用于男女众混合上课，禅堂包含男女两个独立区域，通常不超过150人',
    templateType: '双性课程',
    genderType: 'CO_ED',
    // ... 配置详情
  },
]
```

### 5.2 页面流程

```
1. 显示学员概况
   ├─ 总人数、男众、女众
   └─ 课程类型（单性/双性）
   ↓
2. 选择模板（2个卡片）
   ├─ 单性课程模板
   └─ 双性课程模板
   ↓
3. 自动生成配置
   ├─ 根据学员数据
   ├─ 自动计算行列
   └─ 生成初始布局
   ↓
4. 手动调整（可选）
   ├─ 单性：调整总行列
   └─ 双性：调整各区域行列
   ↓
5. 预览布局
   ├─ 电影院风格展示
   ├─ 座位网格可视化
   └─ 显示容量统计
   ↓
6. 保存配置 / 生成座位
```

---

## 六、Bug 修复

### 6.1 数据不更新问题

**问题描述**：
调整区域行列数后，统计信息（容量、使用率）不更新。

**原因分析**：
统计信息使用 `currentLayout.sections` 中的数据，而用户修改的是状态变量 `femaleRows/femaleCols/maleRows/maleCols`。

**解决方案**：
直接使用状态变量计算统计信息，而不依赖 `currentLayout`。

```typescript
// 错误示例
<Statistic 
  value={(femaleSection.rowEnd - femaleSection.rowStart) * femaleCols} 
/>

// 正确示例
<Statistic 
  value={Math.max(femaleRows, maleRows) * femaleCols} 
/>
```

### 6.2 预览座位数不符

**问题描述**：
预览中显示的座位数量与配置的行列数不一致。

**原因分析**：
`createSeatGrid` 使用 `maxRow` 和 `maxCol`（座位最大坐标），而不是实际的行列数。

**解决方案**：
使用 `section.rowEnd - section.rowStart` 计算实际行列数。

```typescript
// 错误示例
const rows = region.maxRow + 1

// 正确示例
const rows = section.rowEnd - section.rowStart
const cols = section.colEnd - section.colStart
```

---

## 七、测试场景

### 7.1 单性课程场景

**测试数据**：
- 75位女众（15旧生 + 60新生）

**预期结果**：
1. 系统推荐"单性课程模板"
2. 自动生成：11行 × 8列 = 88座
3. 旧生区：前3排 = 24座
4. 新生区：后8排 = 64座
5. 使用率：85%

### 7.2 双性课程场景

**测试数据**：
- 22位男众
- 18位女众

**预期结果**：
1. 系统推荐"双性课程模板"
2. B区（女众）：4行 × 5列 = 20座
3. A区（男众）：4行 × 6列 = 24座
4. 总容量：44座
5. 使用率：91%

### 7.3 手动调整场景

**操作步骤**：
1. 选择双性课程模板
2. 修改女众区：5行 × 6列
3. 修改男众区：5行 × 6列
4. 点击"重新生成预览"

**预期结果**：
1. 女众区容量更新为30座
2. 男众区容量更新为30座
3. 总容量更新为60座
4. 使用率更新为67%
5. 预览中显示新的布局

---

## 八、后续工作

### 8.1 前端完成项 ✅

- [x] 简化模板为2个
- [x] 更新模板文案和描述
- [x] 实现单性/双性自动配置
- [x] 实现手动调整功能
- [x] 修复数据不更新bug
- [x] 修复预览座位数bug
- [x] 优化布局居中对齐
- [x] 更新文档

### 8.2 后端待完成项 ⏳

- [ ] 更新后端API - 支持新的模板ID
- [ ] 更新编号逻辑 - 实现A/B前缀顺序编号
- [ ] 更新数据库 - 模板配置迁移
- [ ] API测试 - 验证新模板配置

---

## 九、文件清单

### 9.1 核心文件

| 文件路径 | 说明 |
|---------|------|
| `frontend-new/src/constants/hall-templates.ts` | 模板定义 |
| `frontend-new/src/utils/hall-auto-config.ts` | 自动配置逻辑 |
| `frontend-new/src/components/meditation/MeditationSeatsPage.tsx` | 主页面 |
| `frontend-new/src/components/meditation/TemplateSelector.tsx` | 模板选择器 |
| `frontend-new/src/components/meditation/LayoutPreviewCanvas.tsx` | 布局预览 |

### 9.2 文档文件

| 文件路径 | 说明 |
|---------|------|
| `禅堂配置模板简化设计方案.md` | 本文档 |
| `frontend-new/.claude/CLAUDE.md` | 前端开发规范 |

---

## 十、总结

通过本次简化设计：

1. **降低复杂度**：从3个模板减少到2个，用户选择更清晰
2. **提升易用性**：去除性别标识，聚焦课程类型
3. **智能自动化**：根据学员数据自动生成配置
4. **灵活可调**：支持手动精细调整
5. **实时反馈**：修改后立即显示统计和预览

符合"系统内置模板 + 简单调整"的设计理念，大幅提升了非技术用户的使用体验。

