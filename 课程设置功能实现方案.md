# 课程设置功能实现方案

**版本**: 1.0
**日期**: 2025-11-06
**基于**: base-info.png 配置表分析
**目的**: 实现完整的课程设置管理，支持学员导入防重复

---

## 一、需求分析

### 1.1 基本信息配置（来自 base-info.png）

从 Excel 配置表中识别的所有配置项：

#### **第一部分：基本课程设置**

| 配置项 | 字段名 | 数据类型 | 说明 | 示例 |
|--------|--------|---------|------|------|
| 课程类型 | course_type | VARCHAR(20) | 十日课、20日课、30日课等 | 十日课程 |
| 课程日期 | course_date | DATE | 课程开始日期 | 2025-10-16 |
| 课程地点 | location | VARCHAR(100) | 课程举办地点 | 郑州县钟中心 |
| 老师1姓名 | teacher1_name | VARCHAR(50) | 主讲师 | 范世再 |
| 老师2姓名 | teacher2_name | VARCHAR(50) | 副讲师 | 范世再 |

#### **第二部分：禅堂设置**

| 配置项 | 字段名 | 数据类型 | 说明 | 示例 |
|--------|--------|---------|------|------|
| 禅堂A区宽度 | meditation_hall_a_width | INT | A区列数 | 4 |
| 禅堂A区行 | meditation_hall_a_rows | VARCHAR(20) | A区行数（"自动" 或具体数字） | 自动 |
| 禅堂B区宽度 | meditation_hall_b_width | INT | B区列数 | 10 |
| 禅堂B区行 | meditation_hall_b_rows | VARCHAR(20) | B区行数（"自动" 或具体数字） | 自动 |

#### **第三部分：课程性别和分配方式**

| 配置项 | 字段名 | 数据类型 | 说明 | 示例 |
|--------|--------|---------|------|------|
| 课程性别 | course_gender_type | VARCHAR(20) | MALE_ONLY/FEMALE_ONLY/CO_ED | 双性 |
| 资居使用 | room_building_usage | VARCHAR(50) | 房间使用方式 | AB楼都用 |
| 禅堂使用 | meditation_hall_usage | VARCHAR(50) | 禅堂座位表生成方式 | 独立表 |
| 禅堂编号方式 | seat_numbering_type | VARCHAR(50) | 顺序/奇数/偶数/AB编号 | AB编号 |

#### **第四部分：其他设置**

| 配置项 | 字段名 | 数据类型 | 说明 | 示例 |
|--------|--------|---------|------|------|
| 大龄阈值 | elderly_age_threshold | INT | 超过此年龄标记为老年学员 | 60 |

### 1.2 防重复导入需求

**问题**: 每期课程学员导入时，需要防止重复导入同一批学员

**解决方案**:
1. 为每个 Session（课程期次）添加唯一标识符
2. 导入时检查学员是否已存在于该课程中
3. 支持更新或跳过重复学员

---

## 二、数据库设计

### 2.1 Session 表扩展

在现有 Session 表上添加以下字段：

```sql
-- 基本课程设置
ALTER TABLE session ADD COLUMN `course_date` DATE COMMENT '课程开始日期';
ALTER TABLE session ADD COLUMN `location` VARCHAR(100) COMMENT '课程地点';
ALTER TABLE session ADD COLUMN `teacher1_name` VARCHAR(50) COMMENT '老师1姓名';
ALTER TABLE session ADD COLUMN `teacher2_name` VARCHAR(50) COMMENT '老师2姓名';

-- 禅堂配置
ALTER TABLE session ADD COLUMN `meditation_hall_a_width` INT DEFAULT 4
  COMMENT '禅堂A区宽度（列数）';
ALTER TABLE session ADD COLUMN `meditation_hall_a_rows` VARCHAR(20) DEFAULT 'auto'
  COMMENT '禅堂A区行数（"auto"或具体数字）';
ALTER TABLE session ADD COLUMN `meditation_hall_b_width` INT DEFAULT 10
  COMMENT '禅堂B区宽度（列数）';
ALTER TABLE session ADD COLUMN `meditation_hall_b_rows` VARCHAR(20) DEFAULT 'auto'
  COMMENT '禅堂B区行数（"auto"或具体数字）';

-- 课程性别和分配方式
ALTER TABLE session ADD COLUMN `course_gender_type` VARCHAR(20) DEFAULT 'CO_ED'
  COMMENT '课程性别类型：MALE_ONLY=男众, FEMALE_ONLY=女众, CO_ED=双性';
ALTER TABLE session ADD COLUMN `room_building_usage` VARCHAR(50) DEFAULT 'AB_BOTH'
  COMMENT '房间使用方式：A_ONLY=A楼, B_ONLY=B楼, AB_BOTH=A楼B楼';
ALTER TABLE session ADD COLUMN `meditation_hall_usage` VARCHAR(50) DEFAULT 'SEPARATE'
  COMMENT '禅堂座位表：SEPARATE=独立表, COMBINED=合并表';
ALTER TABLE session ADD COLUMN `seat_numbering_type` VARCHAR(50) DEFAULT 'SEQUENTIAL'
  COMMENT '座位编号方式：SEQUENTIAL=顺序, ODD=奇数, EVEN=偶数, AB=AB编号';

-- 其他设置
ALTER TABLE session ADD COLUMN `elderly_age_threshold` INT DEFAULT 60
  COMMENT '大龄阈值：超过此年龄标记为老年学员';

-- 导入状态和防重复
ALTER TABLE session ADD COLUMN `import_hash` VARCHAR(64) UNIQUE
  COMMENT '导入数据的哈希值，用于防重复';
ALTER TABLE session ADD COLUMN `last_import_time` TIMESTAMP
  COMMENT '最后一次导入时间';
ALTER TABLE session ADD COLUMN `total_imported_students` INT DEFAULT 0
  COMMENT '已导入学员总数';
```

### 2.2 Student 表导入状态添加

```sql
-- 学员导入跟踪
ALTER TABLE student ADD COLUMN `import_id` VARCHAR(64)
  COMMENT '导入批次ID，用于跟踪同批次导入的学员';
ALTER TABLE student ADD COLUMN `import_time` TIMESTAMP DEFAULT CURRENT_TIMESTAMP
  COMMENT '导入时间';
ALTER TABLE student ADD COLUMN `is_duplicate` BOOLEAN DEFAULT FALSE
  COMMENT '是否为重复导入的学员';
ALTER TABLE student ADD COLUMN `original_student_id` BIGINT
  COMMENT '如果是重复，指向原始学员ID';

-- 创建联合索引
CREATE UNIQUE INDEX idx_session_student_number
ON student(session_id, student_number);
```

### 2.3 新增表：课程设置历史记录表（可选）

```sql
CREATE TABLE session_config_history (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    session_id BIGINT NOT NULL,
    config_key VARCHAR(50) NOT NULL COMMENT '配置项键名',
    old_value VARCHAR(255) COMMENT '旧值',
    new_value VARCHAR(255) COMMENT '新值',
    changed_by VARCHAR(50) COMMENT '修改人',
    changed_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (session_id) REFERENCES session(id),
    INDEX idx_session_id (session_id),
    INDEX idx_changed_at (changed_at)
) COMMENT='课程设置修改历史记录';
```

---

## 三、防重复导入机制

### 3.1 导入流程

```
┌─────────────────────────────────┐
│   用户上传学员数据文件            │
│  （Excel 或 CSV）                 │
└────────────┬──────────────────────┘
             │
             ▼
┌─────────────────────────────────┐
│ 步骤1：生成导入批次ID            │
│  import_id = UUID()              │
└────────────┬──────────────────────┘
             │
             ▼
┌─────────────────────────────────┐
│ 步骤2：解析文件获取学员数据       │
│  解析学号、姓名、性别、年龄等    │
└────────────┬──────────────────────┘
             │
             ▼
┌─────────────────────────────────┐
│ 步骤3：检查重复                  │
│  FOR 每个学员:                    │
│    IF EXISTS (same session_id     │
│       AND student_number)         │
│      THEN 标记为重复              │
│    END IF                         │
└────────────┬──────────────────────┘
             │
             ▼
┌─────────────────────────────────┐
│ 步骤4：显示重复预览              │
│  展示将被导入、重复、跳过的学员  │
└────────────┬──────────────────────┘
             │
             ▼
┌─────────────────────────────────┐
│ 步骤5：用户确认导入方式          │
│  □ 跳过重复（推荐）              │
│  □ 更新重复学员                  │
│  □ 导入全部（包括重复）          │
└────────────┬──────────────────────┘
             │
             ▼
┌─────────────────────────────────┐
│ 步骤6：执行导入                  │
│  保存学员数据，记录导入信息      │
└────────────┬──────────────────────┘
             │
             ▼
┌─────────────────────────────────┐
│ 步骤7：显示导入结果              │
│  新增：X人，重复：Y人，跳过：Z人 │
└─────────────────────────────────┘
```

### 3.2 重复检测算法

```java
// 伪代码
Function DetectDuplicates(
    sessionId: Long,
    newStudents: List<Student>,
    importId: String
) -> DuplicateReport {

    duplicates = new List<Student>
    newRecords = new List<Student>

    // 获取该课程已有学员
    existingStudents = DB.query(
        "SELECT student_number FROM student
         WHERE session_id = ? AND is_duplicate = FALSE",
        sessionId
    )
    existingNumbers = Convert.toSet(existingStudents.student_number)

    FOR each student in newStudents {
        IF existingNumbers.contains(student.student_number) {
            student.is_duplicate = TRUE
            student.import_id = importId
            duplicates.add(student)
        } ELSE {
            student.is_duplicate = FALSE
            student.import_id = importId
            newRecords.add(student)
        }
    }

    RETURN DuplicateReport {
        newCount: newRecords.size(),
        duplicateCount: duplicates.size(),
        newRecords: newRecords,
        duplicates: duplicates
    }
}
```

### 3.3 导入模式

| 模式 | 说明 | 使用场景 |
|------|------|----------|
| **SKIP** | 跳过重复学员，仅导入新学员 | 常规使用（推荐） |
| **UPDATE** | 更新重复学员的信息 | 学员信息修正 |
| **APPEND** | 导入全部学员（包括重复） | 需要重新注册 |

---

## 四、后端 API 设计

### 4.1 课程设置管理 API

#### **创建/更新课程设置**

```
POST /api/sessions/{sessionId}/config

请求体:
{
  "course_date": "2025-10-16",
  "location": "郑州县钟中心",
  "teacher1_name": "范世再",
  "teacher2_name": "范世再",
  "meditation_hall_a_width": 4,
  "meditation_hall_a_rows": "auto",
  "meditation_hall_b_width": 10,
  "meditation_hall_b_rows": "auto",
  "course_gender_type": "CO_ED",
  "room_building_usage": "AB_BOTH",
  "meditation_hall_usage": "SEPARATE",
  "seat_numbering_type": "AB",
  "elderly_age_threshold": 60
}

响应:
{
  "code": 0,
  "message": "课程设置保存成功",
  "data": {
    "session_id": 1,
    "config": { ... }
  }
}
```

#### **获取课程设置**

```
GET /api/sessions/{sessionId}/config

响应:
{
  "code": 0,
  "data": {
    "session_id": 1,
    "course_type": "十日课程",
    "course_date": "2025-10-16",
    "location": "郑州县钟中心",
    ...
  }
}
```

#### **获取设置历史**

```
GET /api/sessions/{sessionId}/config/history

响应:
{
  "code": 0,
  "data": [
    {
      "config_key": "course_gender_type",
      "old_value": "MALE_ONLY",
      "new_value": "CO_ED",
      "changed_by": "admin",
      "changed_at": "2025-11-06 10:30:00"
    },
    ...
  ]
}
```

### 4.2 学员导入 API

#### **预检查（检查重复）**

```
POST /api/students/import/preview

请求体:
{
  "session_id": 1,
  "file_content": "..." // Base64 编码的 Excel 内容
}

响应:
{
  "code": 0,
  "data": {
    "import_id": "uuid-string",
    "total_records": 150,
    "new_count": 140,
    "duplicate_count": 10,
    "duplicates": [
      {
        "student_number": "001",
        "name": "张三",
        "gender": "M",
        "existing_import_time": "2025-10-20 14:30:00"
      },
      ...
    ],
    "preview_mode": "SKIP" // 默认推荐模式
  }
}
```

#### **执行导入**

```
POST /api/students/import

请求体:
{
  "session_id": 1,
  "import_id": "uuid-string",
  "import_mode": "SKIP", // SKIP | UPDATE | APPEND
  "students": [
    {
      "student_number": "001",
      "name": "张三",
      "id_card": "123456789",
      "gender": "M",
      "age": 35,
      "phone": "13800138000",
      "study_times": 0,
      "fellows": "李四,王五" // 同伴
    },
    ...
  ]
}

响应:
{
  "code": 0,
  "message": "导入成功",
  "data": {
    "import_id": "uuid-string",
    "session_id": 1,
    "new_imported": 140,
    "updated": 0,
    "skipped": 10,
    "failed": 0,
    "total_time_ms": 2500,
    "details": {
      "imported_student_ids": [1, 2, 3, ...],
      "skipped_students": [
        {
          "student_number": "001",
          "name": "张三",
          "reason": "duplicate_number"
        }
      ]
    }
  }
}
```

#### **获取导入历史**

```
GET /api/sessions/{sessionId}/students/import-history

响应:
{
  "code": 0,
  "data": [
    {
      "import_id": "uuid-1",
      "import_time": "2025-10-16 09:00:00",
      "total_imported": 140,
      "duplicates_skipped": 10,
      "duplicates_updated": 0,
      "import_mode": "SKIP",
      "imported_by": "admin"
    },
    ...
  ]
}
```

---

## 五、前端界面设计

### 5.1 课程设置页面布局

**页面路径**: `/sessions/{sessionId}/config`

```
┌─────────────────────────────────────────────┐
│  课程设置：[课程名] - 2025年10月           │
├─────────────────────────────────────────────┤
│                                             │
│ 📋 基本课程设置 ━━━━━━━━━━━━━━━━━━━━━  │
│                                             │
│  课程类型：[十日课程        ]             │
│  课程日期：[2025-10-16  ▼]               │
│  课程地点：[郑州县钟中心      ]           │
│  老师1：[范世再          ]               │
│  老师2：[范世再          ]               │
│                                             │
├─────────────────────────────────────────────┤
│                                             │
│ 🏛️  禅堂配置 ━━━━━━━━━━━━━━━━━━━━━━  │
│                                             │
│  A区宽度：[4  ]列  A区行：[自动 ▼]    │
│  B区宽度：[10 ]列  B区行：[自动 ▼]    │
│                                             │
├─────────────────────────────────────────────┤
│                                             │
│ 👥 课程性别和分配方式 ━━━━━━━━━━━━  │
│                                             │
│  课程性别：[● 双性  ○ 男众  ○ 女众]   │
│  资居使用：[● AB楼都用  ○ A楼  ○ B楼] │
│  禅堂座位：[● 独立表  ○ 合并表]       │
│  编号方式：[● AB编号  ○ 顺序  ○ 奇数] │
│                                             │
├─────────────────────────────────────────────┤
│                                             │
│ ⚙️  其他设置 ━━━━━━━━━━━━━━━━━━━━ │
│                                             │
│  大龄阈值：[60]岁（超过此年龄标记为老年）  │
│                                             │
├─────────────────────────────────────────────┤
│                                             │
│  [保存设置] [取消] [查看历史]              │
│                                             │
└─────────────────────────────────────────────┘
```

### 5.2 学员导入页面布局

**页面路径**: `/sessions/{sessionId}/students/import`

```
┌─────────────────────────────────────────────┐
│  学员导入：[课程名]                        │
├─────────────────────────────────────────────┤
│                                             │
│ 第一步：选择文件                            │
│ ┌───────────────────────────────────────┐ │
│ │ 拖拽文件到此  或  [选择 Excel/CSV]   │ │
│ │ 支持格式：.xlsx, .xls, .csv           │ │
│ └───────────────────────────────────────┘ │
│                                             │
│ 第二步：预检查（检查重复）                │
│ ┌───────────────────────────────────────┐ │
│ │ ⏳ 正在扫描文件...                   │ │
│ └───────────────────────────────────────┘ │
│                                             │
│ 第三步：选择导入模式                      │
│ ┌───────────────────────────────────────┐ │
│ │ ⓘ 文件包含 150 条学员记录             │ │
│ │   • 新增学员：140 人                  │ │
│ │   • 重复学员：10 人 (已在本课程中)   │ │
│ │   • 导入失败：0 人                    │ │
│ │                                       │ │
│ │ 导入方式（如何处理重复）：              │ │
│ │ [✓] 跳过重复 (SKIP) ← 推荐            │ │
│ │     仅导入 140 个新学员               │ │
│ │                                       │ │
│ │ [ ] 更新重复 (UPDATE)                 │ │
│ │     用新文件中的数据更新已有学员       │ │
│ │                                       │ │
│ │ [ ] 导入全部 (APPEND)                 │ │
│ │     导入所有 150 个学员（可能有重复） │ │
│ └───────────────────────────────────────┘ │
│                                             │
│ 第四步：查看重复学员列表                  │
│ ┌───────────────────────────────────────┐ │
│ │ 将被跳过的重复学员：(10 人)            │ │
│ │                                       │ │
│ │ 学号 │ 姓名 │ 性别 │ 首次导入时间    │ │
│ │─────┼────┼────┼────────────────   │ │
│ │ 001 │张三│ M  │2025-10-20 14:30   │ │
│ │ 002 │李四│ F  │2025-10-20 14:30   │ │
│ │ ... │    │    │                    │ │
│ │                                       │ │
│ │ [展开详情] [导出为 CSV]                │ │
│ └───────────────────────────────────────┘ │
│                                             │
│ 第五步：确认导入                          │
│ ┌───────────────────────────────────────┐ │
│ │ ⚠️ 重要提示：                         │ │
│ │ 请仔细检查导入模式设置。导入后可通过  │ │
│ │ "导入历史"查看和恢复。               │ │
│ │                                       │ │
│ │ [开始导入] [取消]                     │ │
│ └───────────────────────────────────────┘ │
│                                             │
├─────────────────────────────────────────────┤
│ 📋 最近导入历史                            │
│ ┌───────────────────────────────────────┐ │
│ │ 导入时间  │ 新增 │ 重复 │ 模式 │ 操作 │ │
│ │───────────┼──────┼──────┼──────┼────── │ │
│ │2025-11-06│ 140  │ 10   │SKIP │查看  │ │
│ │10:30:00  │      │      │     │恢复  │ │
│ │───────────┼──────┼──────┼──────┼────── │ │
│ │2025-10-20│ 150  │  0   │--  │查看  │ │
│ │14:30:00  │      │      │     │导出  │ │
│ │                                       │ │
│ │ [刷新] [导出全部] [清空历史]           │ │
│ └───────────────────────────────────────┘ │
│                                             │
└─────────────────────────────────────────────┘
```

### 5.3 页面切换关系

```
课程列表
   ↓
选择课程
   ↓
┌──────────────────┐
│  课程详情页      │
├──────────────────┤
│ [课程设置]   ← → 【课程设置页面】
│ [学员管理]   ← → 【学员导入页面】
│ [房间分配]   ← → 【房间分配页面】
│ [禅堂座位]   ← → 【座位生成页面】
└──────────────────┘
```

---

## 六、实现优先级

### 🔴 **必须实现**（第一阶段）

1. **数据库 Schema 更新**
   - Session 表扩展（所有配置字段）
   - Student 表导入跟踪字段
   - 创建联合唯一索引

2. **后端 API**
   - 课程设置的 CRUD API
   - 学员导入预检查 API（防重复检测）
   - 导入执行 API

3. **防重复导入机制**
   - 重复检测算法
   - 三种导入模式（SKIP/UPDATE/APPEND）

### 🟡 **应该实现**（第二阶段）

4. **课程设置前端页面**
   - 配置表单
   - 表单验证
   - 保存和预览

5. **学员导入前端页面**
   - 文件上传（拖拽上传）
   - 预检查预览
   - 导入进度显示

6. **导入历史查看**
   - 导入历史列表
   - 导入详情查看
   - 导入结果导出

### 🟢 **可选实现**（第三阶段）

7. **课程设置历史记录**
   - 记录所有配置修改
   - 提供配置对比和恢复

8. **高级导入功能**
   - 字段映射（自定义 Excel 列对应）
   - 数据验证规则
   - 导入模板下载

---

## 七、配置值参考

### 7.1 课程性别类型（course_gender_type）

```
MALE_ONLY    = "男众"      - 仅男学员
FEMALE_ONLY  = "女众"      - 仅女学员
CO_ED        = "双性"      - 混合课程（推荐）
```

### 7.2 房间使用方式（room_building_usage）

```
A_ONLY       = "A楼"       - 仅使用A楼
B_ONLY       = "B楼"       - 仅使用B楼
AB_BOTH      = "AB楼都用"  - 使用A楼和B楼（推荐）
```

### 7.3 禅堂座位方式（meditation_hall_usage）

```
SEPARATE     = "独立表"    - 生成两张座位表（男众/女众分别）
COMBINED     = "合并表"    - 生成一张座位表（所有学员）
```

### 7.4 座位编号方式（seat_numbering_type）

```
SEQUENTIAL   = "顺序"      - 顺序编号：1,2,3,4...
ODD          = "奇数"      - 奇数编号：1,3,5,7...
EVEN         = "偶数"      - 偶数编号：2,4,6,8...
AB           = "AB编号"    - A区奇数、B区偶数（推荐双性课程）
```

---

## 八、关键注意事项

### 8.1 数据完整性

- 导入学员前必须先配置课程设置
- 课程设置中的禅堂配置影响后续座位生成
- 课程性别类型决定房间分配策略

### 8.2 防重复导入

- 使用 `session_id + student_number` 的组合唯一性
- 每次导入前都应执行预检查
- 推荐使用 SKIP 模式以防止意外覆盖

### 8.3 数据恢复

- 保留导入历史，支持查询历史导入数据
- UPDATE 模式会修改已有学员数据，需谨慎
- APPEND 模式可能产生大量重复，仅在特殊情况使用

---

## 九、测试用例

### 9.1 正常流程

1. 创建新课程 → 配置设置 → 导入学员 → 生成分配
2. 同一课程追加导入 → 系统检测重复 → 选择跳过模式 → 仅导入新学员

### 9.2 异常处理

1. 导入空文件 → 提示"文件为空"
2. 格式错误 → 提示"不支持的文件格式"
3. 缺少必填字段 → 显示缺少字段列表，无法导入
4. 导入中断 → 支持重新导入或恢复

---

**文档完成日期**：2025-11-06
**状态**：待实现
**下一步**：开始数据库 Schema 更新和后端 API 实现

